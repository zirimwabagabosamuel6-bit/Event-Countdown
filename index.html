<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Maxwell Events — 2025–2026</title>
    <style>
      :root {
        --accent: #ffd24a;
        --accent-text: #072238;
        --bg-dark: #041018;
        --muted: #072238;
        --panel-width: 360px;
        --card-radius: 12px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          Roboto, Arial;
        color: #eaf6ff;
        background: linear-gradient(180deg, var(--bg-dark) 0%, #07131a 80%);
      }
      a {
        color: inherit;
        text-decoration: none;
      }

      /* HERO */
      .hero {
        position: relative;
        max-width: 1200px;
        margin: 18px auto;
        height: 380px;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      }
      .hero img {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        object-position: center top;
        transition: transform 0.6s ease;
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 36%,
          rgba(0, 0, 0, 0.82) 100%
        );
        pointer-events: none;
      }
      .hero-header {
        position: absolute;
        left: 22px;
        right: 22px;
        bottom: 18px;
        z-index: 3;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .hero-left {
        color: #fff;
      }
      .hero-title {
        font-weight: 900;
        font-size: 1.6rem;
        letter-spacing: 0.2px;
        text-shadow: 0 8px 26px rgba(0, 0, 0, 0.35);
      }
      .hero-sub {
        opacity: 0.95;
        margin-top: 6px;
        font-weight: 700;
      }

      /* top controls */
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      input[type="search"],
      select {
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        min-width: 160px;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #ffb84d);
        color: var(--accent-text);
        border: none;
      }
      .mode-btn {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-weight: 800;
      }
      .mode-btn.active {
        background: linear-gradient(90deg, var(--accent), #ffb84d);
        color: var(--accent-text);
        box-shadow: 0 14px 40px rgba(255, 180, 40, 0.12);
        transform: translateY(-3px);
      }

      /* month buttons */
      .month-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .month-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
      }
      .month-btn.active {
        background: linear-gradient(90deg, var(--accent), #ffb84d);
        color: var(--accent-text);
      }
      .month-btn.current {
        box-shadow: 0 8px 30px rgba(255, 180, 40, 0.07);
        border-color: rgba(255, 180, 40, 0.25);
      }

      /* layout */
      .wrap {
        max-width: 1200px;
        margin: 18px auto 120px;
        padding: 0 12px;
      }
      .top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 12px;
      }
      h1#pageTitle {
        font-size: 1.35rem;
        color: #fff;
      }
      #subtitle {
        color: rgba(255, 255, 255, 0.92);
        margin-top: 6px;
        font-weight: 600;
      }

      /* year progress */
      .year-progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 999px;
        overflow: hidden;
        margin: 12px 0;
      }
      .year-progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), #ffb84d);
      }

      /* grid */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }
      .month-heading {
        grid-column: 1/-1;
        padding: 8px 0;
        font-weight: 900;
        color: #fff;
        opacity: 0.95;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      /* card */
      .card {
        position: relative;
        border-radius: var(--card-radius);
        background: linear-gradient(180deg, #ffffff, #fafafa);
        padding: 16px;
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 170px;
        transition: transform 0.18s, box-shadow 0.18s;
      }
      .month-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: var(--card-radius);
        border-bottom-left-radius: var(--card-radius);
      }
      .pin-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: rgba(7, 18, 43, 0.04);
        cursor: pointer;
      }
      .pin-btn.active {
        background: linear-gradient(90deg, #ffd24a, #ffecb5);
      }
      .card-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .title {
        min-height: 48px;
      }
      .fill {
        display: inline-block;
        background-clip: text;
        color: transparent;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        font-size: 18px;
      }
      .fallback {
        font-weight: 800;
        font-size: 18px;
        color: #072238;
      }
      .meta {
        font-size: 13px;
        color: #27506b;
        min-height: 18px;
      }
      .countdown {
        font-weight: 800;
        font-size: 15px;
        color: var(--accent);
        min-height: 22px;
      }
      .status {
        font-size: 13px;
        color: #16344f;
        font-weight: 600;
        min-height: 20px;
      }
      .date-badge {
        align-self: flex-start;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(7, 18, 43, 0.04);
        font-weight: 800;
      }
      .big-letter {
        position: absolute;
        right: -12px;
        top: -18px;
        font-weight: 800;
        font-size: 64px;
        color: rgba(7, 18, 43, 0.06);
        pointer-events: none;
      }

      .card.finished {
        opacity: 0.66;
        filter: grayscale(40%);
      }
      .card.happening {
        box-shadow: 0 20px 60px rgba(255, 90, 70, 0.1);
        animation: glow 2.6s infinite;
      }
      @keyframes glow {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-4px);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* gallery / museum (square) */
      .gallery-wrap {
        max-width: 1200px;
        margin: 18px auto;
        padding: 0 12px;
      }
      .gallery-month {
        margin-bottom: 18px;
      }
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }
      .gallery-thumb {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        background: #ddd;
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .gallery-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .gallery-caption {
        position: absolute;
        left: 8px;
        bottom: 8px;
        padding: 6px 8px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        border-radius: 6px;
        font-size: 12px;
      }

      /* lightbox */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .lightbox.open {
        display: flex;
      }
      .lightbox img {
        max-width: 92%;
        max-height: 82%;
        object-fit: contain;
        border-radius: 8px;
      }
      .lightbox .caption {
        color: #fff;
        margin-top: 12px;
        font-weight: 700;
      }
      .lightbox .controls {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
      }
      .lightbox button {
        background: rgba(255, 255, 255, 0.06);
        border: none;
        color: #fff;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
      }

      /* pinned panel */
      .pinned-column {
        position: fixed;
        right: 18px;
        top: 110px;
        width: var(--panel-width);
        max-height: calc(100vh - 140px);
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        z-index: 999;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(2, 8, 23, 0.18);
        transform: translateX(0);
        transition: transform 0.35s, opacity 0.35s;
      }
      .pinned-column.hidden {
        transform: translateX(20px);
        opacity: 0;
        pointer-events: none;
      }
      .pinned-column .panel-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .pinned-chip {
        background: #fff;
        padding: 10px;
        border-radius: 10px;
        min-width: 200px;
        border: 1px solid rgba(2, 8, 23, 0.04);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .pinned-row-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .clear-btn {
        background: #ffecb5;
        border: none;
        padding: 6px 8px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
      }
      #pinnedToggleBtn {
        position: fixed;
        right: 18px;
        top: 60%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(180deg, var(--accent), #ffecb5);
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.16);
        cursor: pointer;
        font-weight: 900;
      }
      #pinnedToggleBtn.hidden {
        display: none;
      }

      /* birthdays section */
      .birthdays-wrap {
        max-width: 1200px;
        margin: 18px auto;
        padding: 0 12px;
      }
      .birth-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .birth-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
      }
      .bd-card {
        background: linear-gradient(180deg, #fff, #fafafa);
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.08);
        color: #072238;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      .bd-name {
        font-weight: 900;
      }
      .bd-date {
        font-weight: 700;
        color: #27506b;
      }
      .bd-count {
        font-weight: 800;
        color: var(--accent);
      }

      /* birthday announcement popup (centered) */
      .bd-popup-wrap {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        pointer-events: none;
      }
      .bd-popup {
        min-width: 320px;
        max-width: 80%;
        padding: 18px 22px;
        border-radius: 12px;
        background: #ffffff;
        color: #072238;
        text-align: center;
        box-shadow: 0 24px 70px rgba(0, 0, 0, 0.45);
        transform-origin: center;
        pointer-events: auto;
        opacity: 0;
        transform: scale(0.98);
      }
      .bd-popup.show {
        opacity: 1;
        transform: scale(1);
        transition: transform 0.28s ease, opacity 0.28s ease;
      }
      .bd-popup h2 {
        font-size: 1.5rem;
        margin-bottom: 6px;
      }
      .bd-popup p {
        opacity: 0.9;
      }
      .bd-popup.shake {
        animation: shake 0.9s ease;
      }
      @keyframes shake {
        0% {
          transform: translateY(0);
        }
        20% {
          transform: translateY(-6px) rotate(-1.2deg);
        }
        40% {
          transform: translateY(3px) rotate(0.8deg);
        }
        60% {
          transform: translateY(-2px) rotate(-0.6deg);
        }
        80% {
          transform: translateY(1px) rotate(0.2deg);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* confetti canvas overlay inside popup */
      .bd-confetti-canvas {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 2999;
      }

      /* present mode */
      .present-mode header,
      .present-mode .controls,
      .present-mode .month-buttons,
      .present-mode #subtitle,
      .present-mode #nextUp {
        display: none !important;
      }
      .present-mode .wrap {
        margin-top: 10px;
      }
      .present-card {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px;
        border-radius: 18px;
        background: linear-gradient(180deg, #fff, #fcfcfd);
        color: #072238;
        font-weight: 900;
        font-size: 2.2rem;
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.4);
      }

      /* responsiveness */
      @media (max-width: 900px) {
        .pinned-column {
          right: 12px;
          left: 12px;
          bottom: 18px;
          top: auto;
          display: flex;
          flex-direction: row;
          max-height: 120px;
          padding: 8px;
          overflow: auto;
        }
        #pinnedToggleBtn {
          display: none;
        }
        .hero {
          height: 260px;
        }
        .big-letter {
          font-size: 48px;
        }
        .gallery-grid {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
        .bd-popup {
          min-width: 260px;
        }
      }

      /* accessibility focus */
      :focus {
        outline: 3px solid rgba(255, 255, 255, 0.06);
        outline-offset: 3px;
      }
    </style>
  </head>
  <body>
    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <img
        id="heroImg"
        alt="Maxwell banner"
        src="https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1"
        crossorigin="anonymous"
      />
      <div class="hero-header">
        <div class="hero-left">
          <div class="hero-title">Maxwell Events Countdown</div>
          <div class="hero-sub" id="heroSubtitle">2025-2026 schedule</div>

          <div
            class="controls"
            role="region"
            aria-label="Search and filters"
            style="margin-top: 12px"
          >
            <input
              id="searchBox"
              type="search"
              placeholder="Search events..."
              aria-label="Search events"
            />
            <select id="monthFilter" aria-label="Filter by month">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>

            <div
              id="monthButtons"
              class="month-buttons"
              aria-hidden="false"
            ></div>

            <div style="display: flex; gap: 8px; align-items: center">
              <button id="gridBtn" class="mode-btn active" title="Grid view">
                Grid
              </button>
              <button id="museumBtn" class="mode-btn" title="Gallery (Museum)">
                Museum
              </button>
              <button id="birthdaysBtn" class="mode-btn" title="Birthdays">
                Birthdays
              </button>
              <button id="presentBtn" class="mode-btn" title="Present mode">
                Present
              </button>
            </div>
          </div>
        </div>

        <div style="color: #fff; font-weight: 700; text-align: right">
          Maxwell • 2025–26
        </div>
      </div>
    </section>

    <!-- confetti canvas global (used by birthday popups) -->
    <canvas
      id="popupConfetti"
      class="bd-confetti-canvas"
      aria-hidden="true"
    ></canvas>

    <!-- pinned panel -->
    <aside
      id="pinnedColumn"
      class="pinned-column hidden"
      aria-label="Pinned events"
    >
      <div class="panel-top">
        <strong style="font-size: 14px; color: #072238">Pinned</strong>
        <div>
          <button id="exportPins" class="btn" title="Export pinned">
            Export
          </button>
          <button id="clearPins" class="clear-btn" title="Clear pins">
            Clear
          </button>
          <button
            id="pinCollapseBtn"
            class="btn"
            aria-pressed="false"
            title="Collapse panel"
          >
            Hide
          </button>
        </div>
      </div>
      <!-- chips injected here -->
    </aside>
    <button id="pinnedToggleBtn" class="hidden" title="Open pinned panel">
      📌
    </button>

    <main class="wrap">
      <div class="top-row">
        <div>
          <h1 id="pageTitle">School Events Countdown</h1>
          <div id="subtitle">2025-2026 schedule</div>
          <div class="year-progress" aria-hidden="true">
            <i id="yearProgressBar" style="width: 0%"></i>
          </div>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            color: #fff;
            font-weight: 700;
          "
        >
          Maxwell • 2025–26
        </div>
      </div>

      <!-- gallery (museum) -->
      <section
        id="gallerySection"
        class="gallery-wrap"
        style="display: none"
        aria-hidden="true"
      ></section>

      <!-- birthdays -->
      <section
        id="birthdaysSection"
        class="birthdays-wrap"
        style="display: none"
        aria-hidden="true"
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <div style="font-weight: 900; color: #fff">Student Birthdays</div>
          <div style="color: rgba(255, 255, 255, 0.9)">
            Shown by next upcoming
          </div>
        </div>

        <div class="birth-controls">
          <input
            id="bdSearch"
            type="search"
            placeholder="Search birthdays (name)..."
            aria-label="Search birthdays"
            style="
              min-width: 220px;
              padding: 8px;
              border-radius: 10px;
              border: 1px solid rgba(255, 255, 255, 0.06);
              background: rgba(255, 255, 255, 0.03);
              color: #fff;
            "
          />
          <select
            id="bdMonthFilter"
            aria-label="Filter birthdays by month"
            style="
              padding: 8px;
              border-radius: 10px;
              border: 1px solid rgba(255, 255, 255, 0.06);
              background: rgba(255, 255, 255, 0.03);
              color: #fff;
            "
          >
            <option value="">All months</option>
            <option value="01">Jan</option>
            <option value="02">Feb</option>
            <option value="03">Mar</option>
            <option value="04">Apr</option>
            <option value="05">May</option>
            <option value="06">Jun</option>
            <option value="07">Jul</option>
            <option value="08">Aug</option>
            <option value="09">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dec</option>
          </select>
          <div
            style="
              margin-left: auto;
              color: rgba(255, 255, 255, 0.85);
              font-weight: 700;
            "
          >
            Tip: press <code>g</code>/<code>m</code>/<code>b</code> to switch
            views
          </div>
        </div>

        <div id="birthGrid" class="birth-grid" aria-live="polite"></div>
      </section>

      <!-- events grid -->
      <section id="stage">
        <div id="eventsGrid" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <!-- lightbox -->
    <div
      id="lightbox"
      class="lightbox"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="controls" aria-hidden="false">
        <button id="lbPrev" aria-label="Previous">◀</button>
        <button id="lbNext" aria-label="Next">▶</button>
      </div>
      <div style="text-align: center; max-width: 95%">
        <img id="lbImage" alt="" />
        <div class="caption" id="lbCaption"></div>
        <div style="margin-top: 12px">
          <button id="lbClose" class="btn">Close</button>
        </div>
      </div>
    </div>

    <!-- birthdays popup wrapper -->
    <div
      id="bdPopupWrap"
      class="bd-popup-wrap"
      aria-hidden="true"
      style="display: none"
    ></div>

    <script>
      /* -------------------------
   Data & constants
   ------------------------- */
      const HERO =
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1";

      /* Events (Peanut Carnival added on Oct 5, 2025) */
      const EVENTS = [
        { name: "Summer Holiday", start: "2025-08-01", end: "2025-08-09" },
        {
          name: "School Opening (Arrival & Dorm Move-in)",
          start: "2025-08-10",
          end: "2025-08-11",
        },
        { name: "First Semester Registration", start: "2025-08-11" },
        { name: "Orientation", start: "2025-08-12" },
        { name: "Faculty Family", start: "2025-09-07" },
        { name: "Picture Day", start: "2025-09-09" },
        { name: "Open Weekend", start: "2025-09-12", end: "2025-09-14" },
        { name: "Week of Prayer", start: "2025-09-15", end: "2025-09-20" },
        { name: "Camping Trip", start: "2025-09-21", end: "2025-09-23" },
        { name: "Online Parent-Teacher Conferences", start: "2025-09-30" },
        { name: "Midterm Break", start: "2025-10-09", end: "2025-10-20" },
        { name: "Peanut Carnival", start: "2025-10-05" }, // newly added
        { name: "Music Sabbath", start: "2025-10-25" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2025-11-07",
          end: "2025-11-08",
        },
        { name: "MAP Testing", start: "2025-11-24", end: "2025-11-27" },
        { name: "Faculty Family", start: "2025-11-14" },
        { name: "Finals Review Week", start: "2025-12-01", end: "2025-12-05" },
        { name: "Final Exams 1st Sem", start: "2025-12-08", end: "2025-12-10" },
        { name: "Christmas Break", start: "2025-12-10", end: "2026-01-05" },
        { name: "School Opening (2nd Sem)", start: "2026-01-05" },
        {
          name: "Senior Government Day",
          start: "2026-01-20",
          end: "2026-01-21",
        },
        { name: "Faculty Family", start: "2026-01-30" },
        { name: "Junior Vespers", start: "2026-02-06" },
        { name: "NHS Applications Deadline", start: "2026-02-10" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2026-02-13",
          end: "2026-02-14",
        },
        { name: "ACT", start: "2026-02-13" },
        { name: "NHS Induction", start: "2026-02-17" },
        { name: "Mt. Kenya Trip", start: "2026-02-20", end: "2026-02-24" },
        { name: "Senior Dedication", start: "2026-02-27" },
        { name: "Sophomore Vespers", start: "2026-03-06" },
        {
          name: "Student-Led Week of Prayer",
          start: "2026-03-09",
          end: "2026-03-14",
        },
        { name: "Track and Field", start: "2026-03-19", end: "2026-03-20" },
        { name: "Chorale Sacred Concert", start: "2026-03-21" },
        { name: "Senior Class Trip", start: "2026-03-23", end: "2026-03-26" },
        { name: "Midterm Break", start: "2026-03-26", end: "2026-04-06" },
        {
          name: "Ethiopia Mission Trip",
          start: "2026-03-26",
          end: "2026-04-05",
        },
        { name: "ACT", start: "2026-04-10" },
        { name: "Freshmen Vespers", start: "2026-04-17" },
        { name: "Faculty Family", start: "2026-04-19" },
        { name: "Week of Prayer", start: "2026-04-20", end: "2026-04-25" },
        { name: "Long Weekend", start: "2026-04-30", end: "2026-05-03" },
        { name: "ASB Spirit Week", start: "2026-05-04", end: "2026-05-09" },
        { name: "Class Surveys", start: "2026-05-11", end: "2026-05-13" },
        { name: "ASB Elections", start: "2026-05-12" },
        { name: "Spring Concert", start: "2026-05-16" },
        { name: "MAP Testing", start: "2026-05-18", end: "2026-05-21" },
        { name: "Dorm Parties", start: "2026-05-23" },
        { name: "Dorm Outings", start: "2026-05-24" },
        { name: "Finals Review Week", start: "2026-05-25", end: "2026-05-29" },
        { name: "Zamani Night", start: "2026-05-30" },
        { name: "Elementary Graduation", start: "2026-05-31" },
        { name: "Final Exams 2nd Sem", start: "2026-06-02", end: "2026-06-04" },
        { name: "GRADDDDD!!!!", start: "2026-06-05", end: "2026-06-07" },
      ];

      const MONTH_COLORS = {
        "01": "#e74c3c",
        "02": "#ff8a65",
        "03": "#f6c85f",
        "04": "#8dd3c7",
        "05": "#66a3ff",
        "06": "#9b59b6",
        "07": "#f06292",
        "08": "#ffb84d",
        "09": "#6ab04c",
        10: "#4a90e2",
        11: "#34495e",
        12: "#7bdbdb",
      };

      /* MUSEUM / gallery photos — replaced first 4 campus pics as requested */
      const MUSEUM_PHOTOS = [
        {
          src: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmV27Af6dGvJoR-LVUGmkCauwQepWKLwi7Zw&s",
          caption: "Campus View 1",
          month: "08",
          year: 2025,
        },
        {
          src: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHDr-_KeMgIf8tN3PHxytKFN7lbUhaLuPpkQ&s",
          caption: "Campus View 2",
          month: "08",
          year: 2025,
        },
        {
          src: "https://static.wixstatic.com/media/b62f56_ce88667acf42430fbea4c12175730dd3.jpg/v1/fill/w_960,h_640,al_c,q_85,enc_avif,quality_auto/b62f56_ce88667acf42430fbea4c12175730dd3.jpg",
          caption: "Campus View 3",
          month: "08",
          year: 2025,
        },
        {
          src: "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/03/EsoPheb.jpeg?fit=1400%2C1400&ssl=1",
          caption: "Campus View 4",
          month: "08",
          year: 2025,
        },
        /* extras */
        { src: HERO, caption: "Maxwell — Banner", month: "08", year: 2025 },
        {
          src: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1600&q=80&auto=format&fit=crop",
          caption: "Forest Path",
          month: "09",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1600&q=80&auto=format&fit=crop",
          caption: "Lake at Dawn",
          month: "10",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1503264116251-35a269479413?w=1600&q=80&auto=format&fit=crop",
          caption: "Foggy Ridge",
          month: "12",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1600&q=80&auto=format&fit=crop",
          caption: "Mountain Trail",
          month: "03",
          year: 2026,
        },
        {
          src: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=1600&q=80&auto=format&fit=crop",
          caption: "Sunset Camp",
          month: "05",
          year: 2026,
        },
      ];

      /* STUDENT BIRTHDAYS (as requested) */
      const BIRTHDAYS_RAW = [
        ["Clerick Blessing Duke", "01/05/2013"],
        ["Bonde Joseph", "01/09/2012"],
        ["Njaaga Alvar-Joe", "01/09/2008"],
        ["Kiswaa Natalie", "01/11/2012"],
        ["Kyanja Ezra", "01/11/2009"],
        ["Rutambuka Lyndzie", "01/13/2010"],
        ["Kazembe Tanya", "01/14/2009"],
        ["Mbanza Gisa", "01/14/2009"],
        ["Kimori Trinah", "01/26/2008"],
        ["Mlacha Ishal", "01/27/2012"],
        ["Iganze Eva", "02/03/2010"],
        ["Mwarekwa Alvin", "02/04/2009"],
        ["Mwarekwa Calvin", "02/04/2009"],
        ["Shingiro Junior Caleb", "02/05/2009"],
        ["Mhishi Munotidaishe", "02/08/2012"],
        ["Silva Margarida", "02/13/2010"],
        ["John Alyssa", "02/14/2011"],
        ["Kamawu Christian", "02/19/2017"],
        ["Karasi Jayda", "02/20/2012"],
        ["Kemoabe Ofile", "02/23/2023"],
        ["Sam-Nwaomah Umanu", "02/28/2009"],
        ["Fares Farena", "03/01/2012"],
        ["Kazoya Muhezagiro", "03/01/2013"],
        ["Mulama Ian", "03/03/2009"],
        ["Mwinuka Nathaniel", "03/11/2012"],
        ["Ombaso Alexina", "03/12/2012"],
        ["Samwel Samwel", "03/14/2010"],
        ["Moyo Uyanaka", "03/17/2010"],
        ["Bett Cristiano", "03/21/2009"],
        ["Onyekachi Peniel", "03/24/2009"],
        ["Gwatiringa Shekainah", "03/27/2013"],
        ["Musi Meloy", "03/28/2008"],
        ["Mutangana Mariam", "03/30/2009"],
        ["Obse Gelila", "04/01/2007"],
        ["Gichana Bernice", "04/04/2008"],
        ["Mandela Teddy", "04/04/2012"],
        ["Bahizire Yadah", "04/05/2012"],
        ["Kigongo Grace", "04/09/2007"],
        ["Mokotedi Sesha", "04/10/2013"],
        ["Ochieng Adina", "04/10/2008"],
        ["Wangui Esther", "04/13/2008"],
        ["Golooba-Mutebi Kizza", "04/23/2009"],
        ["Shange Neserian", "04/28/2010"],
        ["Muhune Glodi", "04/29/2025"],
        ["Remir Nathan", "04/30/2013"],
        ["Galgao Eleon Ythan", "05/02/2019"],
        ["Oriko Breanna", "05/03/2009"],
        ["Ganza Keza", "05/05/2008"],
        ["Koros Edlyn", "05/10/2011"],
        ["Shange Nasieku", "05/14/2009"],
        ["Okotoh Ryan", "05/23/2010"],
        ["Ogenche Martha", "05/25/2009"],
        ["Kedas Arnav", "05/26/2010"],
        ["Neza Shevaun", "05/29/2012"],
        ["Wasilwa Aneesa", "05/30/2011"],
        ["Githinji Abigail", "06/05/2009"],
        ["Lugembe Sallyrose louise", "06/06/2008"],
        ["Ombaba Enock", "06/06/2010"],
        ["Omare Justin", "06/09/2011"],
        ["Ninziza Prince", "06/11/2008"],
        ["Ninziza Shammah", "06/11/2008"],
        ["Birasa Alan", "06/12/2008"],
        ["Bakuru Elkanah", "06/13/2011"],
        ["Njine Paola", "06/13/2009"],
        ["Galava Rubie", "06/17/2007"],
        ["Kabeja Larina", "06/18/2008"],
        ["Noullia Tuyisenge", "06/20/2008"],
        ["Muhumuza Elaine", "06/22/2017"],
        ["Mugisha Divine", "06/23/2007"],
        ["Guvi Michael", "06/26/2009"],
        ["Silva Ana", "06/26/2007"],
        ["Jackson Edward-Ebenezer", "06/29/2012"],
        ["Onserio Angel", "07/03/2009"],
        ["Javaid Nathan", "07/04/2008"],
        ["Mugisha Ines", "07/07/2009"],
        ["Kimori Daniella", "07/15/2011"],
        ["Kweka Mathew", "07/16/2011"],
        ["Mwakilembe Jadah-Elice", "07/17/2013"],
        ["Mwinuka Claver", "07/17/2010"],
        ["Tarpeh Mearaf", "07/23/2009"],
        ["Alemayehu Paulos", "07/24/2010"],
        ["Gilliam Danson Hirwa", "07/25/2006"],
        ["Sivako Oleyo", "08/01/2013"],
        ["Ombaba Orel", "08/03/2012"],
        ["Hope Haeven Ajeneza", "08/12/2012"],
        ["Mpingasa Tadala", "08/14/2010"],
        ["Mpingasa Takondwa", "08/14/2010"],
        ["Wenyika Jonathan", "08/15/2013"],
        ["Galgao Jedrie Jess", "08/16/2015"],
        ["Anokye-Larbey David", "08/17/2008"],
        ["Manento Rodney", "08/17/2009"],
        ["Ntimbwa Esther", "08/17/2010"],
        ["Villagomez Matthew Christian", "08/17/2007"],
        ["Riziki Mycah", "08/25/2009"],
        ["Javaid Jayson", "08/27/2016"],
        ["Kamau Cungu", "08/29/2008"],
        /* September (user emphasized) */
        ["Ochieng Adrian", "09/02/2011"],
        ["Wenyika Ethan", "09/04/2009"],
        ["Koome Kris", "09/06/2007"],
        ["Poniatovska Tereza", "09/11/2017"],
        ["Mphinyane Serwalo", "09/13/2013"],
        ["Nyange Michael", "09/14/2009"],
        ["Daniel Daniela", "09/17/2008"],
        ["Castroe Tendai", "09/20/2013"],
        ["Masasabi Olive", "09/24/2012"],
        ["Ineza Arcella", "09/25/2011"],
        ["Lwanzo Salome", "09/25/2011"],
        ["Omonte Tito Jael", "09/25/2011"],
        ["Omonte Tito Julian", "09/25/2011"],
        ["Gadi Charissa", "10/03/2012"],
        ["Katongo Joshua", "10/03/2011"],
        ["Rampart Esolwazi", "10/03/2008"],
        ["Alihamdoulillah Ntakirutimana", "10/04/2012"],
        ["Psenjen Annie", "10/07/2011"],
        ["Tianah Elyon", "10/07/2011"],
        ["Ruzibiza Soa", "10/09/2011"],
        ["Zirimwabagabo Samuel", "10/09/2008"],
        ["Shange Neriah", "10/12/2011"],
        ["Javaid Michelle", "10/13/2010"],
        ["Kyalo Sherlyne", "10/16/2012"],
        ["Mkandawire Zawadi", "10/18/2011"],
        ["Mfura Arnaud", "10/20/2008"],
        ["Okiya Saha", "10/25/2011"],
        ["Mahamba Furaha", "10/26/2007"],
        ["Rumiti Neslie", "10/26/2007"],
        ["Omare Chantelle", "11/03/2009"],
        ["Nyabuga Maya", "11/05/2010"],
        ["Both Ruot", "11/16/2007"],
        ["Koech Padon", "11/17/2007"],
        ["Kariuki Ryan", "11/20/2009"],
        ["Lwanzo Grace", "11/20/2008"],
        ["Moyo Musawakhe", "11/21/2012"],
        ["Mpomabiva Harleen", "11/21/2009"],
        ["Alemayehu Pheben", "11/22/2008"],
        ["Uwikunda Shami", "11/25/2011"],
        ["Sheja Daniel", "11/27/2009"],
        ["Ineza Andrea", "11/29/2007"],
        ["Mugisha Kamugisha", "11/30/2008"],
        ["Mwasumbi Lupakisyo", "12/03/2007"],
        ["Simankane Taelo", "12/05/2010"],
        ["Igiraneza Betha-Claudia", "12/06/2010"],
        ["Kamawu Carla", "12/07/2018"],
        ["Mbucho Elvis Eddie", "12/12/2012"],
        ["John Jathniel", "12/13/2008"],
        ["Bakuru Elgin", "12/14/2012"],
        ["Sivako Tiffany", "12/18/2007"],
        ["Simankane Tsaone", "12/25/2008"],
        ["Sekabaraga Adriano Sheja", "12/26/2008"],
        ["Hosea Precious", "12/30/2008"],
      ];

      /* -------------------------
   Helpers
   ------------------------- */
      const $ = (id) => document.getElementById(id);
      const pad = (n) => (n < 10 ? "0" + n : String(n));
      const parseDate = (s) => {
        if (/\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s + "T00:00:00");
        const [m, d, y] = s.split("/").map(Number);
        return new Date(y, m - 1, d, 0, 0, 0, 0);
      };
      const parseStart = (s) => parseDate(s);
      const parseEnd = (e, start) => {
        if (!e) {
          const d = new Date(start);
          d.setHours(23, 59, 59, 999);
          return d;
        }
        return parseDate(e);
      };
      const formatISO = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      const shortMonth = (d) => d.toLocaleString("en", { month: "short" });

      function formatDateBadge(start, end) {
        const s = parseStart(start);
        const e = end ? parseStart(end) : null;
        if (!e) return `${shortMonth(s)} ${s.getDate()}`;
        if (
          s.getFullYear() === e.getFullYear() &&
          s.getMonth() === e.getMonth()
        )
          return `${shortMonth(s)} ${s.getDate()}–${e.getDate()}`;
        return `${shortMonth(s)} ${s.getDate()} – ${shortMonth(
          e
        )} ${e.getDate()}`;
      }

      function slugify(name, idx) {
        return (
          String(name)
            .toLowerCase()
            .replace(/[’'"]/g, "")
            .replace(/[:\/\\(),.!?#\u2013\u2014]/g, "")
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "") +
          "-" +
          idx
        );
      }

      function eventIcon(name) {
        const n = name.toLowerCase();
        if (/exam|final|midterm|test|act|map/.test(n)) return "📝";
        if (
          /break|holiday|christmas|spring|long weekend|summer|vacation/.test(n)
        )
          return "🎉";
        if (/trip|camp|mt|mountain|mission/.test(n)) return "🏕️";
        if (/concert|chorale|music/.test(n)) return "🎵";
        if (/sports|track|field/.test(n)) return "🏅";
        return "📅";
      }

      /* next occurrence helper for birthdays */
      function nextOccurrence(month, day, from = new Date()) {
        const year = from.getFullYear();
        let candidate = new Date(year, month - 1, day, 0, 0, 0, 0);
        // compare date-only
        const todayDate = new Date(
          from.getFullYear(),
          from.getMonth(),
          from.getDate(),
          0,
          0,
          0,
          0
        );
        if (candidate < todayDate)
          candidate = new Date(year + 1, month - 1, day, 0, 0, 0, 0);
        return candidate;
      }
      function daysBetween(a, b) {
        return Math.ceil((b - a) / 86400000);
      }
      function formatUntil(date) {
        const now = new Date();
        let diff = Math.max(0, date - now);
        const days = Math.floor(diff / 86400000);
        diff -= days * 86400000;
        const hours = Math.floor(diff / 3600000);
        diff -= hours * 3600000;
        const mins = Math.floor(diff / 60000);
        return `${days}d ${hours}h ${mins}m`;
      }

      /* -------------------------
   State & storage
   ------------------------- */
      let items = [],
        tickHandle = null,
        mode = "grid";
      const PINNED_KEY = "maxwell_pinned_v3";

      function getPinned() {
        try {
          return JSON.parse(localStorage.getItem(PINNED_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }
      function setPinned(arr) {
        localStorage.setItem(PINNED_KEY, JSON.stringify(arr));
        renderPinnedPanel();
      }
      function isPinned(i) {
        return getPinned().includes(i);
      }
      function togglePin(i) {
        const arr = getPinned();
        const p = arr.indexOf(i);
        if (p === -1) {
          arr.unshift(i);
          while (arr.length > 100) arr.pop();
        } else arr.splice(p, 1);
        setPinned(arr);
      }

      /* -------------------------
   Render events grid
   ------------------------- */
      function sortEvents() {
        EVENTS.sort((a, b) => parseStart(a.start) - parseStart(b.start));
      }
      function findNext() {
        const now = Date.now();
        return (
          EVENTS.find(
            (ev) => parseEnd(ev.end, parseStart(ev.start)).getTime() >= now
          ) || null
        );
      }

      function updateYearProgress() {
        if (EVENTS.length === 0) return;
        const start = parseStart(EVENTS[0].start);
        const last = EVENTS[EVENTS.length - 1];
        const end = parseEnd(last.end, parseStart(last.start));
        const now = new Date();
        const total = end.getTime() - start.getTime();
        const passed = Math.max(
          0,
          Math.min(total, now.getTime() - start.getTime())
        );
        const pct = Math.round((passed / total) * 100);
        $("yearProgressBar").style.width = pct + "%";
      }

      function renderNextUp() {
        const next = findNext();
        // we don't have "nextUp" section in this build (kept minimal). If you want it, can re-add.
        return next;
      }

      function renderAll() {
        if (tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
        items = [];
        const grid = $("eventsGrid");
        if (!grid) return;
        grid.innerHTML = "";
        sortEvents();
        const q = ($("searchBox").value || "").toLowerCase();
        const monthVal = $("monthFilter").value || "";

        let currentGroup = "";
        EVENTS.forEach((ev, idx) => {
          if (q && !ev.name.toLowerCase().includes(q)) return;
          if (monthVal && ev.start.slice(5, 7) !== monthVal) return;

          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          const mmKey = `${start.getFullYear()}-${pad(start.getMonth() + 1)}`;
          if (mmKey !== currentGroup) {
            currentGroup = mmKey;
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${start.toLocaleString("en", {
              month: "long",
            })} ${start.getFullYear()}`;
            heading.dataset.mm = pad(start.getMonth() + 1);
            heading.addEventListener("click", () => {
              $("monthFilter").value = heading.dataset.mm;
              highlightMonthButton(heading.dataset.mm);
              renderAll();
            });
            grid.appendChild(heading);
          }

          const id = slugify(ev.name, idx);
          const monthColor = MONTH_COLORS[pad(start.getMonth() + 1)] || "#ccc";
          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("data-id", id);
          card.setAttribute("data-idx", idx);
          card.innerHTML = `
      <div class="month-strip" style="background:${monthColor}"></div>
      <button class="pin-btn" title="Pin event" aria-label="Pin event" data-idx="${idx}">📌</button>
      <div class="big-letter" aria-hidden="true">${
        ev.name && ev.name[0] ? ev.name[0].toUpperCase() : "E"
      }</div>
      <div class="card-content">
        <div class="title" id="title-wrap-${id}"><span class="fill" id="title-fill-${id}">${
            ev.name
          }</span><span class="fallback" id="title-fallback-${id}">${
            ev.name
          }</span></div>
        <div class="meta">${eventIcon(ev.name)} ${
            ev.end
              ? `${formatISO(start)} → ${formatISO(parseStart(ev.end))}`
              : formatISO(start)
          }</div>
        <div class="countdown" id="cd-${id}">—</div>
        <div class="status" id="st-${id}">—</div>
        <div class="date-badge" id="db-${id}">${formatDateBadge(
            ev.start,
            ev.end
          )}</div>
      </div>
    `;
          grid.appendChild(card);

          // preload fill background
          (function (iid, url) {
            const im = new Image();
            im.crossOrigin = "anonymous";
            im.onload = () => {
              const f = document.getElementById("title-fill-" + iid);
              const fb = document.getElementById("title-fallback-" + iid);
              if (f) {
                f.style.backgroundImage = `url('${url}')`;
                f.style.backgroundSize = "cover";
                f.style.backgroundPosition = "center";
                f.style.opacity = "1";
                if (fb) fb.style.opacity = "0";
              }
            };
            im.onerror = () => {};
            im.src = url;
          })(id, HERO);

          items.push({ id, name: ev.name, start, end, el: card, idx });

          // pin
          const pb = card.querySelector(".pin-btn");
          if (pb) {
            const refresh = () => pb.classList.toggle("active", isPinned(idx));
            pb.addEventListener("click", (e) => {
              e.stopPropagation();
              togglePin(idx);
              refresh();
            });
            refresh();
          }

          card.tabIndex = 0;
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") card.click();
          });

          // swipe-to-pin
          addSwipeToPin(card, idx);
        });

        // tick
        tickHandle = setInterval(() => {
          const now = new Date();
          items.forEach((i) => updateOne(i, now));
          updatePinnedCounts(now);
        }, 1000);
        items.forEach((i) => updateOne(i, new Date()));

        renderPinnedPanel();
        if (mode === "museum") renderGallery();
        if (mode === "birthdays") renderBirthdays();
        updateYearProgress();
        applyMode();
      }

      function updateOne(item, now) {
        const { id, start, end, el } = item;
        const cd = document.getElementById("cd-" + id);
        const st = document.getElementById("st-" + id);
        if (!cd || !st) return;
        if (now.getTime() < start.getTime()) {
          el.classList.remove("happening", "finished");
          el.classList.add("upcoming");
          const diff = start.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s left`;
          st.textContent = "⏳ Coming soon";
        } else if (now.getTime() > end.getTime()) {
          el.classList.remove("upcoming", "happening");
          el.classList.add("finished");
          cd.textContent = `Ended on ${formatISO(end)}`;
          st.textContent = "✅ Finished";
        } else {
          el.classList.remove("upcoming", "finished");
          el.classList.add("happening");
          const diff = end.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s remaining`;
          st.textContent = "🔴 Happening now";
        }
      }

      /* -------------------------
   Pinned panel
   ------------------------- */
      function renderPinnedPanel() {
        const container = $("pinnedColumn");
        if (!container) return;
        const header = container.querySelector(".panel-top");
        container.innerHTML = "";
        if (header) container.appendChild(header);

        const pinnedIndices = getPinned();

        if (pinnedIndices.length === 0) {
          container.classList.add("hidden");
          $("pinnedToggleBtn").classList.add("hidden");
          return;
        } else {
          container.classList.remove("hidden");
          $("pinnedToggleBtn").classList.remove("hidden");
        }

        pinnedIndices.forEach((idx) => {
          const ev = EVENTS[idx];
          if (!ev) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          const id = "pin_" + slugify(ev.name + "-" + idx, idx);
          const chip = document.createElement("div");
          chip.className = "pinned-chip";
          chip.id = id;
          chip.dataset.eventIndex = String(idx);
          chip.innerHTML = `
      <div class="pinned-row-top">
        <div style="min-width:0">
          <div class="pinned-title" style="font-weight:800;color:#072238;font-size:14px">${
            ev.name
          }</div>
          <div class="pinned-sub" style="font-size:12px;color:#2a3b57">${
            ev.end
              ? formatISO(start) + " → " + formatISO(parseStart(ev.end))
              : formatISO(start)
          }</div>
        </div>
        <div style="text-align:right"><div class="pinned-count" id="count-${id}">—</div></div>
      </div>
      <div class="pinned-progress"><i style="width:0%"></i></div>
    `;
          chip.addEventListener("click", () => {
            const idx = Number(chip.dataset.eventIndex);
            const target = items.find((it) => it.idx === idx);
            if (target && target.el) {
              target.el.scrollIntoView({ behavior: "smooth", block: "center" });
              target.el.style.boxShadow = "0 20px 60px rgba(255,180,60,0.32)";
              target.el.style.transform = "translateY(-8px)";
              setTimeout(() => {
                target.el.style.boxShadow = "";
                target.el.style.transform = "";
              }, 1200);
            }
          });
          container.appendChild(chip);
        });

        updatePinnedCounts(new Date());
      }

      function updatePinnedCounts(now) {
        if (!now) now = new Date();
        const container = $("pinnedColumn");
        if (!container) return;
        const chips = Array.from(container.querySelectorAll(".pinned-chip"));
        chips.forEach((chip) => {
          const idx = Number(chip.dataset.eventIndex);
          const ev = EVENTS[idx];
          if (!ev) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          let txt = "",
            percent = 0;
          if (now.getTime() < start.getTime()) {
            const diff = start.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            txt = `${d}d ${h}h ${m}m left`;
            percent = 0;
          } else if (now.getTime() > end.getTime()) {
            txt = `Finished`;
            percent = 100;
          } else {
            const total = end.getTime() - start.getTime();
            const remaining = end.getTime() - now.getTime();
            const passed = total - remaining;
            percent = Math.max(
              0,
              Math.min(100, Math.round((passed / total) * 100))
            );
            const diff = remaining;
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            txt = `${d}d ${h}h ${m}m remaining`;
          }
          const countEl = chip.querySelector(`#count-${chip.id}`);
          const prog = chip.querySelector(".pinned-progress i");
          if (countEl) countEl.textContent = txt;
          if (prog) prog.style.width = percent + "%";
        });
      }

      /* -------------------------
   Touch swipe-to-pin
   ------------------------- */
      function addSwipeToPin(card, idx) {
        let pointerDown = false,
          startX = 0,
          startY = 0,
          moved = false;
        function down(e) {
          pointerDown = true;
          startX = e.clientX;
          startY = e.clientY;
          moved = false;
        }
        function move(e) {
          if (!pointerDown) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          if (Math.abs(dx) > 8 && Math.abs(dx) > Math.abs(dy)) moved = true;
          if (moved)
            card.style.transform = `translateX(${Math.min(
              Math.max(dx, -60),
              60
            )}px)`;
        }
        function up(e) {
          if (!pointerDown) return;
          pointerDown = false;
          if (moved) {
            const dx = e.clientX - startX;
            if (dx > 60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.add("active");
              card.style.transform = "";
            } else if (dx < -60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.remove("active");
              card.style.transform = "";
            } else card.style.transform = "";
          }
        }
        card.addEventListener("pointerdown", down);
        card.addEventListener("pointermove", move);
        card.addEventListener("pointerup", up);
        card.addEventListener("pointercancel", up);
      }

      /* -------------------------
   Gallery
   ------------------------- */
      function renderGallery() {
        const wrap = $("gallerySection");
        if (!wrap) return;
        wrap.innerHTML = "";
        const monthFilter = $("monthFilter").value || "";
        const months = new Map();
        MUSEUM_PHOTOS.forEach((photo) => {
          const key = `${photo.year}-${photo.month}`;
          if (!months.has(key))
            months.set(key, {
              month: photo.month,
              year: photo.year,
              photos: [],
            });
          months.get(key).photos.push(photo);
        });
        Array.from(months.entries())
          .sort()
          .forEach(([key, group]) => {
            if (monthFilter && group.month !== monthFilter) return;
            const section = document.createElement("div");
            section.className = "gallery-month";
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${new Date(
              group.year + "-" + group.month + "-01"
            ).toLocaleString("en", { month: "long", year: "numeric" })}`;
            heading.addEventListener("click", () => {
              $("monthFilter").value = group.month;
              highlightMonthButton(group.month);
              renderGallery();
            });
            section.appendChild(heading);
            const grid = document.createElement("div");
            grid.className = "gallery-grid";
            group.photos.forEach((p, i) => {
              const t = document.createElement("div");
              t.className = "gallery-thumb";
              t.tabIndex = 0;
              t.innerHTML = `<img src="${p.src}" alt="${p.caption}"><div class="gallery-caption">${p.caption}</div>`;
              t.addEventListener("click", () => openLightbox(group.photos, i));
              t.addEventListener("keydown", (e) => {
                if (e.key === "Enter") openLightbox(group.photos, i);
              });
              grid.appendChild(t);
            });
            section.appendChild(grid);
            wrap.appendChild(section);
          });
      }

      /* -------------------------
   Lightbox
   ------------------------- */
      let lbPhotos = [],
        lbIndex = 0;
      function openLightbox(photos, idx) {
        lbPhotos = photos;
        lbIndex = idx;
        const light = $("lightbox");
        const img = $("lbImage");
        const cap = $("lbCaption");
        img.src = photos[idx].src;
        img.alt = photos[idx].caption;
        cap.textContent = photos[idx].caption;
        light.classList.add("open");
        light.setAttribute("aria-hidden", "false");
      }
      function closeLightbox() {
        const light = $("lightbox");
        light.classList.remove("open");
        light.setAttribute("aria-hidden", "true");
      }
      function lbNext() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex + 1) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }
      function lbPrev() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex - 1 + lbPhotos.length) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }
      $("lbClose").addEventListener("click", closeLightbox);
      $("lbNext").addEventListener("click", lbNext);
      $("lbPrev").addEventListener("click", lbPrev);
      document.addEventListener("keydown", (e) => {
        const light = $("lightbox");
        if (light.classList.contains("open")) {
          if (e.key === "ArrowRight") lbNext();
          if (e.key === "ArrowLeft") lbPrev();
          if (e.key === "Escape") closeLightbox();
        }
      });

      /* -------------------------
   Birthdays: build, render & popups
   ------------------------- */
      function buildBirthdayList() {
        return BIRTHDAYS_RAW.map(([name, mmddyyyy]) => {
          const [mm, dd, yyyy] = mmddyyyy.split("/").map(Number);
          return {
            name,
            dob: new Date(yyyy, mm - 1, dd, 0, 0, 0, 0),
            month: pad(mm),
            day: pad(dd),
            year: yyyy,
          };
        });
      }
      const BIRTHDAYS = buildBirthdayList();

      function daysUntilNext(birth) {
        const now = new Date();
        const nxt = nextOccurrence(Number(birth.month), Number(birth.day), now);
        return Math.ceil(
          (nxt -
            new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate(),
              0,
              0,
              0,
              0
            )) /
            86400000
        );
      }
      function ageAtNext(birth) {
        const now = new Date();
        const nxt = nextOccurrence(Number(birth.month), Number(birth.day), now);
        return nxt.getFullYear() - birth.year;
      }

      /* Render birthdays (filterable by search + month). Sorted by closest */
      function renderBirthdays() {
        const wrap = $("birthGrid");
        if (!wrap) return;
        const searchVal = ($("bdSearch").value || "").trim().toLowerCase();
        const monthFilter = $("bdMonthFilter").value || "";
        wrap.innerHTML = "";
        const enriched = BIRTHDAYS.map((b) => ({
          ...b,
          daysUntil: daysUntilNext(b),
          nextAge: ageAtNext(b),
        }));
        const filtered = enriched
          .filter((b) => {
            if (searchVal && !b.name.toLowerCase().includes(searchVal))
              return false;
            if (monthFilter && b.month !== monthFilter) return false;
            return true;
          })
          .sort(
            (a, b) => a.daysUntil - b.daysUntil || a.name.localeCompare(b.name)
          );
        filtered.forEach((b) => {
          const card = document.createElement("div");
          card.className = "bd-card";
          const name = document.createElement("div");
          name.className = "bd-name";
          name.textContent = b.name;
          const dob = document.createElement("div");
          dob.className = "bd-date";
          dob.textContent = `${b.month}/${b.day}/${b.year} • Turning ${b.nextAge}`;
          const count = document.createElement("div");
          count.className = "bd-count";
          if (b.daysUntil === 0) count.textContent = `Today! 🎉`;
          else count.textContent = `In ${b.daysUntil} day(s)`;
          card.appendChild(name);
          card.appendChild(dob);
          card.appendChild(count);
          wrap.appendChild(card);
        });
      }

      /* birthday popups for today's birthdays (sequential) */
      async function runBirthdayPopups() {
        const today = new Date();
        const mm = pad(today.getMonth() + 1),
          dd = pad(today.getDate());
        const todays = BIRTHDAYS.filter((b) => b.month === mm && b.day === dd);
        if (!todays.length) return;
        const wrap = $("bdPopupWrap");
        wrap.innerHTML = "";
        wrap.style.display = "flex";
        wrap.setAttribute("aria-hidden", "false");
        const canvas = $("popupConfetti");
        const ctx = canvas.getContext("2d");
        function resize() {
          canvas.width = innerWidth;
          canvas.height = innerHeight;
        }
        resize();
        window.addEventListener("resize", resize);

        // simple particle bursts
        function playParticlesFor(seconds) {
          const particles = [];
          const colors = [
            "#ffb84d",
            "#ffd24a",
            "#ff7aa2",
            "#66a3ff",
            "#9b59b6",
            "#6ab04c",
          ];
          const now = Date.now();
          function spawnBurst() {
            const cx = innerWidth / 2;
            const cy = innerHeight / 2 - 40;
            const count = 36;
            for (let i = 0; i < count; i++) {
              const angle =
                Math.PI * 2 * (i / count) + (Math.random() * 0.4 - 0.2);
              const speed = 2 + Math.random() * 4;
              particles.push({
                x: cx,
                y: cy,
                vx: Math.cos(angle) * speed * (0.8 + Math.random()),
                vy:
                  Math.sin(angle) * speed * (0.8 + Math.random()) -
                  1.6 -
                  Math.random(),
                life: 60 + Math.random() * 40,
                age: 0,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: 3 + Math.random() * 4,
              });
            }
          }
          spawnBurst();
          let raf;
          function step() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
              const p = particles[i];
              p.age++;
              p.vy += 0.06;
              p.vx *= 0.996;
              p.vy *= 0.998;
              p.x += p.vx;
              p.y += p.vy;
              ctx.globalAlpha = Math.max(0, 1 - p.age / p.life);
              ctx.fillStyle = p.color;
              ctx.beginPath();
              ctx.ellipse(p.x, p.y, p.size, p.size, 0, 0, Math.PI * 2);
              ctx.fill();
              if (p.age > p.life) particles.splice(i, 1);
            }
            if (Date.now() - now < seconds * 1000) {
              if (Math.random() < 0.05) spawnBurst();
              raf = requestAnimationFrame(step);
            } else {
              cancelAnimationFrame(raf);
              ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
          }
          step();
          return new Promise((r) => setTimeout(r, seconds * 1000 + 80));
        }

        for (const person of todays) {
          const box = document.createElement("div");
          box.className = "bd-popup show shake";
          box.innerHTML = `<h2>Happy Birthday</h2><p style="font-size:1.2rem;font-weight:900">${person.name}</p>`;
          wrap.appendChild(box);
          // show for 2 seconds with particles
          await playParticlesFor(2.0);
          box.remove();
        }
        wrap.style.display = "none";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      /* -------------------------
   Month buttons
   ------------------------- */
      function generateMonthButtons() {
        const container = $("monthButtons");
        if (!container) return;
        const months = new Map();
        EVENTS.forEach((ev) => {
          const s = parseStart(ev.start);
          const key = `${s.getFullYear()}-${pad(s.getMonth() + 1)}`;
          if (!months.has(key))
            months.set(key, {
              label: `${s.toLocaleString("en", {
                month: "short",
              })} ${s.getFullYear()}`,
              month: pad(s.getMonth() + 1),
            });
        });
        container.innerHTML = "";
        Array.from(months.entries())
          .sort()
          .forEach(([k, val]) => {
            const btn = document.createElement("button");
            btn.className = "month-btn";
            btn.textContent = val.label;
            btn.dataset.month = val.month;
            btn.addEventListener("click", () => {
              const mf = $("monthFilter");
              if (!mf) return;
              if (mf.value === val.month) {
                mf.value = "";
                btn.classList.remove("active");
              } else {
                mf.value = val.month;
                highlightMonthButton(val.month);
              }
              renderAll();
            });
            container.appendChild(btn);
          });

        // set current month marker
        highlightMonthButton(pad(new Date().getMonth() + 1), true);
      }
      function highlightMonthButton(month, markCurrent = false) {
        const btns = Array.from(document.querySelectorAll(".month-btn"));
        btns.forEach((b) => {
          b.classList.toggle("active", b.dataset.month === month);
          if (markCurrent)
            b.classList.toggle("current", b.dataset.month === month);
        });
      }

      /* -------------------------
   Accent sampling from hero
   ------------------------- */
      async function sampleAccent() {
        const img = $("heroImg");
        if (!img) return;
        await new Promise((r) => {
          if (img.complete) return r();
          img.addEventListener("load", r, { once: true });
          img.addEventListener("error", r, { once: true });
        });
        try {
          const w = Math.min(img.naturalWidth || 200, 160),
            h = Math.min(img.naturalHeight || 120, 120);
          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0, 0, w, h).data;
          let r = 0,
            g = 0,
            b = 0,
            count = 0;
          for (let i = 0; i < data.length; i += 4) {
            const a = data[i + 3];
            if (a < 80) continue;
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
          }
          if (count === 0) throw new Error("no pixels");
          r = Math.round(r / count);
          g = Math.round(g / count);
          b = Math.round(b / count);
          const rgb = `rgb(${r},${g},${b})`;
          document.documentElement.style.setProperty("--accent", rgb);
          const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
          const accentText = lum > 0.6 ? "#072238" : "#ffffff";
          document.documentElement.style.setProperty(
            "--accent-text",
            accentText
          );
        } catch (e) {
          // fallback to next event month color
          const next = EVENTS.find(
            (ev) =>
              parseEnd(ev.end, parseStart(ev.start)).getTime() >= Date.now()
          );
          if (next) {
            const m = pad(parseStart(next.start).getMonth() + 1);
            const col = MONTH_COLORS[m] || "#ffd24a";
            document.documentElement.style.setProperty("--accent", col);
            document.documentElement.style.setProperty(
              "--accent-text",
              "#072238"
            );
          }
        }
      }

      /* -------------------------
   UI wiring & mode switching
   ------------------------- */
      function applyMode() {
        const gallery = $("gallerySection"),
          stage = $("stage"),
          births = $("birthdaysSection");
        document
          .querySelectorAll(".mode-btn")
          .forEach((b) => b.classList.remove("active"));
        if (mode === "grid") {
          $("gridBtn").classList.add("active");
          gallery.style.display = "none";
          births.style.display = "none";
          stage.style.display = "";
          document.body.classList.remove("present-mode");
        } else if (mode === "museum") {
          $("museumBtn").classList.add("active");
          gallery.style.display = "";
          births.style.display = "none";
          stage.style.display = "none";
          renderGallery();
          document.body.classList.remove("present-mode");
        } else if (mode === "birthdays") {
          $("birthdaysBtn").classList.add("active");
          gallery.style.display = "none";
          births.style.display = "";
          stage.style.display = "none";
          renderBirthdays();
          document.body.classList.remove("present-mode");
        } else if (mode === "present") {
          $("presentBtn").classList.add("active");
          document.documentElement.requestFullscreen?.();
          document.body.classList.add("present-mode");
          gallery.style.display = "none";
          births.style.display = "none";
          stage.style.display = "";
        }
        renderPinnedPanel();
      }

      $("gridBtn").addEventListener("click", () => {
        mode = "grid";
        applyMode();
      });
      $("museumBtn").addEventListener("click", () => {
        mode = "museum";
        applyMode();
      });
      $("birthdaysBtn").addEventListener("click", () => {
        mode = "birthdays";
        applyMode();
      });
      $("presentBtn").addEventListener("click", () => {
        mode = "present";
        applyMode();
      });

      $("searchBox").addEventListener("input", () => renderAll());
      $("monthFilter").addEventListener("change", () => {
        highlightMonthButton($("monthFilter").value);
        renderAll();
      });

      $("bdSearch").addEventListener("input", () => renderBirthdays());
      $("bdMonthFilter").addEventListener("change", () => renderBirthdays());

      $("pinnedToggleBtn").addEventListener("click", () => {
        const p = $("pinnedColumn");
        if (!p) return;
        p.classList.toggle("hidden");
      });
      $("pinCollapseBtn").addEventListener("click", () => {
        const p = $("pinnedColumn");
        if (!p) return;
        p.classList.toggle("hidden");
      });
      $("clearPins").addEventListener("click", () => setPinned([]));
      $("exportPins").addEventListener("click", () => {
        const pins = getPinned();
        const rows = [["name", "start", "end"]];
        for (const i of pins) {
          if (EVENTS[i])
            rows.push([
              EVENTS[i].name,
              EVENTS[i].start || "",
              EVENTS[i].end || "",
            ]);
        }
        const csv = rows
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "pinned-events.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      /* quick keyboard toggles */
      document.addEventListener("keydown", (e) => {
        if (e.key === "p" && !e.metaKey && !e.ctrlKey) {
          const p = $("pinnedColumn");
          if (p) p.classList.toggle("hidden");
        }
        if (e.key === "m" && !e.metaKey && !e.ctrlKey) {
          mode = "museum";
          applyMode();
        }
        if (e.key === "g" && !e.metaKey && !e.ctrlKey) {
          mode = "grid";
          applyMode();
        }
        if (e.key === "b" && !e.metaKey && !e.ctrlKey) {
          mode = "birthdays";
          applyMode();
        }
      });

      /* close lightbox on background click */
      $("lightbox").addEventListener("click", (e) => {
        if (e.target === $("lightbox")) closeLightbox();
      });

      /* clicking outside pinned panel closes it (desktop) */
      document.addEventListener("click", (ev) => {
        const p = $("pinnedColumn");
        if (!p) return;
        if (p.classList.contains("hidden")) return;
        if (window.innerWidth <= 900) return;
        const target = ev.target;
        if (!p.contains(target) && !$("pinnedToggleBtn").contains(target))
          p.classList.add("hidden");
      });

      /* -------------------------
   Init
   ------------------------- */
      async function init() {
        $("heroImg").src = HERO;
        $("heroImg").crossOrigin = "anonymous";
        generateMonthButtons();
        await sampleAccent();
        renderAll();
        renderGallery();
        renderBirthdays();
        runBirthdayPopups();
        // show pinned toggle only if pins exist
        if (getPinned().length > 0) {
          $("pinnedToggleBtn").classList.remove("hidden");
          $("pinnedColumn").classList.remove("hidden");
        }
      }
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
