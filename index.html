<!DOCTYPE html>
<!--
  Maxwell Events — single-file HTML
  Full implementation (Grid, Gallery, Birthdays, Pinned panel, Present mode, hero fixes).
  - Hero uses the WP image you provided and crops top on desktop.
  - Gallery thumbnails are square (aspect-ratio:1/1).
  - Birthdays show sequential popups (2s each) with confetti & shake when it's their day.
  - Pinned panel hides when empty and is toggleable when pins exist.
  - All data is client-side; pins persist to localStorage.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Maxwell Events — 2025–2026</title>
    <style>
      :root {
        --bg: #07131a;
        --card: #ffffff;
        --accent: #ffd24a;
        --accent-dark: #ffb84d;
        --accent-text: #072238;
        --muted: #2a3b57;
        --panel-w: 320px;
        --gap: 16px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background: var(--bg);
        color: #fff;
        -webkit-font-smoothing: antialiased;
      }
      a {
        color: inherit;
      }
      button {
        font-family: inherit;
      }

      /* HERO */
      .hero {
        position: relative;
        max-width: 1200px;
        margin: 18px auto;
        height: 360px;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 14px 60px rgba(0, 0, 0, 0.45);
      }
      .hero img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center top;
        display: block;
        transition: transform 0.6s cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      @media (max-width: 900px) {
        .hero img {
          object-position: center center;
        }
        .hero {
          height: 260px;
        }
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 36%,
          rgba(0, 0, 0, 0.78) 100%
        );
        pointer-events: none;
      }
      .hero-inner {
        position: absolute;
        left: 20px;
        right: 20px;
        bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
        z-index: 2;
      }
      .hero-left {
        max-width: 70%;
      }
      .site-title {
        font-size: 1.6rem;
        margin: 0;
        font-weight: 900;
        letter-spacing: 0.3px;
        text-shadow: 0 6px 24px rgba(0, 0, 0, 0.45);
      }
      .site-sub {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.92);
        margin-top: 6px;
        max-width: 720px;
        line-height: 1.22;
        text-shadow: 0 6px 24px rgba(0, 0, 0, 0.22);
      }

      /* controls */
      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 12px;
        flex-wrap: wrap;
      }
      .search,
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.95);
        color: #072238;
        font-size: 14px;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-dark));
        color: var(--accent-text);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
      }
      .mode-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* month buttons row */
      .month-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }
      .month-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        font-weight: 700;
      }
      .month-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-dark));
        color: var(--accent-text);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.18);
      }

      /* pinned panel */
      .pinned-column {
        position: fixed;
        right: 18px;
        top: 110px;
        width: var(--panel-w);
        max-height: calc(100vh - 140px);
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        background: #fff;
        border-radius: 12px;
        color: #072238;
        box-shadow: 0 28px 80px rgba(2, 8, 23, 0.28);
        z-index: 1200;
        transition: transform 0.24s, opacity 0.24s;
      }
      .pinned-column.hidden {
        transform: translateX(18px);
        opacity: 0;
        pointer-events: none;
      }
      .pinned-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .pinned-empty {
        padding: 12px;
        border-radius: 8px;
        background: rgba(2, 8, 23, 0.03);
        color: #6b7b8d;
        font-weight: 700;
        text-align: center;
      }
      .pinned-chip {
        padding: 10px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid rgba(2, 8, 23, 0.04);
        box-shadow: 0 6px 20px rgba(2, 8, 23, 0.04);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .pin-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pinned-title {
        font-weight: 800;
        color: #072238;
        font-size: 13px;
      }
      .pinned-sub {
        font-size: 12px;
        color: #3d566a;
      }
      .pinned-count {
        font-weight: 800;
        color: var(--accent);
      }
      .pinned-progress {
        height: 6px;
        background: rgba(2, 8, 23, 0.05);
        border-radius: 999px;
        overflow: hidden;
      }
      .pinned-progress > i {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      }

      #pinnedToggle {
        position: fixed;
        right: 18px;
        top: 66%;
        transform: translateY(-50%);
        z-index: 1300;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(180deg, var(--accent), var(--accent-dark));
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.28);
        font-weight: 800;
        cursor: pointer;
      }
      #pinnedToggle.hidden {
        display: none;
      }

      /* layout */
      .wrap {
        max-width: 1200px;
        margin: 18px auto 120px;
        padding: 0 12px;
      }
      .top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
      }
      #pageTitle {
        font-size: 1.2rem;
        color: #fff;
        margin: 0;
      }
      #subtitle {
        color: rgba(255, 255, 255, 0.92);
      }

      .year-progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 12px;
      }
      .year-progress > i {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      }

      /* grid & month headings */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
      }
      .month-heading {
        grid-column: 1/-1;
        padding: 8px 0;
        font-weight: 900;
        color: #fff;
        opacity: 0.95;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      /* card */
      .card {
        position: relative;
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff, #fafafa);
        color: #072238;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 176px;
        box-shadow: 0 12px 40px rgba(2, 8, 23, 0.06);
        transition: transform 0.18s, box-shadow 0.18s;
        overflow: hidden;
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 60px rgba(2, 8, 23, 0.12);
      }
      .month-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
      }
      .pin-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: rgba(7, 18, 43, 0.04);
        cursor: pointer;
      }
      .pin-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-dark));
        color: var(--accent-text);
      }
      .card .title {
        font-weight: 900;
        font-size: 18px;
        color: #072238;
        min-height: 44px;
        line-height: 1.05;
      }
      .meta {
        font-size: 13px;
        color: #27506b;
      }
      .countdown {
        font-weight: 800;
        font-size: 15px;
        color: var(--accent);
      }
      .status {
        font-size: 13px;
        color: #16344f;
        font-weight: 700;
      }
      .date-badge {
        align-self: flex-start;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(7, 18, 43, 0.04);
        font-weight: 800;
      }
      .card.finished {
        opacity: 0.6;
        filter: grayscale(30%);
      }
      .card.happening {
        box-shadow: 0 18px 46px rgba(255, 120, 60, 0.1);
        animation: float 2.4s infinite;
      }
      @keyframes float {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* gallery */
      .gallery-wrap {
        max-width: 1200px;
        margin: 18px auto;
        padding: 0 12px;
      }
      .gallery-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }
      .gallery-thumb {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        background: #ddd;
        display: block;
        aspect-ratio: 1/1;
      }
      .gallery-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.36s;
      }
      .gallery-thumb:hover img {
        transform: scale(1.06);
      }
      .gallery-caption {
        position: absolute;
        left: 8px;
        bottom: 8px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        padding: 6px 8px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 12px;
      }

      /* lightbox */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.88);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1400;
      }
      .lightbox.open {
        display: flex;
      }
      .lightbox img {
        max-width: 92%;
        max-height: 82%;
        object-fit: contain;
        border-radius: 8px;
      }
      .lightbox .caption {
        color: #fff;
        margin-top: 12px;
        font-weight: 700;
      }
      .lightbox .controls {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
      }
      .lightbox button {
        background: rgba(255, 255, 255, 0.06);
        border: none;
        color: #fff;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
      }

      /* birthdays */
      .bd-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .bd-card {
        background: linear-gradient(180deg, #fff, #fbfbfb);
        color: #072238;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(2, 8, 23, 0.06);
      }
      .bd-name {
        font-weight: 900;
      }
      .bd-date {
        font-size: 13px;
        color: #4a6b83;
      }
      .bd-count {
        font-weight: 800;
        color: var(--accent);
        margin-top: 8px;
      }

      /* birthday popup (no opaque overlay - just confetti on top and large text) */
      .bd-popup {
        position: fixed;
        left: 50%;
        top: 30%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .bd-popup .text {
        font-size: 48px;
        font-weight: 900;
        color: #fff;
        text-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
        transform-origin: center;
        animation: bdPop 0.72s cubic-bezier(0.2, 0.9, 0.3, 1);
      }
      @keyframes bdPop {
        0% {
          transform: scale(0.72) translateY(-6px);
        }
        60% {
          transform: scale(1.06) translateY(3px);
        }
        100% {
          transform: scale(1) translateY(0);
        }
      }
      .bd-shake {
        animation: bdShake 0.9s ease-in-out;
      }
      @keyframes bdShake {
        10%,
        90% {
          transform: translateX(-2px);
        }
        20%,
        80% {
          transform: translateX(4px);
        }
        30%,
        50%,
        70% {
          transform: translateX(-6px);
        }
        40%,
        60% {
          transform: translateX(6px);
        }
      }

      /* present mode (slideshow) */
      .present-mode header,
      .present-mode .controls,
      .present-mode .hero-inner,
      .present-mode .month-buttons {
        display: none !important;
      }
      .present-mode body {
        padding: 0;
      }
      .present-mode .wrap {
        margin-top: 18px;
      }

      /* responsive */
      @media (max-width: 900px) {
        .pinned-column {
          right: 12px;
          left: 12px;
          bottom: 18px;
          top: auto;
          display: flex;
          flex-direction: row;
          max-height: 120px;
          padding: 8px;
        }
        #pinnedToggle {
          display: none;
        }
        .hero {
          height: 260px;
        }
        .gallery-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <img
        id="heroImg"
        alt="Maxwell banner"
        src="https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1"
        crossorigin="anonymous"
      />
      <div class="hero-inner">
        <div class="hero-left">
          <h1 class="site-title">Maxwell Events Countdown</h1>
          <div class="site-sub" id="heroSubtitle">2025-2026 schedule</div>

          <div
            class="controls"
            role="region"
            aria-label="Search and view controls"
          >
            <input
              id="searchBox"
              class="search"
              type="search"
              placeholder="Search events..."
              aria-label="Search events"
            />
            <select id="monthFilter" aria-label="Filter by month">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>

            <div
              id="monthButtons"
              class="month-buttons"
              aria-hidden="false"
            ></div>

            <div class="mode-buttons" role="tablist" aria-label="Views">
              <button
                id="gridBtn"
                class="btn primary"
                title="Grid view"
                role="tab"
                aria-selected="true"
              >
                Grid
              </button>
              <button
                id="museumBtn"
                class="btn"
                title="Gallery view"
                role="tab"
                aria-selected="false"
              >
                Gallery
              </button>
              <button
                id="birthBtn"
                class="btn"
                title="Birthdays"
                role="tab"
                aria-selected="false"
              >
                Birthdays
              </button>
              <button id="presentBtn" class="btn" title="Present mode">
                Present
              </button>
            </div>
          </div>
        </div>

        <div style="text-align: right; color: #fff; font-weight: 700">
          Maxwell • 2025–26
        </div>
      </div>
    </section>

    <!-- canvas stars background -->
    <canvas
      id="stars"
      aria-hidden="true"
      style="position: fixed; inset: 0; z-index: -1; pointer-events: none"
    ></canvas>

    <!-- Next up banner -->
    <section
      id="nextUp"
      style="
        display: none;
        max-width: 1200px;
        margin: 12px auto;
        padding: 12px 16px;
        border-left: 6px solid var(--accent);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.95);
        color: #072238;
        box-shadow: 0 8px 30px rgba(2, 8, 23, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      <div>
        <div style="font-weight: 700; color: #0b4b6f">Next Up</div>
        <div class="detail">
          <strong id="nextUpName">—</strong> <span id="nextUpDetail"></span>
        </div>
      </div>
      <div style="text-align: right">
        <div style="font-size: 12px; color: #0b2547">Tip</div>
        <div style="font-size: 12px; color: #07284f">
          Pin events with the 📌 on cards. In Gallery, click to open fullscreen.
        </div>
      </div>
    </section>

    <!-- pinned panel -->
    <aside
      id="pinnedColumn"
      class="pinned-column hidden"
      aria-label="Pinned events"
    >
      <div class="pinned-header">
        <strong style="font-size: 14px">Pinned</strong>
        <div style="display: flex; gap: 6px">
          <button id="exportPins" class="btn" title="Export pinned">
            Export
          </button>
          <button id="clearPins" class="btn" title="Clear pins">Clear</button>
          <button id="hidePins" class="btn" title="Hide panel">Hide</button>
        </div>
      </div>
      <div id="pinnedList"></div>
    </aside>
    <button id="pinnedToggle" class="hidden" title="Open pinned panel">
      📌
    </button>

    <main class="wrap" id="mainWrap">
      <div class="top-row">
        <div>
          <h2 id="pageTitle">School Events Countdown</h2>
          <div id="subtitle">2025-2026 schedule</div>
          <div class="year-progress" aria-hidden="true">
            <i id="yearProgressBar" style="width: 0%"></i>
          </div>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            color: #fff;
            font-weight: 700;
          "
        >
          Maxwell • 2025–26
        </div>
      </div>

      <!-- Gallery -->
      <section
        id="gallerySection"
        class="gallery-wrap"
        style="display: none"
        aria-hidden="true"
      >
        <div class="gallery-controls">
          <div style="display: flex; gap: 8px; align-items: center">
            <button id="galleryAll" class="btn primary">All</button>
            <button id="galleryCampus" class="btn">Campus</button>
          </div>
          <div style="margin-left: auto; color: #fff; font-weight: 700">
            Gallery — square thumbnails
          </div>
        </div>
        <div id="galleryGrid" class="gallery-grid" aria-live="polite"></div>
      </section>

      <!-- Birthdays -->
      <section
        id="birthdaysSection"
        style="display: none; margin-top: 12px"
        aria-hidden="true"
      >
        <h3 style="color: #fff; margin-bottom: 12px">Birthdays — September</h3>
        <div id="bdGrid" class="bd-grid"></div>
      </section>

      <!-- Events Grid -->
      <section id="stage">
        <div id="eventsGrid" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <!-- lightbox -->
    <div
      id="lightbox"
      class="lightbox"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="controls" aria-hidden="false">
        <button id="lbPrev" aria-label="Previous">◀</button>
        <button id="lbNext" aria-label="Next">▶</button>
      </div>
      <div style="text-align: center; max-width: 95%">
        <img id="lbImage" alt="" />
        <div class="caption" id="lbCaption"></div>
        <div style="margin-top: 12px">
          <button id="lbClose" class="btn">Close</button>
        </div>
      </div>
    </div>

    <!-- birthday popup and confetti canvas (no opaque overlay) -->
    <canvas
      id="confettiCanvas"
      style="
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1999;
        display: none;
      "
    ></canvas>
    <div
      id="bdPopup"
      class="bd-popup"
      style="display: none; z-index: 2000; pointer-events: none"
    >
      <div id="bdPopupText" class="text"></div>
    </div>

    <script>
      /* ----------------------
   Data (events + galleries + birthdays)
   ---------------------- */
      const HERO =
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1";

      const EVENTS = [
        { name: "Summer Holiday", start: "2025-08-01", end: "2025-08-09" },
        {
          name: "School Opening (Arrival & Dorm Move-in)",
          start: "2025-08-10",
          end: "2025-08-11",
        },
        { name: "First Semester Registration", start: "2025-08-11" },
        { name: "Orientation", start: "2025-08-12" },
        { name: "Faculty Family", start: "2025-09-07" },
        { name: "Picture Day", start: "2025-09-09" },
        { name: "Open Weekend", start: "2025-09-12", end: "2025-09-14" },
        { name: "Week of Prayer", start: "2025-09-15", end: "2025-09-20" },
        { name: "Camping Trip", start: "2025-09-21", end: "2025-09-23" },
        { name: "Online Parent-Teacher Conferences", start: "2025-09-30" },
        { name: "Midterm Break", start: "2025-10-09", end: "2025-10-20" },
        { name: "Music Sabbath", start: "2025-10-25" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2025-11-07",
          end: "2025-11-08",
        },
        { name: "MAP Testing", start: "2025-11-24", end: "2025-11-27" },
        { name: "Faculty Family", start: "2025-11-14" },
        { name: "Finals Review Week", start: "2025-12-01", end: "2025-12-05" },
        { name: "Final Exams 1st Sem", start: "2025-12-08", end: "2025-12-10" },
        { name: "Christmas Break", start: "2025-12-10", end: "2026-01-05" },
        { name: "School Opening (2nd Sem)", start: "2026-01-05" },
        {
          name: "Senior Government Day",
          start: "2026-01-20",
          end: "2026-01-21",
        },
        { name: "Faculty Family", start: "2026-01-30" },
        { name: "Junior Vespers", start: "2026-02-06" },
        { name: "NHS Applications Deadline", start: "2026-02-10" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2026-02-13",
          end: "2026-02-14",
        },
        { name: "ACT", start: "2026-02-13" },
        { name: "NHS Induction", start: "2026-02-17" },
        { name: "Mt. Kenya Trip", start: "2026-02-20", end: "2026-02-24" },
        { name: "Senior Dedication", start: "2026-02-27" },
        { name: "Sophomore Vespers", start: "2026-03-06" },
        {
          name: "Student-Led Week of Prayer",
          start: "2026-03-09",
          end: "2026-03-14",
        },
        { name: "Track and Field", start: "2026-03-19", end: "2026-03-20" },
        { name: "Chorale Sacred Concert", start: "2026-03-21" },
        { name: "Senior Class Trip", start: "2026-03-23", end: "2026-03-26" },
        { name: "Midterm Break", start: "2026-03-26", end: "2026-04-06" },
        {
          name: "Ethiopia Mission Trip",
          start: "2026-03-26",
          end: "2026-04-05",
        },
        { name: "ACT", start: "2026-04-10" },
        { name: "Freshmen Vespers", start: "2026-04-17" },
        { name: "Faculty Family", start: "2026-04-19" },
        { name: "Week of Prayer", start: "2026-04-20", end: "2026-04-25" },
        { name: "Long Weekend", start: "2026-04-30", end: "2026-05-03" },
        { name: "ASB Spirit Week", start: "2026-05-04", end: "2026-05-09" },
        { name: "Class Surveys", start: "2026-05-11", end: "2026-05-13" },
        { name: "ASB Elections", start: "2026-05-12" },
        { name: "Spring Concert", start: "2026-05-16" },
        { name: "MAP Testing", start: "2026-05-18", end: "2026-05-21" },
        { name: "Dorm Parties", start: "2026-05-23" },
        { name: "Dorm Outings", start: "2026-05-24" },
        { name: "Finals Review Week", start: "2026-05-25", end: "2026-05-29" },
        { name: "Zamani Night", start: "2026-05-30" },
        { name: "Elementary Graduation", start: "2026-05-31" },
        { name: "Final Exams 2nd Sem", start: "2026-06-02", end: "2026-06-04" },
        { name: "GRADDDDD!!!!", start: "2026-06-05", end: "2026-06-07" },
      ];

      const MONTH_COLORS = {
        "01": "#e74c3c",
        "02": "#ff8a65",
        "03": "#f6c85f",
        "04": "#8dd3c7",
        "05": "#66a3ff",
        "06": "#9b59b6",
        "07": "#f06292",
        "08": "#ffb84d",
        "09": "#6ab04c",
        10: "#4a90e2",
        11: "#34495e",
        12: "#7bdbdb",
      };

      /* museum photos (general) */
      const MUSEUM_PHOTOS = [
        { src: HERO, caption: "Campus View", month: "08", year: 2025 },
        {
          src: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1600&q=80&auto=format&fit=crop",
          caption: "Forest Path",
          month: "09",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1600&q=80&auto=format&fit=crop",
          caption: "Lake at Dawn",
          month: "10",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1503264116251-35a269479413?w=1600&q=80&auto=format&fit=crop",
          caption: "Foggy Ridge",
          month: "12",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1600&q=80&auto=format&fit=crop",
          caption: "Mountain Trail",
          month: "03",
          year: 2026,
        },
        {
          src: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=1600&q=80&auto=format&fit=crop",
          caption: "Sunset Camp",
          month: "05",
          year: 2026,
        },
      ];

      /* campus photos (replacements you requested) */
      const CAMPUS_PHOTOS = [
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmV27Af6dGvJoR-LVUGmkCauwQepWKLwi7Zw&s",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHDr-_KeMgIf8tN3PHxytKFN7lbUhaLuPpkQ&s",
        "https://static.wixstatic.com/media/b62f56_ce88667acf42430fbea4c12175730dd3.jpg/v1/fill/w_960,h_640,al_c,q_85,enc_avif,quality_auto/b62f56_ce88667acf42430fbea4c12175730dd3.jpg",
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/03/EsoPheb.jpeg?fit=1400%2C1400&ssl=1",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwjR3VnDRD6LdSrblZYVliJaRRigcs-tRg1A&s",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_UAdf79fDLKoBvHdkMag3M7D2yQ_LqeaMfEHAc2SL3tjaM2YgYv7lnp03azSa0QtDdfs&usqp=CAU",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRSf7j4BoCP9Y4wsnOAPCmjaGtQ--w7biBxRWvnQXHA2_Jo0WCWdGmEeX5rB87zfhaWHQo&usqp=CAU",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQF4CttDiXRUIEdVk0US158Ob3-siokVF2RSppthCTBNSNtkbNshzNTVMTK0UxNVIqfpVc&usqp=CAU",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTLWlAao-P3ibqUPD9n0AmP5nHL0BzwrYsPMRD7yNfh0To0pjm4gfLZkDMCY2OoesrqEXo&usqp=CAU",
      ];

      /* birthdays (September only as requested) — note: removed comma for 'Arcella Ineza' */
      const BIRTHDAYS = [
        { name: "Tereza Poniatovska", month: 9, day: 11 },
        { name: "Tendai Castroe", month: 9, day: 20 },
        { name: "Arcella Ineza", month: 9, day: 25 },
        { name: "Salome Lwanzo", month: 9, day: 25 },
        { name: "Adrian Ochieng", month: 9, day: 2 },
        { name: "Julian Tito Omonte", month: 9, day: 25 },
        { name: "Jael Tito Omonte", month: 9, day: 25 },
        { name: "Ethan Wenyika", month: 9, day: 4 },
        { name: "Michael Nyange", month: 9, day: 14 },
        { name: "Daniela", month: 9, day: 17 },
        { name: "Daniel", month: 9, day: 17 },
        { name: "Kris Koome", month: 9, day: 6 },
        { name: "Betty Kamawu", month: 9, day: 24 },
      ];

      /* ----------------------
   Helpers
   ---------------------- */
      const $ = (id) => document.getElementById(id);
      const pad = (n) => (n < 10 ? "0" + n : String(n));
      const parseStart = (s) =>
        s.includes("T") ? new Date(s) : new Date(s + "T00:00:00");
      const parseEnd = (e, start) => {
        if (!e) {
          const d = new Date(start);
          d.setHours(23, 59, 59, 999);
          return d;
        }
        return e.includes("T") ? new Date(e) : new Date(e + "T23:59:59.999");
      };
      const formatISO = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      function slugify(name, idx) {
        return (
          String(name)
            .toLowerCase()
            .replace(/[’'"]/g, "")
            .replace(/[:\/\\(),.!?#\u2013\u2014]/g, "")
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "") +
          "-" +
          idx
        );
      }
      function eventIcon(name) {
        const n = name.toLowerCase();
        if (/exam|final|midterm|test|act|map/.test(n)) return "📝";
        if (
          /break|holiday|christmas|spring|long weekend|summer|vacation/.test(n)
        )
          return "🎉";
        if (/trip|camp|mt|mountain|mission/.test(n)) return "🏕️";
        if (/concert|chorale|music/.test(n)) return "🎵";
        if (/sports|track|field/.test(n)) return "🏅";
        return "📅";
      }

      /* ----------------------
   State + storage
   ---------------------- */
      let items = [],
        tickHandle = null;
      let mode = "grid"; // 'grid', 'museum', 'birthdays'
      const STORAGE_PIN = "maxwell_pins_v3";
      const STORAGE_POS = "maxwell_positions_v3";
      const PIN_LIMIT = 12;

      function getPinned() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_PIN) || "[]");
        } catch (e) {
          return [];
        }
      }
      function setPinned(arr) {
        localStorage.setItem(STORAGE_PIN, JSON.stringify(arr));
        renderPinnedPanel();
      }
      function isPinned(i) {
        return getPinned().includes(i);
      }
      function togglePin(i) {
        const arr = getPinned();
        const p = arr.indexOf(i);
        if (p === -1) {
          arr.unshift(i);
          while (arr.length > 100) arr.pop();
        } else arr.splice(p, 1);
        setPinned(arr);
      }
      function savePos(id, x, y) {
        try {
          const s = JSON.parse(localStorage.getItem(STORAGE_POS) || "{}");
          s[id] = { x, y, at: Date.now() };
          localStorage.setItem(STORAGE_POS, JSON.stringify(s));
        } catch (e) {}
      }

      /* ----------------------
   Starfield background
   ---------------------- */
      (function initStars() {
        const canvas = $("stars");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        function resize() {
          canvas.width = innerWidth;
          canvas.height = innerHeight;
        }
        window.addEventListener("resize", resize);
        resize();
        const stars = Array.from({ length: 120 }, () => ({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 1.6 + 0.2,
          dy: Math.random() * 0.5 + 0.02,
          a: 0.2 + Math.random() * 0.6,
        }));
        function frame() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (const s of stars) {
            ctx.globalAlpha =
              s.a * (0.7 + Math.sin(Date.now() / 1000 + s.x) * 0.3);
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            s.y += s.dy;
            if (s.y > canvas.height + 10) {
              s.y = -10;
              s.x = Math.random() * canvas.width;
            }
          }
          requestAnimationFrame(frame);
        }
        frame();
      })();

      /* ----------------------
   Render events grid
   ---------------------- */
      function sortEvents() {
        EVENTS.sort((a, b) => parseStart(a.start) - parseStart(b.start));
      }
      function findNext() {
        const now = Date.now();
        return (
          EVENTS.find(
            (ev) => parseEnd(ev.end, parseStart(ev.start)).getTime() >= now
          ) || null
        );
      }
      function renderNextUp() {
        const n = findNext();
        const el = $("nextUp");
        if (!el) return;
        if (!n) {
          el.style.display = "none";
          return;
        }
        el.style.display = "flex";
        $("nextUpName").textContent = n.name;
        $("nextUpDetail").textContent = n.end
          ? `From ${formatISO(parseStart(n.start))} → ${formatISO(
              parseStart(n.end)
            )}`
          : `On ${formatISO(parseStart(n.start))}`;
      }
      function updateOne(item, now) {
        const { id, start, end, el } = item;
        const cd = document.getElementById("cd-" + id),
          st = document.getElementById("st-" + id);
        if (!cd || !st) return;
        if (now.getTime() < start.getTime()) {
          el.classList.remove("happening", "finished");
          el.classList.add("upcoming");
          const diff = start.getTime() - now.getTime(),
            d = Math.floor(diff / 86400000),
            h = Math.floor((diff % 86400000) / 3600000),
            m = Math.floor((diff % 3600000) / 60000),
            s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s left`;
          st.textContent = "⏳ Coming soon";
        } else if (now.getTime() > end.getTime()) {
          el.classList.remove("upcoming", "happening");
          el.classList.add("finished");
          cd.textContent = `Ended on ${formatISO(end)}`;
          st.textContent = "✅ Finished";
        } else {
          el.classList.remove("upcoming", "finished");
          el.classList.add("happening");
          const diff = end.getTime() - now.getTime(),
            d = Math.floor(diff / 86400000),
            h = Math.floor((diff % 86400000) / 3600000),
            m = Math.floor((diff % 3600000) / 60000),
            s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s remaining`;
          st.textContent = "🔴 Happening now";
        }
      }

      function renderAll() {
        if (tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
        items = [];
        const grid = $("eventsGrid");
        if (!grid) return;
        grid.innerHTML = "";
        sortEvents();
        renderNextUp();
        const q = ($("searchBox").value || "").toLowerCase();
        const month = $("monthFilter").value || "";
        let curGroup = "";
        EVENTS.forEach((ev, idx) => {
          if (q && !ev.name.toLowerCase().includes(q)) return;
          if (month && ev.start.slice(5, 7) !== month) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          const groupKey = `${start.getFullYear()}-${pad(
            start.getMonth() + 1
          )}`;
          if (groupKey !== curGroup) {
            curGroup = groupKey;
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${start.toLocaleString("en", {
              month: "long",
            })} ${start.getFullYear()}`;
            heading.dataset.mm = pad(start.getMonth() + 1);
            heading.addEventListener("click", () => {
              $("monthFilter").value = heading.dataset.mm;
              highlightMonthButton(heading.dataset.mm);
              renderAll();
            });
            grid.appendChild(heading);
          }

          const id = slugify(ev.name, idx);
          const monthColor = MONTH_COLORS[pad(start.getMonth() + 1)] || "#ccc";
          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("data-idx", idx);
          card.setAttribute("data-id", id);
          card.innerHTML = `
      <div class="month-strip" style="background:${monthColor}"></div>
      <button class="pin-btn" title="Pin event" aria-label="Pin event" data-idx="${idx}">📌</button>
      <div class="title">${ev.name}</div>
      <div class="meta">${eventIcon(ev.name)} ${
            ev.end
              ? `${formatISO(start)} → ${formatISO(parseStart(ev.end))}`
              : formatISO(start)
          }</div>
      <div class="countdown" id="cd-${id}">—</div>
      <div class="status" id="st-${id}">—</div>
      <div class="date-badge">${formatDateBadge(ev.start, ev.end)}</div>
    `;
          grid.appendChild(card);

          items.push({ id, name: ev.name, start, end, el: card, idx });

          // pin button wiring
          const pb = card.querySelector(".pin-btn");
          if (pb) {
            const refresh = () => pb.classList.toggle("active", isPinned(idx));
            pb.addEventListener("click", (e) => {
              e.stopPropagation();
              togglePin(idx);
              refresh();
            });
            refresh();
          }

          // keyboard focus highlight
          card.tabIndex = 0;
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") card.click();
          });

          // simple swipe-to-pin on touch
          addSwipeToPin(card, idx);
        });

        tickHandle = setInterval(() => {
          const now = new Date();
          items.forEach((i) => updateOne(i, now));
          updatePinnedCounts(now);
        }, 1000);
        items.forEach((i) => updateOne(i, new Date()));
        renderPinnedPanel();
        updateYearProgress();
        applyMode();
      }

      /* helper: nice date badge formatting */
      function formatDateBadge(startISO, endISO) {
        const s = parseStart(startISO),
          e = endISO ? parseStart(endISO) : null;
        const short = (d) => d.toLocaleString("en", { month: "short" });
        if (!e) return `${short(s)} ${s.getDate()}`;
        if (
          s.getFullYear() === e.getFullYear() &&
          s.getMonth() === e.getMonth()
        )
          return `${short(s)} ${s.getDate()}–${e.getDate()}`;
        return `${short(s)} ${s.getDate()} – ${short(e)} ${e.getDate()}`;
      }

      /* ----------------------
   Pinned panel
   ---------------------- */
      function renderPinnedPanel() {
        const container = $("pinnedColumn");
        if (!container) return;
        const list = $("pinnedList");
        list.innerHTML = "";
        const pins = getPinned();
        if (!pins || pins.length === 0) {
          container.classList.add("hidden");
          $("pinnedToggle").classList.add("hidden");
          const empty = document.createElement("div");
          empty.className = "pinned-empty";
          empty.textContent =
            "No pinned events yet — pin a card to see it here.";
          list.appendChild(empty);
          return;
        }
        container.classList.remove("hidden");
        $("pinnedToggle").classList.remove("hidden");
        // create chips (user pins first, then upcoming auto-fill)
        const now = new Date();
        const mapped = EVENTS.map((ev, i) => ({
          ev,
          i,
          start: parseStart(ev.start),
          end: parseEnd(ev.end, parseStart(ev.start)),
        }));
        const upcoming = mapped
          .filter((o) => o.end.getTime() >= now.getTime())
          .sort((a, b) => a.start - b.start);
        const finalPins = [];
        const pinnedSet = new Set(pins);
        for (const p of pins) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (EVENTS[p])
            finalPins.push({
              ev: EVENTS[p],
              idx: p,
              start: parseStart(EVENTS[p].start),
              end: parseEnd(EVENTS[p].end, parseStart(EVENTS[p].start)),
            });
        }
        for (const u of upcoming) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (pinnedSet.has(u.idx)) continue;
          finalPins.push(u);
        }

        finalPins.forEach((o) => {
          const id = "pin_" + slugify(o.ev.name + "-" + o.idx, o.idx);
          const chip = document.createElement("button");
          chip.className = "pinned-chip";
          chip.id = id;
          chip.dataset.eventIndex = String(o.idx);
          chip.innerHTML = `
      <div class="pin-row">
        <div style="min-width:0">
          <div class="pinned-title">${o.ev.name}</div>
          <div class="pinned-sub">${
            o.ev.end
              ? formatISO(o.start) + " → " + formatISO(parseStart(o.ev.end))
              : formatISO(o.start)
          }</div>
        </div>
        <div style="text-align:right"><div class="pinned-count" id="count-${id}">—</div></div>
      </div>
      <div class="pinned-progress"><i style="width:0%"></i></div>
    `;
          chip.addEventListener("click", () => {
            const idx = Number(chip.dataset.eventIndex);
            const target = items.find((it) => it.idx === idx);
            if (target && target.el) {
              target.el.scrollIntoView({ behavior: "smooth", block: "center" });
              target.el.style.boxShadow = "0 20px 60px rgba(255,180,60,0.28)";
              target.el.style.transform = "translateY(-8px)";
              setTimeout(() => {
                target.el.style.boxShadow = "";
                target.el.style.transform = "";
              }, 1200);
            }
          });
          // drag reorder
          chip.setAttribute("draggable", "true");
          chip.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", String(o.idx));
            chip.classList.add("dragging");
          });
          chip.addEventListener("dragend", (e) =>
            chip.classList.remove("dragging")
          );
          chip.addEventListener("dragover", (e) => {
            e.preventDefault();
            const dragging = container.querySelector(".dragging");
            if (!dragging || dragging === chip) return;
            const draggingIdx = Number(dragging.dataset.eventIndex);
            const targetIdx = Number(chip.dataset.eventIndex);
            const pinsArr = getPinned();
            const from = pinsArr.indexOf(draggingIdx);
            const to = pinsArr.indexOf(targetIdx);
            if (from > -1 && to > -1 && from !== to) {
              pinsArr.splice(from, 1);
              pinsArr.splice(to, 0, draggingIdx);
              setPinned(pinsArr);
            }
          });
          list.appendChild(chip);
        });
      }

      /* pinned counts update */
      function updatePinnedCounts(now) {
        if (!now) now = new Date();
        const container = $("pinnedColumn");
        if (!container) return;
        const chips = Array.from(container.querySelectorAll(".pinned-chip"));
        chips.forEach((chip) => {
          const idx = Number(chip.dataset.eventIndex);
          const ev = EVENTS[idx];
          if (!ev) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          let txt = "";
          let pct = 0;
          if (now.getTime() < start.getTime()) {
            const diff = start.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s left`;
            pct = 0;
          } else if (now.getTime() > end.getTime()) {
            const diff = now.getTime() - end.getTime();
            const d = Math.floor(diff / 86400000);
            txt = `Ended ${d}d ago`;
            pct = 100;
          } else {
            const total = end.getTime() - start.getTime();
            const remaining = end.getTime() - now.getTime();
            const passed = total - remaining;
            pct = Math.max(
              0,
              Math.min(100, Math.round((passed / total) * 100))
            );
            const diff = remaining;
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s remaining`;
          }
          const countEl = chip.querySelector(`#count-${chip.id}`);
          const prog = chip.querySelector(".pinned-progress i");
          if (countEl) countEl.textContent = txt;
          if (prog) prog.style.width = pct + "%";
        });
      }

      /* ----------------------
   swipe to pin helper
   ---------------------- */
      function addSwipeToPin(card, idx) {
        let down = false,
          sx = 0,
          sy = 0,
          moved = false;
        function pointerdown(e) {
          down = true;
          sx = e.clientX;
          sy = e.clientY;
          moved = false;
        }
        function pointermove(e) {
          if (!down) return;
          const dx = e.clientX - sx,
            dy = e.clientY - sy;
          if (Math.abs(dx) > 8 && Math.abs(dx) > Math.abs(dy)) moved = true;
          if (moved)
            card.style.transform = `translateX(${Math.min(
              Math.max(dx, -60),
              60
            )}px)`;
        }
        function pointerup(e) {
          if (!down) return;
          down = false;
          if (moved) {
            const dx = e.clientX - sx;
            if (dx > 60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.add("active");
            } else if (dx < -60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.remove("active");
            }
            card.style.transform = "";
          }
        }
        card.addEventListener("pointerdown", pointerdown);
        card.addEventListener("pointermove", pointermove);
        card.addEventListener("pointerup", pointerup);
        card.addEventListener("pointercancel", pointerup);
      }

      /* ----------------------
   Gallery (square thumbnails) + lightbox
   ---------------------- */
      let galleryMode = "all"; // 'all' or 'campus'
      function renderGallery() {
        const grid = $("galleryGrid");
        if (!grid) return;
        grid.innerHTML = "";
        const monthFilter = $("monthFilter").value || "";
        // build photos list depending on mode
        let photos = [];
        if (galleryMode === "campus") {
          photos = CAMPUS_PHOTOS.map((src, i) => ({
            src,
            caption: `Campus ${i + 1}`,
            month: "08",
            year: 2025,
          }));
        } else {
          photos = MUSEUM_PHOTOS.slice(); // includes campus-like hero
          // mix in campus photos too in "all"
          CAMPUS_PHOTOS.forEach((s, i) =>
            photos.push({
              src: s,
              caption: `Campus ${i + 1}`,
              month: "08",
              year: 2025,
            })
          );
        }
        photos.forEach((p, i) => {
          if (monthFilter && String(p.month) !== monthFilter) return;
          const t = document.createElement("button");
          t.className = "gallery-thumb";
          t.setAttribute("aria-label", p.caption);
          t.innerHTML = `<img src="${p.src}" alt="${p.caption}"><div class="gallery-caption">${p.caption}</div>`;
          t.addEventListener("click", () => openLightbox(photos, i));
          grid.appendChild(t);
        });
      }

      /* lightbox */
      let lbPhotos = [],
        lbIndex = 0;
      function openLightbox(photos, index) {
        lbPhotos = photos;
        lbIndex = index;
        const light = $("lightbox");
        $("lbImage").src = photos[index].src;
        $("lbCaption").textContent = photos[index].caption;
        light.classList.add("open");
        light.setAttribute("aria-hidden", "false");
      }
      function closeLightbox() {
        const light = $("lightbox");
        light.classList.remove("open");
        light.setAttribute("aria-hidden", "true");
      }
      function lbNext() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex + 1) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }
      function lbPrev() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex - 1 + lbPhotos.length) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }

      /* ----------------------
   Birthdays rendering & popup confetti
   ---------------------- */
      function renderBirthdays() {
        const grid = $("bdGrid");
        if (!grid) return;
        grid.innerHTML = "";
        const now = new Date();
        const year = now.getFullYear();
        BIRTHDAYS.forEach((b) => {
          const card = document.createElement("div");
          card.className = "bd-card";
          const name = document.createElement("div");
          name.className = "bd-name";
          name.textContent = b.name;
          const date = document.createElement("div");
          date.className = "bd-date";
          date.textContent = `${new Date(
            year,
            b.month - 1,
            b.day
          ).toLocaleString("en", { month: "short" })} ${b.day}`;
          const nextOcc = getNextBirthdayDate(b); // returns Date
          const delta = nextOcc.getTime() - now.getTime();
          let countText = "";
          if (isSameMonthDay(now, nextOcc)) {
            countText = "Today — 🎉 Happy Birthday!";
          } else {
            if (delta > 0) {
              const d = Math.floor(delta / 86400000),
                h = Math.floor((delta % 86400000) / 3600000);
              countText = `in ${d}d ${h}h`;
            } else {
              const passed = Math.abs(delta);
              const d = Math.floor(passed / 86400000);
              countText = `${d}d ago`;
            }
          }
          const count = document.createElement("div");
          count.className = "bd-count";
          count.textContent = countText;
          card.appendChild(name);
          card.appendChild(date);
          card.appendChild(count);
          grid.appendChild(card);
        });
      }

      /* compute next birthday date (this year or next) */
      function getNextBirthdayDate(b) {
        const now = new Date();
        const thisYear = now.getFullYear();
        let candidate = new Date(thisYear, b.month - 1, b.day, 12, 0, 0);
        if (
          candidate.getTime() < now.getTime() &&
          !isSameMonthDay(now, candidate)
        ) {
          candidate = new Date(thisYear + 1, b.month - 1, b.day, 12, 0, 0);
        }
        return candidate;
      }
      function isSameMonthDay(a, b) {
        return a.getDate() === b.getDate() && a.getMonth() === b.getMonth();
      }

      /* birthday popup sequence: show each name with confetti and shake for 2s */
      async function runBirthdayPopupsIfAny() {
        const today = new Date(),
          m = today.getMonth() + 1,
          d = today.getDate();
        const todays = BIRTHDAYS.filter((b) => b.month === m && b.day === d);
        if (!todays || todays.length === 0) return;
        // Show sequential 2s popups
        for (const b of todays) {
          await showBirthdayPopup(b.name, 2000);
          await new Promise((r) => setTimeout(r, 250)); // small gap between popups
        }
      }

      /* popup UI + confetti animation */
      function showBirthdayPopup(name, ms = 2000) {
        return new Promise((resolve) => {
          const popup = $("bdPopup"),
            text = $("bdPopupText"),
            canvas = $("confettiCanvas");
          text.textContent = `🎉 Happy Birthday ${name} 🎉`;
          popup.style.display = "flex";
          popup.classList.add("bd-shake");
          // show confetti canvas
          canvas.style.display = "block";
          canvas.width = innerWidth;
          canvas.height = innerHeight;
          // start confetti
          const confetti = startConfetti(canvas, 120);
          // animation
          setTimeout(() => {
            // stop confetti and hide text
            confetti.stop();
            popup.style.display = "none";
            popup.classList.remove("bd-shake");
            canvas.style.display = "none";
            resolve();
          }, ms);
        });
      }

      /* simple confetti particle system */
      function startConfetti(canvas, count = 80) {
        const ctx = canvas.getContext("2d");
        let active = true;
        const colors = [
          "#ffd24a",
          "#ff8a65",
          "#66a3ff",
          "#7bdbdb",
          "#9b59b6",
          "#6ab04c",
          "#ffb84d",
        ];
        const w = () => (canvas.width = window.innerWidth);
        const h = () => (canvas.height = window.innerHeight);
        w();
        h();
        window.addEventListener("resize", () => {
          w();
          h();
        });
        const pieces = [];
        for (let i = 0; i < count; i++) {
          pieces.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height * 0.6,
            vx: (Math.random() - 0.5) * 6,
            vy: Math.random() * 4 + 2,
            r: Math.random() * 6 + 4,
            col: colors[Math.floor(Math.random() * colors.length)],
            rot: Math.random() * 360,
            speed: Math.random() * 0.02 + 0.01,
          });
        }
        let raf;
        function tick() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (const p of pieces) {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.08;
            p.rot += p.speed * 20;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rot * Math.PI) / 180);
            ctx.fillStyle = p.col;
            ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 0.6);
            ctx.restore();
          }
          raf = requestAnimationFrame(tick);
        }
        tick();
        return {
          stop() {
            active = false;
            cancelAnimationFrame(raf);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.display = "none";
          },
        };
      }

      /* ----------------------
   Month buttons generation
   ---------------------- */
      function generateMonthButtons() {
        const container = $("monthButtons");
        if (!container) return;
        const months = new Map();
        EVENTS.forEach((ev) => {
          const s = parseStart(ev.start);
          const key = `${s.getFullYear()}-${pad(s.getMonth() + 1)}`;
          if (!months.has(key))
            months.set(key, {
              label: `${s.toLocaleString("en", {
                month: "short",
              })} ${s.getFullYear()}`,
              month: pad(s.getMonth() + 1),
            });
        });
        container.innerHTML = "";
        Array.from(months.entries())
          .sort()
          .forEach(([k, v]) => {
            const b = document.createElement("button");
            b.className = "month-btn";
            b.textContent = v.label;
            b.dataset.month = v.month;
            b.addEventListener("click", () => {
              const mf = $("monthFilter");
              if (mf.value === v.month) {
                mf.value = "";
                b.classList.remove("active");
              } else {
                mf.value = v.month;
                highlightMonthButton(v.month);
              }
              renderAll();
            });
            container.appendChild(b);
          });
      }
      function highlightMonthButton(month) {
        const btns = document.querySelectorAll(".month-btn");
        btns.forEach((b) =>
          b.classList.toggle("active", b.dataset.month === month)
        );
      }

      /* ----------------------
   Year progress
   ---------------------- */
      function updateYearProgress() {
        if (EVENTS.length === 0) return;
        const start = parseStart(EVENTS[0].start);
        const last = EVENTS[EVENTS.length - 1];
        const end = parseEnd(last.end, parseStart(last.start));
        const now = new Date();
        const total = end.getTime() - start.getTime();
        const passed = Math.max(
          0,
          Math.min(total, now.getTime() - start.getTime())
        );
        const pct = Math.round((passed / total) * 100);
        $("yearProgressBar").style.width = pct + "%";
      }

      /* ----------------------
   Accent sampling (hero)
   ---------------------- */
      async function sampleAccent() {
        const img = $("heroImg");
        if (!img) return;
        await new Promise((r) => {
          if (img.complete) return r();
          img.addEventListener("load", r);
          img.addEventListener("error", r);
        });
        try {
          const w = Math.min(img.naturalWidth || 200, 160),
            h = Math.min(img.naturalHeight || 120, 120);
          const c = document.createElement("canvas");
          c.width = w;
          c.height = h;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const d = ctx.getImageData(0, 0, w, h).data;
          let r = 0,
            g = 0,
            b = 0,
            count = 0;
          for (let i = 0; i < d.length; i += 4) {
            const a = d[i + 3];
            if (a < 80) continue;
            r += d[i];
            g += d[i + 1];
            b += d[i + 2];
            count++;
          }
          if (count === 0) throw new Error("no pixels");
          r = Math.round(r / count);
          g = Math.round(g / count);
          b = Math.round(b / count);
          const rgb = `rgb(${r},${g},${b})`;
          document.documentElement.style.setProperty("--accent", rgb);
          const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
          document.documentElement.style.setProperty(
            "--accent-text",
            lum > 0.6 ? "#072238" : "#fff"
          );
        } catch (e) {
          const next = findNext();
          if (next) {
            const m = pad(parseStart(next.start).getMonth() + 1);
            const col = MONTH_COLORS[m] || "#ffd24a";
            document.documentElement.style.setProperty("--accent", col);
            document.documentElement.style.setProperty(
              "--accent-text",
              "#072238"
            );
          }
        }
      }

      /* ----------------------
   Mode switching & present mode
   ---------------------- */
      function applyMode() {
        const gridSection = $("stage"),
          gallery = $("gallerySection"),
          birthdays = $("birthdaysSection");
        if (mode === "museum") {
          gallery.style.display = "";
          gallery.setAttribute("aria-hidden", "false");
          gridSection.style.display = "none";
          birthdays.style.display = "none";
          $("museumBtn").classList.add("primary");
          $("gridBtn").classList.remove("primary");
          $("birthBtn").classList.remove("primary");
          renderGallery();
        } else if (mode === "birthdays") {
          gallery.style.display = "none";
          gridSection.style.display = "none";
          birthdays.style.display = "";
          $("birthBtn").classList.add("primary");
          $("museumBtn").classList.remove("primary");
          $("gridBtn").classList.remove("primary");
        } else {
          gallery.style.display = "none";
          gridSection.style.display = "";
          birthdays.style.display = "none";
          $("gridBtn").classList.add("primary");
          $("museumBtn").classList.remove("primary");
          $("birthBtn").classList.remove("primary");
        }
      }

      /* present mode (fullscreen-ish) */
      function enterPresent() {
        document.documentElement.requestFullscreen?.().catch(() => {});
        document.body.classList.add("present-mode");
      }
      function exitPresent() {
        document.exitFullscreen?.().catch(() => {});
        document.body.classList.remove("present-mode");
      }

      /* ----------------------
   Wiring UI
   ---------------------- */
      function wireUI() {
        // hero image
        $("heroImg").crossOrigin = "anonymous";

        // buttons
        $("gridBtn").addEventListener("click", () => {
          mode = "grid";
          applyMode();
        });
        $("museumBtn").addEventListener("click", () => {
          mode = "museum";
          applyMode();
        });
        $("birthBtn").addEventListener("click", () => {
          mode = "birthdays";
          applyMode();
        });
        $("presentBtn").addEventListener("click", () => enterPresent());

        // gallery toggles
        $("galleryAll").addEventListener("click", () => {
          galleryMode = "all";
          $("galleryAll").classList.add("primary");
          $("galleryCampus").classList.remove("primary");
          renderGallery();
        });
        $("galleryCampus").addEventListener("click", () => {
          galleryMode = "campus";
          $("galleryCampus").classList.add("primary");
          $("galleryAll").classList.remove("primary");
          renderGallery();
        });

        // search / filter
        $("searchBox").addEventListener("input", () => renderAll());
        $("monthFilter").addEventListener("change", () => {
          highlightMonthButton($("monthFilter").value);
          renderAll();
          renderGallery();
          renderBirthdays();
        });

        // pinned toggles
        $("pinnedToggle").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (!p) return;
          p.classList.toggle("hidden");
        });
        $("hidePins").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (!p) return;
          p.classList.add("hidden");
        });
        $("clearPins").addEventListener("click", () => setPinned([]));
        $("exportPins").addEventListener("click", () => {
          const pins = getPinned();
          const rows = [["name", "start", "end"]];
          for (const i of pins) {
            if (EVENTS[i])
              rows.push([
                EVENTS[i].name,
                EVENTS[i].start || "",
                EVENTS[i].end || "",
              ]);
          }
          const csv = rows
            .map((r) =>
              r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
            )
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "pinned-events.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        // lightbox wiring
        $("lbClose").addEventListener("click", closeLightbox);
        $("lbNext").addEventListener("click", lbNext);
        $("lbPrev").addEventListener("click", lbPrev);
        $("lightbox").addEventListener("click", (e) => {
          if (e.target === $("lightbox")) closeLightbox();
        });

        // keyboard lightbox
        document.addEventListener("keydown", (e) => {
          const lb = $("lightbox");
          if (lb.classList.contains("open")) {
            if (e.key === "ArrowRight") lbNext();
            if (e.key === "ArrowLeft") lbPrev();
            if (e.key === "Escape") closeLightbox();
          }
          // quick pinned toggle (p)
          if (e.key.toLowerCase() === "p" && !e.metaKey && !e.ctrlKey) {
            const p = $("pinnedColumn");
            if (!p) return;
            if (getPinned().length === 0) return;
            p.classList.toggle("hidden");
          }
          // exit present with escape
          if (e.key === "Escape" && document.fullscreenElement) exitPresent();
        });

        // clicking outside pinned closes panel on desktop (but keep toggle)
        document.addEventListener("click", (ev) => {
          const p = $("pinnedColumn");
          if (!p || p.classList.contains("hidden")) return;
          if (window.innerWidth <= 900) return;
          const target = ev.target;
          if (!p.contains(target) && !$("pinnedToggle").contains(target))
            p.classList.add("hidden");
        });

        // lightbox swipe for mobile
        (function () {
          let sx = 0;
          const wrap = $("lightbox");
          wrap.addEventListener(
            "touchstart",
            (e) => {
              sx = e.touches[0].clientX;
            },
            { passive: true }
          );
          wrap.addEventListener(
            "touchend",
            (e) => {
              const dx = e.changedTouches[0].clientX - sx;
              if (Math.abs(dx) > 50) {
                if (dx < 0) lbNext();
                else lbPrev();
              }
            },
            { passive: true }
          );
        })();
      }

      /* ----------------------
   Boot
   ---------------------- */
      async function init() {
        wireUI();
        generateMonthButtons();
        await sampleAccent();
        renderAll();
        renderGallery();
        renderBirthdays();
        // show pinned if any exist
        renderPinnedPanel();
        // run birthday popups first if today matches any birthdays (sequential)
        setTimeout(() => runBirthdayPopupsIfAny(), 300); // slight delay so page loads
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
