<!DOCTYPE html>
<!--
  Maxwell Events â€” single-file HTML
  Updated: museum â†’ gallery, hidden pinned panel when empty, month visibility in museum,
  swipe/pin gestures, month buttons, accent sampling, year progress, accessible lightbox,
  improved UX and polish.

  Drop into your repo as index.html. The hero uses the WP image you provided.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Maxwell Events â€” 2025â€“2026</title>
    <style>
      :root {
        --accent: #ffd24a;
        --accent-text: #072238;
        --muted: #0b3b4f;
        --card-radius: 14px;
        --bg: #07131a;
        --panel-width: 320px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background: var(--bg);
        color: var(--muted);
        padding: 18px;
        -webkit-font-smoothing: antialiased;
      }

      /* HERO */
      .hero {
        position: relative;
        max-width: 1200px;
        margin: 8px auto 18px;
        height: 360px;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 12px 40px rgba(2, 8, 23, 0.28);
      }
      .hero img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center center;
        display: block;
        transition: transform 0.6s ease;
      }
      @media (min-width: 1000px) {
        .hero img {
          object-position: center top;
          transform-origin: center top;
          transform: scale(1.03);
        }
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 36%,
          rgba(0, 0, 0, 0.82) 100%
        );
        pointer-events: none;
      }
      .hero .hero-header {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 22px;
        color: #fff;
      }
      .hero h1 {
        font-size: 1.6rem;
        margin: 0;
        font-weight: 900;
        letter-spacing: 0.4px;
        text-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
        -webkit-text-stroke: 0.5px rgba(0, 0, 0, 0.18);
      }
      .hero .hint {
        font-size: 0.95rem;
        opacity: 0.95;
        max-width: 720px;
        line-height: 1.2;
      }

      /* controls & month buttons */
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      input[type="search"],
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.96);
        color: #072238;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #ffecb5);
        color: var(--accent-text);
      }
      .month-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .month-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .month-btn.active {
        background: linear-gradient(90deg, var(--accent), #ffecb5);
        color: var(--accent-text);
      }

      /* pinned panel (hidden when empty) */
      .pinned-column {
        position: fixed;
        right: 18px;
        top: 110px;
        width: var(--panel-width);
        max-height: calc(100vh - 140px);
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        z-index: 999;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(2, 8, 23, 0.18);
        transform: translateX(0);
        transition: transform 0.35s, opacity 0.35s;
      }
      .pinned-column.hidden {
        transform: translateX(20px);
        opacity: 0;
        pointer-events: none;
      }
      .pinned-column .panel-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .clear-btn {
        background: #ffecb5;
        border: none;
        padding: 6px 8px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
      }
      .pinned-chip {
        background: #fff;
        padding: 10px;
        border-radius: 10px;
        min-width: 200px;
        border: 1px solid rgba(2, 8, 23, 0.04);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .pinned-row-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pinned-title {
        font-weight: 800;
        color: #072238;
        font-size: 14px;
      }
      .pinned-sub {
        font-size: 12px;
        color: #2a3b57;
      }
      .pinned-count {
        font-weight: 800;
        color: var(--accent);
      }
      .pinned-progress {
        height: 6px;
        background: rgba(2, 8, 23, 0.06);
        border-radius: 6px;
        overflow: hidden;
      }
      .pinned-progress > i {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--accent), #ffb84d);
        width: 0%;
      }
      #pinnedToggleBtn {
        position: fixed;
        right: 18px;
        top: 60%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(180deg, var(--accent), #ffecb5);
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.16);
        cursor: pointer;
        font-weight: 900;
      }
      #pinnedToggleBtn.hidden {
        display: none;
      }

      /* main */
      .wrap {
        max-width: 1200px;
        margin: 18px auto 120px;
        padding: 0 12px;
      }
      .top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
      }
      #pageTitle {
        font-size: 1.4rem;
        color: #fff;
        margin: 0;
      }
      #subtitle {
        color: rgba(255, 255, 255, 0.92);
        margin-top: 6px;
      }

      /* year progress */
      .year-progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        overflow: hidden;
        margin: 12px 0;
      }
      .year-progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), #ffb84d);
      }

      /* grid + month headings */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }
      .month-heading {
        grid-column: 1/-1;
        padding: 8px 0;
        font-weight: 900;
        color: #fff;
        opacity: 0.95;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      /* cards consistent */
      .card {
        position: relative;
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff, #fafafa);
        padding: 16px;
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 170px;
        transition: transform 0.18s, box-shadow 0.18s;
      }
      .pin-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: rgba(7, 18, 43, 0.04);
        cursor: pointer;
      }
      .pin-btn.active {
        background: linear-gradient(90deg, #ffd24a, #ffecb5);
      }
      .month-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
      }
      .card-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .title {
        min-height: 44px;
      }
      .fill {
        display: inline-block;
        background-clip: text;
        color: transparent;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        font-size: 18px;
      }
      .fallback {
        font-weight: 800;
        font-size: 18px;
        color: #072238;
      }
      .meta {
        font-size: 13px;
        color: #27506b;
        min-height: 18px;
      }
      .countdown {
        font-weight: 800;
        font-size: 15px;
        color: var(--accent);
        min-height: 22px;
      }
      .status {
        font-size: 13px;
        color: #16344f;
        font-weight: 600;
        min-height: 20px;
      }
      .date-badge {
        align-self: flex-start;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(7, 18, 43, 0.04);
        font-weight: 800;
      }
      .big-letter {
        position: absolute;
        right: -12px;
        top: -18px;
        font-weight: 800;
        font-size: 64px;
        color: rgba(7, 18, 43, 0.06);
        pointer-events: none;
      }

      .card.finished {
        opacity: 0.68;
        filter: grayscale(40%);
      }
      .card.happening {
        box-shadow: 0 16px 40px rgba(255, 90, 70, 0.1);
        animation: glow 2.6s infinite;
      }
      @keyframes glow {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* museum gallery */
      .gallery-wrap {
        max-width: 1200px;
        margin: 18px auto 18px;
        padding: 0 12px;
      }
      .gallery-month {
        margin-bottom: 18px;
      }
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
      }
      .gallery-thumb {
        position: relative;
        height: 120px;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        background: #ddd;
      }
      .gallery-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .gallery-caption {
        position: absolute;
        left: 8px;
        bottom: 8px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        border-radius: 6px;
        font-size: 12px;
      }

      /* lightbox */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .lightbox.open {
        display: flex;
      }
      .lightbox img {
        max-width: 92%;
        max-height: 82%;
        object-fit: contain;
        border-radius: 8px;
      }
      .lightbox .caption {
        color: #fff;
        margin-top: 12px;
        font-weight: 700;
      }
      .lightbox .controls {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
      }
      .lightbox button {
        background: rgba(255, 255, 255, 0.06);
        border: none;
        color: #fff;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
      }

      /* responsive */
      @media (max-width: 900px) {
        .pinned-column {
          right: 12px;
          left: 12px;
          bottom: 18px;
          top: auto;
          display: flex;
          flex-direction: row;
          max-height: 120px;
          padding: 8px;
          overflow: auto;
        }
        #pinnedToggleBtn {
          display: none;
        }
        .hero {
          height: 260px;
        }
        .big-letter {
          font-size: 48px;
        }
      }

      /* focus */
      :focus {
        outline: 3px solid rgba(255, 255, 255, 0.06);
        outline-offset: 3px;
      }
    </style>
  </head>
  <body>
    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <img
        id="heroImg"
        alt="Maxwell banner"
        src="https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1"
        crossorigin="anonymous"
      />
      <div class="hero-header" role="presentation">
        <div>
          <h1>Maxwell Events Countdown</h1>
          <div class="hint" id="heroSubtitle">2025-2026 schedule</div>

          <div
            class="controls"
            role="region"
            aria-label="Search and filters"
            style="margin-top: 12px"
          >
            <input
              id="searchBox"
              type="search"
              placeholder="Search events..."
              aria-label="Search events"
            />
            <select id="monthFilter" aria-label="Filter by month">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <div
              id="monthButtons"
              class="month-buttons"
              aria-hidden="false"
            ></div>
            <div style="display: flex; gap: 8px; align-items: center">
              <button id="gridBtn" class="btn primary" title="Grid view">
                Grid
              </button>
              <button id="museumBtn" class="btn" title="Gallery (Museum)">
                Museum
              </button>
              <button id="presentBtn" class="btn" title="Present mode">
                Present
              </button>
            </div>
          </div>
        </div>
        <div style="text-align: right; color: #fff; font-weight: 700">
          Maxwell â€¢ 2025â€“26
        </div>
      </div>
    </section>

    <!-- ambient -->
    <canvas
      id="stars"
      aria-hidden="true"
      style="position: fixed; inset: 0; z-index: -1; pointer-events: none"
    ></canvas>

    <!-- next up -->
    <section
      id="nextUp"
      style="
        display: none;
        max-width: 1200px;
        margin: 12px auto;
        padding: 12px 16px;
        border-left: 6px solid var(--accent);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.95);
        color: #072238;
        box-shadow: 0 8px 30px rgba(2, 8, 23, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      <div>
        <div style="font-weight: 700; color: #0b4b6f">Next Up</div>
        <div class="detail">
          <strong id="nextUpName">â€”</strong> <span id="nextUpDetail"></span>
        </div>
      </div>
      <div style="text-align: right">
        <div style="font-size: 12px; color: #0b2547">Tip</div>
        <div style="font-size: 12px; color: #07284f">
          Pin events using the ðŸ“Œ on cards or drag into the panel; in Museum
          click images to open fullscreen.
        </div>
      </div>
    </section>

    <!-- pinned panel (hidden when empty) -->
    <aside
      id="pinnedColumn"
      class="pinned-column hidden"
      aria-label="Pinned events"
    >
      <div class="panel-top">
        <strong style="font-size: 14px; color: #072238">Pinned</strong>
        <div>
          <button id="exportPins" class="btn" title="Export pinned">
            Export
          </button>
          <button id="clearPins" class="clear-btn" title="Clear pins">
            Clear
          </button>
          <button
            id="pinCollapseBtn"
            class="btn"
            aria-pressed="false"
            title="Collapse panel"
          >
            Hide
          </button>
        </div>
      </div>
      <!-- chips injected here -->
    </aside>

    <button id="pinnedToggleBtn" class="hidden" title="Open pinned panel">
      ðŸ“Œ
    </button>

    <main class="wrap">
      <div class="top-row">
        <div>
          <h1 id="pageTitle">School Events Countdown</h1>
          <div id="subtitle">2025-2026 schedule</div>

          <!-- year progress (computed) -->
          <div class="year-progress" aria-hidden="true">
            <i id="yearProgressBar" style="width: 0%"></i>
          </div>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            color: #fff;
            font-weight: 700;
          "
        >
          Maxwell â€¢ 2025â€“26
        </div>
      </div>

      <!-- Gallery (Museum mode) -->
      <section
        id="gallerySection"
        class="gallery-wrap"
        style="display: none"
        aria-hidden="true"
      >
        <!-- month groups injected here when museum active -->
      </section>

      <!-- Event grid -->
      <section id="stage">
        <div id="eventsGrid" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <!-- Lightbox / fullscreen -->
    <div
      id="lightbox"
      class="lightbox"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="controls" aria-hidden="false">
        <button id="lbPrev" aria-label="Previous">â—€</button>
        <button id="lbNext" aria-label="Next">â–¶</button>
      </div>
      <div style="text-align: center; max-width: 95%">
        <img id="lbImage" alt="" />
        <div class="caption" id="lbCaption"></div>
        <div style="margin-top: 12px">
          <button id="lbClose" class="btn">Close</button>
        </div>
      </div>
    </div>

    <script>
      /* ---------------- data ---------------- */
      const HERO =
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1";

      const EVENTS = [
        { name: "Summer Holiday", start: "2025-08-01", end: "2025-08-09" },
        {
          name: "School Opening (Arrival & Dorm Move-in)",
          start: "2025-08-10",
          end: "2025-08-11",
        },
        { name: "First Semester Registration", start: "2025-08-11" },
        { name: "Orientation", start: "2025-08-12" },
        { name: "Faculty Family", start: "2025-09-07" },
        { name: "Picture Day", start: "2025-09-09" },
        { name: "Open Weekend", start: "2025-09-12", end: "2025-09-14" },
        { name: "Week of Prayer", start: "2025-09-15", end: "2025-09-20" },
        { name: "Camping Trip", start: "2025-09-21", end: "2025-09-23" },
        { name: "Online Parent-Teacher Conferences", start: "2025-09-30" },
        { name: "Midterm Break", start: "2025-10-09", end: "2025-10-20" },
        { name: "Music Sabbath", start: "2025-10-25" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2025-11-07",
          end: "2025-11-08",
        },
        { name: "MAP Testing", start: "2025-11-24", end: "2025-11-27" },
        { name: "Faculty Family", start: "2025-11-14" },
        { name: "Finals Review Week", start: "2025-12-01", end: "2025-12-05" },
        { name: "Final Exams 1st Sem", start: "2025-12-08", end: "2025-12-10" },
        { name: "Christmas Break", start: "2025-12-10", end: "2026-01-05" },
        { name: "School Opening (2nd Sem)", start: "2026-01-05" },
        {
          name: "Senior Government Day",
          start: "2026-01-20",
          end: "2026-01-21",
        },
        { name: "Faculty Family", start: "2026-01-30" },
        { name: "Junior Vespers", start: "2026-02-06" },
        { name: "NHS Applications Deadline", start: "2026-02-10" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2026-02-13",
          end: "2026-02-14",
        },
        { name: "ACT", start: "2026-02-13" },
        { name: "NHS Induction", start: "2026-02-17" },
        { name: "Mt. Kenya Trip", start: "2026-02-20", end: "2026-02-24" },
        { name: "Senior Dedication", start: "2026-02-27" },
        { name: "Sophomore Vespers", start: "2026-03-06" },
        {
          name: "Student-Led Week of Prayer",
          start: "2026-03-09",
          end: "2026-03-14",
        },
        { name: "Track and Field", start: "2026-03-19", end: "2026-03-20" },
        { name: "Chorale Sacred Concert", start: "2026-03-21" },
        { name: "Senior Class Trip", start: "2026-03-23", end: "2026-03-26" },
        { name: "Midterm Break", start: "2026-03-26", end: "2026-04-06" },
        {
          name: "Ethiopia Mission Trip",
          start: "2026-03-26",
          end: "2026-04-05",
        },
        { name: "ACT", start: "2026-04-10" },
        { name: "Freshmen Vespers", start: "2026-04-17" },
        { name: "Faculty Family", start: "2026-04-19" },
        { name: "Week of Prayer", start: "2026-04-20", end: "2026-04-25" },
        { name: "Long Weekend", start: "2026-04-30", end: "2026-05-03" },
        { name: "ASB Spirit Week", start: "2026-05-04", end: "2026-05-09" },
        { name: "Class Surveys", start: "2026-05-11", end: "2026-05-13" },
        { name: "ASB Elections", start: "2026-05-12" },
        { name: "Spring Concert", start: "2026-05-16" },
        { name: "MAP Testing", start: "2026-05-18", end: "2026-05-21" },
        { name: "Dorm Parties", start: "2026-05-23" },
        { name: "Dorm Outings", start: "2026-05-24" },
        { name: "Finals Review Week", start: "2026-05-25", end: "2026-05-29" },
        { name: "Zamani Night", start: "2026-05-30" },
        { name: "Elementary Graduation", start: "2026-05-31" },
        { name: "Final Exams 2nd Sem", start: "2026-06-02", end: "2026-06-04" },
        { name: "GRADDDDD!!!!", start: "2026-06-05", end: "2026-06-07" },
      ];

      const MONTH_COLORS = {
        "01": "#e74c3c",
        "02": "#ff8a65",
        "03": "#f6c85f",
        "04": "#8dd3c7",
        "05": "#66a3ff",
        "06": "#9b59b6",
        "07": "#f06292",
        "08": "#ffb84d",
        "09": "#6ab04c",
        10: "#4a90e2",
        11: "#34495e",
        12: "#7bdbdb",
      };

      /* Sample museum/gallery photos (month ties so month filters still work in museum) */
      const MUSEUM_PHOTOS = [
        {
          src: HERO,
          caption: "Maxwell â€” Campus View",
          month: "08",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1600&q=80&auto=format&fit=crop",
          caption: "Forest Path",
          month: "09",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1600&q=80&auto=format&fit=crop",
          caption: "Lake at Dawn",
          month: "10",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1503264116251-35a269479413?w=1600&q=80&auto=format&fit=crop",
          caption: "Foggy Ridge",
          month: "12",
          year: 2025,
        },
        {
          src: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1600&q=80&auto=format&fit=crop",
          caption: "Mountain Trail",
          month: "03",
          year: 2026,
        },
        {
          src: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=1600&q=80&auto=format&fit=crop",
          caption: "Sunset Camp",
          month: "05",
          year: 2026,
        },
      ];

      /* ---------------- helpers ---------------- */
      const $ = (id) => document.getElementById(id);
      const pad = (n) => (n < 10 ? "0" + n : String(n));
      const parseStart = (s) =>
        s.includes("T") ? new Date(s) : new Date(s + "T00:00:00");
      const parseEnd = (e, start) => {
        if (!e) {
          const d = new Date(start);
          d.setHours(23, 59, 59, 999);
          return d;
        }
        return e.includes("T") ? new Date(e) : new Date(e + "T23:59:59.999");
      };
      const formatISO = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      const shortMonth = (d) => d.toLocaleString("en", { month: "short" });
      const formatDateBadge = (start, end) => {
        const s = parseStart(start);
        const e = end ? parseStart(end) : null;
        if (!e) return `${shortMonth(s)} ${s.getDate()}`;
        if (
          s.getFullYear() === e.getFullYear() &&
          s.getMonth() === e.getMonth()
        )
          return `${shortMonth(s)} ${s.getDate()}â€“${e.getDate()}`;
        return `${shortMonth(s)} ${s.getDate()} â€“ ${shortMonth(
          e
        )} ${e.getDate()}`;
      };
      function slugify(name, idx) {
        return (
          String(name)
            .toLowerCase()
            .replace(/[â€™'"]/g, "")
            .replace(/[:\/\\(),.!?#\u2013\u2014]/g, "")
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "") +
          "-" +
          idx
        );
      }
      function eventIcon(name) {
        const n = name.toLowerCase();
        if (/exam|final|midterm|test|act|map/.test(n)) return "ðŸ“";
        if (
          /break|holiday|christmas|spring|long weekend|summer|vacation/.test(n)
        )
          return "ðŸŽ‰";
        if (/trip|camp|mt|mountain|mission/.test(n)) return "ðŸ•ï¸";
        if (/concert|chorale|music/.test(n)) return "ðŸŽµ";
        if (/sports|track|field/.test(n)) return "ðŸ…";
        return "ðŸ“…";
      }

      /* ---------------- state ---------------- */
      let items = [];
      let tickHandle = null;
      let mode = "grid";
      const STORAGE_KEY = "maxwell_positions_v2";
      const PINNED_KEY = "maxwell_pinned_v2";
      const PIN_LIMIT = 8;

      function getPinned() {
        try {
          return JSON.parse(localStorage.getItem(PINNED_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }
      function setPinned(arr) {
        localStorage.setItem(PINNED_KEY, JSON.stringify(arr));
        renderPinnedPanel();
      }
      function isPinned(i) {
        return getPinned().includes(i);
      }
      function togglePin(i) {
        const arr = getPinned();
        const p = arr.indexOf(i);
        if (p === -1) {
          arr.unshift(i);
          while (arr.length > 50) arr.pop();
        } else arr.splice(p, 1);
        setPinned(arr);
      }
      function savePos(id, x, y) {
        try {
          const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
          s[id] = { x, y, at: Date.now() };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        } catch (e) {}
      }

      /* ---------------- starfield ---------------- */
      (function () {
        const c = $("stars");
        if (!c) return;
        const ctx = c.getContext("2d");
        function r() {
          c.width = innerWidth;
          c.height = innerHeight;
        }
        window.addEventListener("resize", r);
        r();
        const stars = Array.from({ length: 120 }, () => ({
          x: Math.random() * c.width,
          y: Math.random() * c.height,
          r: Math.random() * 1.6 + 0.2,
          dy: Math.random() * 0.5 + 0.02,
          alpha: 0.2 + Math.random() * 0.6,
        }));
        function tick() {
          ctx.clearRect(0, 0, c.width, c.height);
          for (const s of stars) {
            ctx.globalAlpha =
              s.alpha * (0.7 + Math.sin(Date.now() / 1000 + s.x) * 0.3);
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            s.y += s.dy;
            if (s.y > c.height + 10) {
              s.y = -10;
              s.x = Math.random() * c.width;
            }
          }
          requestAnimationFrame(tick);
        }
        tick();
      })();

      /* ---------------- rendering events ---------------- */
      function sortEvents() {
        EVENTS.sort((a, b) => parseStart(a.start) - parseStart(b.start));
      }
      function findNext() {
        const now = Date.now();
        return (
          EVENTS.find(
            (ev) => parseEnd(ev.end, parseStart(ev.start)).getTime() >= now
          ) || null
        );
      }
      function renderNextUp() {
        const n = findNext();
        const b = $("nextUp");
        if (!b) return;
        if (!n) {
          b.style.display = "none";
          return;
        }
        b.style.display = "flex";
        $("nextUpName").textContent = n.name;
        $("nextUpDetail").textContent = n.end
          ? `From ${formatISO(parseStart(n.start))} â†’ ${formatISO(
              parseStart(n.end)
            )}`
          : `On ${formatISO(parseStart(n.start))}`;
      }

      /* update single card countdown/status */
      function updateOne(item, now) {
        const { id, start, end, el: card } = item;
        const cd = document.getElementById("cd-" + id);
        const st = document.getElementById("st-" + id);
        if (!cd || !st) return;
        if (now.getTime() < start.getTime()) {
          card.classList.remove("happening", "finished");
          card.classList.add("upcoming");
          const diff = start.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s left`;
          st.innerHTML = "â³ Coming soon";
        } else if (now.getTime() > end.getTime()) {
          card.classList.remove("upcoming", "happening");
          card.classList.add("finished");
          cd.textContent = `Ended on ${formatISO(end)}`;
          st.innerHTML = "âœ… Finished";
        } else {
          card.classList.remove("upcoming", "finished");
          card.classList.add("happening");
          const diff = end.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s remaining`;
          st.innerHTML = "ðŸ”´ Happening now";
        }
      }

      /* render grid grouped by month */
      function renderAll() {
        // clear
        if (tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
        items = [];
        const grid = $("eventsGrid");
        if (!grid) return;
        grid.innerHTML = "";
        sortEvents();
        renderNextUp();
        const q = ($("searchBox").value || "").toLowerCase();
        const monthVal = $("monthFilter").value || "";

        let currentGroup = "";
        EVENTS.forEach((ev, idx) => {
          if (q && !ev.name.toLowerCase().includes(q)) return;
          if (monthVal && ev.start.slice(5, 7) !== monthVal) return;

          const start = parseStart(ev.start);
          const mmKey = `${start.getFullYear()}-${pad(start.getMonth() + 1)}`;
          if (mmKey !== currentGroup) {
            currentGroup = mmKey;
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${start.toLocaleString("en", {
              month: "long",
            })} ${start.getFullYear()}`;
            heading.dataset.mm = pad(start.getMonth() + 1);
            heading.addEventListener("click", () => {
              $("monthFilter").value = heading.dataset.mm;
              highlightMonthButton(heading.dataset.mm);
              renderAll();
            });
            grid.appendChild(heading);
          }

          const startDate = parseStart(ev.start);
          const endDate = parseEnd(ev.end, startDate);
          const id = slugify(ev.name, idx);
          const monthColor =
            MONTH_COLORS[pad(startDate.getMonth() + 1)] || "#ccc";

          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("data-id", id);
          card.setAttribute("data-idx", idx);
          card.innerHTML = `
      <div class="month-strip" style="background:${monthColor}"></div>
      <button class="pin-btn" title="Pin event" aria-label="Pin event" data-idx="${idx}">ðŸ“Œ</button>
      <div class="big-letter">${
        ev.name && ev.name[0] ? ev.name[0].toUpperCase() : "E"
      }</div>
      <div class="card-content">
        <div class="title" id="title-wrap-${id}">
          <span class="fill" id="title-fill-${id}">${ev.name}</span>
          <span class="fallback" id="title-fallback-${id}">${ev.name}</span>
        </div>
        <div class="meta">${eventIcon(ev.name)} ${
            ev.end
              ? `${formatISO(startDate)} â†’ ${formatISO(parseStart(ev.end))}`
              : formatISO(startDate)
          }</div>
        <div class="countdown" id="cd-${id}">â€”</div>
        <div class="status" id="st-${id}">â€”</div>
        <div class="date-badge" id="db-${id}">${formatDateBadge(
            ev.start,
            ev.end
          )}</div>
      </div>
    `;
          grid.appendChild(card);

          // preload title texture using hero for aesthetic
          const imgUrl = HERO;
          (function preload(iid, url) {
            const im = new Image();
            im.crossOrigin = "anonymous";
            im.onload = () => {
              const f = document.getElementById("title-fill-" + iid);
              const fb = document.getElementById("title-fallback-" + iid);
              if (f) {
                f.style.backgroundImage = `url('${url}')`;
                f.style.backgroundSize = "cover";
                f.style.backgroundPosition = "center";
                f.style.opacity = "1";
                if (fb) fb.style.opacity = "0";
              }
            };
            im.onerror = () => {};
            im.src = url;
          })(id, imgUrl);

          items.push({
            id,
            name: ev.name,
            start: startDate,
            end: endDate,
            el: card,
            idx,
          });

          // pin button
          const pb = card.querySelector(".pin-btn");
          if (pb) {
            const refresh = () => pb.classList.toggle("active", isPinned(idx));
            pb.addEventListener("click", (e) => {
              e.stopPropagation();
              togglePin(idx);
              refresh();
            });
            refresh();
          }

          // keyboard focus scroll highlight
          card.tabIndex = 0;
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              card.click();
            }
          });

          // add swipe-to-pin on touch devices
          addSwipeToPin(card, idx);
        });

        // tick
        tickHandle = setInterval(() => {
          const now = new Date();
          items.forEach((i) => updateOne(i, now));
          updatePinnedCounts(now);
        }, 1000);
        items.forEach((i) => updateOne(i, new Date()));

        // show/hide pinned panel depending on pins
        renderPinnedPanel();

        // ensure the gallery (if visible) updates month groups too
        if (mode === "museum") renderGallery();
        updateYearProgress();
        applyMode();
      }

      /* ---------------- pinned panel ---------------- */
      function renderPinnedPanel() {
        const container = $("pinnedColumn");
        if (!container) return;
        // keep panel-top
        const header = container.querySelector(".panel-top");
        container.innerHTML = "";
        if (header) container.appendChild(header);

        const now = new Date();
        const pinnedIndices = getPinned();
        const pinnedSet = new Set(pinnedIndices);

        const mapped = EVENTS.map((ev, i) => ({
          ev,
          i,
          start: parseStart(ev.start),
          end: parseEnd(ev.end, parseStart(ev.start)),
        }));
        const upcoming = mapped
          .filter((o) => o.end.getTime() >= now.getTime())
          .sort((a, b) => a.start - b.start);

        const finalPins = [];
        for (const p of pinnedIndices) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (EVENTS[p])
            finalPins.push({
              ev: EVENTS[p],
              idx: p,
              start: parseStart(EVENTS[p].start),
              end: parseEnd(EVENTS[p].end, parseStart(EVENTS[p].start)),
            });
        }
        for (const u of upcoming) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (pinnedSet.has(u.idx)) continue;
          finalPins.push(u);
        }

        // hide panel entirely if no pins
        if (finalPins.length === 0) {
          container.classList.add("hidden");
          $("pinnedToggleBtn").classList.add("hidden");
          // keep header but hidden is applied
          return;
        } else {
          container.classList.remove("hidden");
          $("pinnedToggleBtn").classList.remove("hidden");
        }

        finalPins.forEach((o, pos) => {
          const id = "pin_" + slugify(o.ev.name + "-" + o.idx, o.idx);
          const chip = document.createElement("button");
          chip.className = "pinned-chip";
          chip.tabIndex = 0;
          chip.dataset.eventIndex = String(o.idx);
          chip.id = id;
          chip.setAttribute("draggable", "true");
          chip.innerHTML = `
      <div class="pinned-row-top">
        <div style="min-width:0">
          <div class="pinned-title">${o.ev.name}</div>
          <div class="pinned-sub">${
            o.ev.end
              ? formatISO(o.start) + " â†’ " + formatISO(parseStart(o.ev.end))
              : formatISO(o.start)
          }</div>
        </div>
        <div style="text-align:right"><div class="pinned-count" id="count-${id}">â€”</div></div>
      </div>
      <div class="pinned-progress"><i style="width:0%"></i></div>
    `;
          chip.addEventListener("click", () => {
            const idx = Number(chip.dataset.eventIndex);
            const target = items.find((it) => it.idx === idx);
            if (target && target.el) {
              target.el.scrollIntoView({ behavior: "smooth", block: "center" });
              target.el.style.boxShadow = "0 20px 60px rgba(255,180,60,0.32)";
              target.el.style.transform = "translateY(-8px)";
              setTimeout(() => {
                target.el.style.boxShadow = "";
                target.el.style.transform = "";
              }, 1200);
            }
          });

          // reorder inside panel
          chip.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", String(o.idx));
            chip.classList.add("dragging");
          });
          chip.addEventListener("dragend", (e) => {
            chip.classList.remove("dragging");
          });
          chip.addEventListener("dragover", (e) => {
            e.preventDefault();
            const dragging = container.querySelector(".dragging");
            if (!dragging || dragging === chip) return;
            const draggingIdx = Number(dragging.dataset.eventIndex);
            const targetIdx = Number(chip.dataset.eventIndex);
            const pins = getPinned();
            const from = pins.indexOf(draggingIdx);
            const to = pins.indexOf(targetIdx);
            if (from > -1 && to > -1 && from !== to) {
              pins.splice(from, 1);
              pins.splice(to, 0, draggingIdx);
              setPinned(pins);
            }
          });

          container.appendChild(chip);
        });
      }

      /* update pinned counts and progress bars */
      function updatePinnedCounts(now) {
        if (!now) now = new Date();
        const container = $("pinnedColumn");
        if (!container) return;
        const chips = Array.from(container.querySelectorAll(".pinned-chip"));
        chips.forEach((chip) => {
          const idx = Number(chip.dataset.eventIndex);
          const ev = EVENTS[idx];
          if (!ev) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          let txt = "",
            percent = 0;
          if (now.getTime() < start.getTime()) {
            const diff = start.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s left`;
            percent = 0;
          } else if (now.getTime() > end.getTime()) {
            const diff = now.getTime() - end.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `Ended ${d}d ${h}h ${m}m ${s}s ago`;
            percent = 100;
          } else {
            const total = end.getTime() - start.getTime();
            const remaining = end.getTime() - now.getTime();
            const passed = total - remaining;
            percent = Math.max(
              0,
              Math.min(100, Math.round((passed / total) * 100))
            );
            const diff = remaining;
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s remaining`;
          }
          const countEl = chip.querySelector(`#count-${chip.id}`);
          const prog = chip.querySelector(".pinned-progress i");
          if (countEl) countEl.textContent = txt;
          if (prog) prog.style.width = percent + "%";
        });
      }

      /* ---------------- swipe-to-pin (mobile) ---------------- */
      function addSwipeToPin(card, idx) {
        let pointerDown = false,
          startX = 0,
          startY = 0,
          moved = false;
        function down(e) {
          pointerDown = true;
          startX = e.clientX;
          startY = e.clientY;
          moved = false;
        }
        function move(e) {
          if (!pointerDown) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          if (Math.abs(dx) > 8 && Math.abs(dx) > Math.abs(dy)) moved = true;
          if (moved) {
            card.style.transform = `translateX(${Math.min(
              Math.max(dx, -60),
              60
            )}px)`;
          }
        }
        function up(e) {
          if (!pointerDown) return;
          pointerDown = false;
          if (moved) {
            const dx = e.clientX - startX;
            if (dx > 60) {
              // swipe right => pin
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.add("active");
              card.style.transform = "";
            } else if (dx < -60) {
              // swipe left => unpin
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.remove("active");
              card.style.transform = "";
            } else {
              card.style.transform = "";
            }
          }
        }
        card.addEventListener("pointerdown", down);
        card.addEventListener("pointermove", move);
        card.addEventListener("pointerup", up);
        card.addEventListener("pointercancel", up);
      }

      /* ---------------- gallery (museum) ---------------- */
      function renderGallery() {
        const wrap = $("gallerySection");
        if (!wrap) return;
        wrap.innerHTML = ""; // build month groups based on MUSEUM_PHOTOS and current filter
        const monthFilter = $("monthFilter").value || "";
        const months = new Map();
        MUSEUM_PHOTOS.forEach((photo) => {
          const m = photo.month;
          const key = `${photo.year}-${m}`;
          if (!months.has(key))
            months.set(key, { month: m, year: photo.year, photos: [] });
          months.get(key).photos.push(photo);
        });
        // order months chronologically
        Array.from(months.entries())
          .sort()
          .forEach(([key, group]) => {
            if (monthFilter && group.month !== monthFilter) return;
            const section = document.createElement("div");
            section.className = "gallery-month";
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${new Date(
              group.year + "-" + group.month + "-01"
            ).toLocaleString("en", { month: "long", year: "numeric" })}`;
            heading.addEventListener("click", () => {
              $("monthFilter").value = group.month;
              highlightMonthButton(group.month);
              renderGallery();
            });
            section.appendChild(heading);
            const grid = document.createElement("div");
            grid.className = "gallery-grid";
            group.photos.forEach((p, i) => {
              const t = document.createElement("div");
              t.className = "gallery-thumb";
              t.tabIndex = 0;
              t.innerHTML = `<img src="${p.src}" alt="${p.caption}"><div class="gallery-caption">${p.caption}</div>`;
              t.addEventListener("click", () => openLightbox(group.photos, i));
              t.addEventListener("keydown", (e) => {
                if (e.key === "Enter") openLightbox(group.photos, i);
              });
              grid.appendChild(t);
            });
            section.appendChild(grid);
            wrap.appendChild(section);
          });
      }

      /* ---------------- lightbox ---------------- */
      let lbPhotos = [],
        lbIndex = 0;
      function openLightbox(photos, idx) {
        lbPhotos = photos;
        lbIndex = idx;
        const light = $("lightbox");
        const img = $("lbImage");
        const cap = $("lbCaption");
        img.src = photos[idx].src;
        img.alt = photos[idx].caption;
        cap.textContent = photos[idx].caption;
        light.classList.add("open");
        light.setAttribute("aria-hidden", "false");
      }
      function closeLightbox() {
        const light = $("lightbox");
        light.classList.remove("open");
        light.setAttribute("aria-hidden", "true");
      }
      function lbNext() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex + 1) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }
      function lbPrev() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex - 1 + lbPhotos.length) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption;
      }

      /* keyboard & touch for lightbox */
      document.addEventListener("keydown", (e) => {
        const light = $("lightbox");
        if (light.classList.contains("open")) {
          if (e.key === "ArrowRight") lbNext();
          if (e.key === "ArrowLeft") lbPrev();
          if (e.key === "Escape") closeLightbox();
        }
      });
      (function addLightboxControls() {
        $("lbClose").addEventListener("click", closeLightbox);
        $("lbNext").addEventListener("click", lbNext);
        $("lbPrev").addEventListener("click", lbPrev);
        // touch swipe
        let sx = 0,
          sy = 0;
        const img = $("lbImage");
        const wrap = $("lightbox");
        wrap.addEventListener(
          "touchstart",
          (e) => {
            const t = e.touches[0];
            sx = t.clientX;
            sy = t.clientY;
          },
          { passive: true }
        );
        wrap.addEventListener(
          "touchend",
          (e) => {
            const t = e.changedTouches[0];
            const dx = t.clientX - sx;
            const dy = t.clientY - sy;
            if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
              if (dx < 0) lbNext();
              else lbPrev();
            }
          },
          { passive: true }
        );
      })();

      /* ---------------- museum toggle & modes ---------------- */
      function applyMode() {
        const gallery = $("gallerySection"),
          grid = $("eventsGrid"),
          stage = $("stage");
        if (mode === "museum") {
          gallery.style.display = "";
          gallery.setAttribute("aria-hidden", "false");
          stage.style.display = "none";
          renderGallery();
        } else {
          gallery.style.display = "none";
          gallery.setAttribute("aria-hidden", "true");
          stage.style.display = "";
        }
      }

      /* ---------------- month buttons ---------------- */
      function generateMonthButtons() {
        const container = $("monthButtons");
        if (!container) return;
        const months = new Map();
        EVENTS.forEach((ev) => {
          const s = parseStart(ev.start);
          const key = `${s.getFullYear()}-${pad(s.getMonth() + 1)}`;
          if (!months.has(key))
            months.set(key, {
              label: `${s.toLocaleString("en", {
                month: "short",
              })} ${s.getFullYear()}`,
              month: pad(s.getMonth() + 1),
            });
        });
        container.innerHTML = "";
        Array.from(months.entries())
          .sort()
          .forEach(([k, val]) => {
            const btn = document.createElement("button");
            btn.className = "month-btn";
            btn.textContent = val.label;
            btn.dataset.month = val.month;
            btn.addEventListener("click", () => {
              const mf = $("monthFilter");
              if (!mf) return;
              if (mf.value === val.month) {
                mf.value = "";
                btn.classList.remove("active");
              } else {
                mf.value = val.month;
                highlightMonthButton(val.month);
              }
              // update both grid and gallery
              renderAll();
            });
            container.appendChild(btn);
          });
      }
      function highlightMonthButton(month) {
        const btns = Array.from(document.querySelectorAll(".month-btn"));
        btns.forEach((b) =>
          b.classList.toggle("active", b.dataset.month === month)
        );
      }

      /* ---------------- year progress ---------------- */
      function updateYearProgress() {
        // progress between first event start and last event end
        if (EVENTS.length === 0) return;
        const start = parseStart(EVENTS[0].start);
        const last = EVENTS[EVENTS.length - 1];
        const end = parseEnd(last.end, parseStart(last.start));
        const now = new Date();
        const total = end.getTime() - start.getTime();
        const passed = Math.max(
          0,
          Math.min(total, now.getTime() - start.getTime())
        );
        const pct = Math.round((passed / total) * 100);
        $("yearProgressBar").style.width = pct + "%";
      }

      /* ---------------- color sampling (try hero) ---------------- */
      async function sampleAccent() {
        const img = $("heroImg");
        if (!img) return;
        await new Promise((r) => {
          if (img.complete) return r();
          img.addEventListener("load", r, { once: true });
          img.addEventListener("error", r, { once: true });
        });
        try {
          const w = Math.min(img.naturalWidth || 200, 160),
            h = Math.min(img.naturalHeight || 120, 120);
          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0, 0, w, h).data;
          let r = 0,
            g = 0,
            b = 0,
            count = 0;
          for (let i = 0; i < data.length; i += 4) {
            const a = data[i + 3];
            if (a < 80) continue;
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
          }
          if (count === 0) throw new Error("no pixels");
          r = Math.round(r / count);
          g = Math.round(g / count);
          b = Math.round(b / count);
          const rgb = `rgb(${r},${g},${b})`;
          document.documentElement.style.setProperty("--accent", rgb);
          const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
          const accentText = lum > 0.6 ? "#072238" : "#ffffff";
          document.documentElement.style.setProperty(
            "--accent-text",
            accentText
          );
        } catch (e) {
          // fallback: use month color for next upcoming event
          const next = findNext();
          if (next) {
            const m = pad(parseStart(next.start).getMonth() + 1);
            const col = MONTH_COLORS[m] || "#ffd24a";
            document.documentElement.style.setProperty("--accent", col);
            document.documentElement.style.setProperty(
              "--accent-text",
              "#072238"
            );
          }
        }
      }

      /* ---------------- UI wiring ---------------- */
      function wireUI() {
        $("heroImg").src = HERO;
        $("heroImg").crossOrigin = "anonymous";

        $("gridBtn").addEventListener("click", () => {
          mode = "grid";
          applyMode();
          $("gridBtn").classList.add("primary");
          $("museumBtn").classList.remove("primary");
        });
        $("museumBtn").addEventListener("click", () => {
          mode = "museum";
          applyMode();
          $("museumBtn").classList.add("primary");
          $("gridBtn").classList.remove("primary");
        });
        $("presentBtn").addEventListener("click", () => {
          document.documentElement.requestFullscreen?.();
        });

        $("searchBox").addEventListener("input", () => renderAll());
        $("monthFilter").addEventListener("change", () => {
          highlightMonthButton($("monthFilter").value);
          renderAll();
        });

        // pinned panel toggles
        $("pinnedToggleBtn").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (!p) return;
          p.classList.toggle("hidden");
        });
        $("pinCollapseBtn").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (!p) return;
          p.classList.toggle("hidden");
        });
        $("clearPins").addEventListener("click", () => setPinned([]));
        $("exportPins").addEventListener("click", () => {
          const pins = getPinned();
          const rows = [["name", "start", "end"]];
          for (const i of pins) {
            if (EVENTS[i])
              rows.push([
                EVENTS[i].name,
                EVENTS[i].start || "",
                EVENTS[i].end || "",
              ]);
          }
          const csv = rows
            .map((r) =>
              r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
            )
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "pinned-events.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        // lightbox controls already wired earlier
      }

      /* ---------------- bootstrap ---------------- */
      async function init() {
        wireUI();
        generateMonthButtons();
        // default: hide pinned until someone pins
        renderPinnedPanel();
        await sampleAccent();
        renderAll();

        // keyboard quick toggle for pinned (p)
        document.addEventListener("keydown", (e) => {
          if (e.key.toLowerCase() === "p" && !e.metaKey && !e.ctrlKey) {
            const p = $("pinnedColumn");
            if (p) p.classList.toggle("hidden");
          }
        });

        // clicking outside pinned closes (desktop)
        document.addEventListener("click", (ev) => {
          const p = $("pinnedColumn");
          if (!p) return;
          if (p.classList.contains("hidden")) return;
          if (window.innerWidth <= 900) return;
          const target = ev.target;
          if (!p.contains(target) && !$("pinnedToggleBtn").contains(target))
            p.classList.add("hidden");
        });
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
