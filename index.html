<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Maxwell Events Countdown</title>
    <style>
      /* ---------- Reset & base ---------- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --accent: #ffd24a;
        --muted: #0b3b4f;
        --card-radius: 14px;
        --ui-bg: rgba(255, 255, 255, 0.95);
        --ui-text: #072238;
        --page-bg: #07131a;
        --hero-fg: #fff;
        --chip-bg: #ffffff;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: var(--page-bg);
        color: var(--muted);
        padding: 20px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ---------- hero (uses <img> for reliable crop) ---------- */
      .hero {
        position: relative;
        max-width: 1200px;
        margin: 12px auto 18px;
        height: 340px;
        border-radius: 14px;
        overflow: hidden;
      }
      .hero img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        display: block;
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 42%,
          rgba(0, 0, 0, 0.78) 100%
        );
        pointer-events: none;
      }
      .hero .hero-header {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 22px;
        color: var(--hero-fg);
      }
      .hero h1 {
        font-size: 1.6rem;
        margin: 0;
        font-weight: 800;
        letter-spacing: 0.4px;
        text-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
      }
      .hero .hint {
        font-size: 0.95rem;
        opacity: 0.95;
        max-width: 720px;
        line-height: 1.2;
      }

      /* ---------- controls ---------- */
      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      input[type="search"],
      select {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(7, 18, 43, 0.08);
        background: var(--ui-bg);
        color: var(--ui-text);
        box-shadow: 0 6px 18px rgba(2, 8, 23, 0.06);
      }
      input[type="search"]::placeholder {
        color: #7b8a96;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #ffecb5);
        color: #072238;
        box-shadow: 0 8px 24px rgba(2, 8, 23, 0.12);
      }

      /* ---------- pinned column (right) ---------- */
      .pinned-column {
        position: fixed;
        right: 18px;
        top: 110px;
        width: 280px;
        max-height: calc(100vh - 140px);
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        z-index: 999;
        background: var(--chip-bg);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(2, 8, 23, 0.18);
      }
      .pinned-column.collapsed {
        width: 60px;
        padding: 8px;
        align-items: center;
      }
      .pinned-column .panel-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .collapse-btn {
        background: none;
        border: 0;
        font-weight: 800;
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 8px;
      }
      .pinned-chip {
        background: #fff;
        padding: 10px;
        border-radius: 10px;
        min-width: 200px;
        border: 1px solid rgba(2, 8, 23, 0.04);
        box-shadow: 0 8px 20px rgba(2, 8, 23, 0.06);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .pinned-title {
        font-weight: 800;
        color: #072238;
        font-size: 14px;
      }
      .pinned-sub {
        font-size: 12px;
        color: #2a3b57;
      }
      .pinned-count {
        font-weight: 800;
        color: #ffb84d;
      }

      /* toggle button always visible (useful when collapsed) */
      #pinnedToggleBtn {
        position: fixed;
        right: 18px;
        top: 60%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 48px;
        height: 48px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(180deg, var(--accent), #ffecb5);
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.16);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #pinnedToggleBtn.collapsed {
        right: 12px;
      }

      /* ---------- main content & layout ---------- */
      .wrap {
        max-width: 1200px;
        margin: 20px auto 120px;
        padding: 0 12px;
      }
      .top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
      }
      #pageTitle {
        font-size: 1.4rem;
        color: #fff;
        margin: 0;
        text-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }
      #subtitle {
        color: rgba(255, 255, 255, 0.92);
        margin-top: 6px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }

      /* make card layout consistent using a column layout with fixed min-heights for areas */
      .card {
        position: relative;
        border-radius: var(--card-radius);
        background: linear-gradient(180deg, #ffffff, #fafafa);
        padding: 16px;
        box-shadow: 0 10px 30px rgba(2, 8, 23, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 170px;
      }
      .card .pin-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 34px;
        height: 34px;
        border-radius: 8px;
        border: none;
        background: rgba(7, 18, 43, 0.04);
        cursor: pointer;
      }
      .card .pin-btn.active {
        background: linear-gradient(90deg, #ffd24a, #ffecb5);
        box-shadow: 0 8px 20px rgba(255, 180, 60, 0.12);
      }
      .month-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: 14px;
        border-bottom-left-radius: 14px;
      }

      .card-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .title {
        min-height: 44px;
      }
      .title .fill {
        display: inline-block;
        background-clip: text;
        color: transparent;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        font-size: 18px;
      }
      .title .fallback {
        font-weight: 800;
        font-size: 18px;
        color: #072238;
      }
      .meta {
        font-size: 13px;
        color: #27506b;
        min-height: 18px;
      }
      .countdown {
        font-weight: 800;
        font-size: 15px;
        color: var(--accent);
        min-height: 22px;
      }
      .status {
        font-size: 13px;
        color: #16344f;
        font-weight: 600;
        min-height: 20px;
      }
      .date-badge {
        align-self: flex-start;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(7, 18, 43, 0.04);
        font-weight: 800;
      }

      .big-letter {
        position: absolute;
        right: -12px;
        top: -18px;
        font-weight: 800;
        font-size: 72px;
        color: rgba(7, 18, 43, 0.06);
        pointer-events: none;
      }

      /* museum adjustments */
      .museum .grid {
        position: relative;
        min-height: 520px;
      }
      .museum .card {
        width: 260px;
        position: absolute;
        cursor: grab;
        box-shadow: 0 22px 60px rgba(2, 8, 23, 0.18);
      }

      @media (max-width: 900px) {
        .pinned-column {
          right: 12px;
          left: 12px;
          bottom: 18px;
          top: auto;
          display: flex;
          flex-direction: row;
          max-height: 120px;
          padding: 8px;
          overflow: auto;
        }
        #pinnedToggleBtn {
          display: none;
        }
        .hero {
          height: 260px;
        }
        .big-letter {
          font-size: 56px;
        }
      }
    </style>
  </head>
  <body>
    <!-- hero with <img> so cropping is reliable -->
    <section class="hero" id="hero" aria-label="Hero image">
      <img
        id="heroImg"
        alt="Maxwell banner"
        src="https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1"
      />
      <div class="hero-header">
        <div>
          <h1>Maxwell Events Countdown</h1>
          <div class="hint">2025-2026 schedule</div>
          <div
            class="controls"
            role="region"
            aria-label="Search and filters"
            style="margin-top: 12px"
          >
            <input
              id="searchBox"
              type="search"
              placeholder="Search events..."
              aria-label="Search events"
            />
            <select id="monthFilter" aria-label="Filter by month">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <div style="display: flex; gap: 8px; align-items: center">
              <button id="gridBtn" class="btn primary" title="Grid view">
                Grid
              </button>
              <button id="museumBtn" class="btn" title="Museum view">
                Museum
              </button>
              <button id="presentBtn" class="btn" title="Present mode">
                Present
              </button>
            </div>
          </div>
        </div>
        <div style="text-align: right; color: var(--hero-fg); font-weight: 700">
          Maxwell â€¢ 2025â€“26
        </div>
      </div>
    </section>

    <canvas
      id="stars"
      aria-hidden="true"
      style="position: fixed; inset: 0; z-index: -1; pointer-events: none"
    ></canvas>

    <!-- next up (unchanged) -->
    <section
      id="nextUp"
      style="
        display: none;
        max-width: 1200px;
        margin: 12px auto;
        padding: 12px 16px;
        border-left: 6px solid var(--accent);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: #072238;
        box-shadow: 0 8px 30px rgba(2, 8, 23, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      <div>
        <div style="font-weight: 700; color: #0b4b6f">Next Up</div>
        <div class="detail">
          <strong id="nextUpName">â€”</strong> <span id="nextUpDetail"></span>
        </div>
      </div>
      <div style="text-align: right">
        <div style="font-size: 12px; color: #0b2547">Tip</div>
        <div style="font-size: 12px; color: #07284f">
          Pin events using the ðŸ“Œ on cards or drag them into the right panel for
          quick access.
        </div>
      </div>
    </section>

    <!-- pinned column (right) -->
    <aside id="pinnedColumn" class="pinned-column" aria-label="Pinned events">
      <div class="panel-top">
        <strong style="font-size: 14px; color: #072238">Pinned</strong>
        <button
          id="pinCollapseBtn"
          class="collapse-btn"
          aria-pressed="false"
          title="Collapse panel"
        >
          â¤«
        </button>
      </div>
      <!-- pinned chips injected here -->
    </aside>

    <!-- always-visible toggle (handy on collapsed/mobile) -->
    <button id="pinnedToggleBtn" title="Toggle pinned panel">ðŸ“Œ</button>

    <main class="wrap">
      <div class="top-row">
        <div>
          <h1 id="pageTitle">School Events Countdown</h1>
          <div id="subtitle">2025-2026 schedule</div>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            color: #fff;
            font-weight: 700;
          "
        >
          Maxwell â€¢ 2025â€“26
        </div>
      </div>

      <div id="stage">
        <div id="eventsGrid" class="grid" aria-live="polite"></div>
      </div>
    </main>

    <script>
      /* ---------- data ---------- */
      const HERO_IMAGE =
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1";
      const NATURE_IMAGES = [
        HERO_IMAGE,
        "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1600&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1600&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1503264116251-35a269479413?w=1600&q=80&auto=format&fit=crop",
      ];

      const EVENTS = [
        { name: "Summer Holiday", start: "2025-08-01", end: "2025-08-09" },
        {
          name: "School Opening (Arrival & Dorm Move-in)",
          start: "2025-08-10",
          end: "2025-08-11",
        },
        { name: "First Semester Registration", start: "2025-08-11" },
        { name: "Orientation", start: "2025-08-12" },
        { name: "Faculty Family", start: "2025-09-07" },
        { name: "Picture Day", start: "2025-09-09" },
        { name: "Open Weekend", start: "2025-09-12", end: "2025-09-14" },
        { name: "Week of Prayer", start: "2025-09-15", end: "2025-09-20" },
        { name: "Camping Trip", start: "2025-09-21", end: "2025-09-23" },
        { name: "Online Parent-Teacher Conferences", start: "2025-09-30" },
        // midterm removed per request
        { name: "Midterm Break", start: "2025-10-09", end: "2025-10-20" },
        { name: "Music Sabbath", start: "2025-10-25" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2025-11-07",
          end: "2025-11-08",
        },
        { name: "MAP Testing", start: "2025-11-24", end: "2025-11-27" },
        { name: "Faculty Family", start: "2025-11-14" },
        { name: "Finals Review Week", start: "2025-12-01", end: "2025-12-05" },
        { name: "Final Exams 1st Sem", start: "2025-12-08", end: "2025-12-10" },
        { name: "Christmas Break", start: "2025-12-10", end: "2026-01-05" },
        { name: "School Opening (2nd Sem)", start: "2026-01-05" },
        {
          name: "Senior Government Day",
          start: "2026-01-20",
          end: "2026-01-21",
        },
        { name: "Faculty Family", start: "2026-01-30" },
        { name: "Junior Vespers", start: "2026-02-06" },
        { name: "NHS Applications Deadline", start: "2026-02-10" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2026-02-13",
          end: "2026-02-14",
        },
        { name: "ACT", start: "2026-02-13" },
        { name: "NHS Induction", start: "2026-02-17" },
        { name: "Mt. Kenya Trip", start: "2026-02-20", end: "2026-02-24" },
        { name: "Senior Dedication", start: "2026-02-27" },
        { name: "Sophomore Vespers", start: "2026-03-06" },
        {
          name: "Student-Led Week of Prayer",
          start: "2026-03-09",
          end: "2026-03-14",
        },
        { name: "Track and Field", start: "2026-03-19", end: "2026-03-20" },
        { name: "Chorale Sacred Concert", start: "2026-03-21" },
        { name: "Senior Class Trip", start: "2026-03-23", end: "2026-03-26" },
        { name: "Midterm Break", start: "2026-03-26", end: "2026-04-06" },
        {
          name: "Ethiopia Mission Trip",
          start: "2026-03-26",
          end: "2026-04-05",
        },
        { name: "ACT", start: "2026-04-10" },
        { name: "Freshmen Vespers", start: "2026-04-17" },
        { name: "Faculty Family", start: "2026-04-19" },
        { name: "Week of Prayer", start: "2026-04-20", end: "2026-04-25" },
        { name: "Long Weekend", start: "2026-04-30", end: "2026-05-03" },
        { name: "ASB Spirit Week", start: "2026-05-04", end: "2026-05-09" },
        { name: "Class Surveys", start: "2026-05-11", end: "2026-05-13" },
        { name: "ASB Elections", start: "2026-05-12" },
        { name: "Spring Concert", start: "2026-05-16" },
        { name: "MAP Testing", start: "2026-05-18", end: "2026-05-21" },
        { name: "Dorm Parties", start: "2026-05-23" },
        { name: "Dorm Outings", start: "2026-05-24" },
        { name: "Finals Review Week", start: "2026-05-25", end: "2026-05-29" },
        { name: "Zamani Night", start: "2026-05-30" },
        { name: "Elementary Graduation", start: "2026-05-31" },
        { name: "Final Exams 2nd Sem", start: "2026-06-02", end: "2026-06-04" },
        { name: "GRADDDDD!!!!", start: "2026-06-05", end: "2026-06-07" },
      ];

      const MONTH_COLORS = {
        "01": "#e74c3c",
        "02": "#ff8a65",
        "03": "#f6c85f",
        "04": "#8dd3c7",
        "05": "#66a3ff",
        "06": "#9b59b6",
        "07": "#f06292",
        "08": "#ffb84d",
        "09": "#6ab04c",
        10: "#4a90e2",
        11: "#34495e",
        12: "#7bdbdb",
      };

      /* ---------- helpers ---------- */
      function byId(id) {
        return document.getElementById(id);
      }
      function pad(n) {
        return n < 10 ? "0" + n : String(n);
      }
      function formatISO(d) {
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}`;
      }
      function shortMonth(d) {
        return d.toLocaleString("en", { month: "short" });
      }
      function formatDateBadge(start, end) {
        const s = parseStart(start);
        const e = end ? parseStart(end) : null;
        if (!e) return `${shortMonth(s)} ${s.getDate()}`;
        // same month
        if (
          s.getFullYear() === e.getFullYear() &&
          s.getMonth() === e.getMonth()
        )
          return `${shortMonth(s)} ${s.getDate()}â€“${e.getDate()}`;
        // different months (show short range)
        return `${shortMonth(s)} ${s.getDate()} â€“ ${shortMonth(
          e
        )} ${e.getDate()}`;
      }
      function slugify(name, idx) {
        return (
          String(name)
            .toLowerCase()
            .replace(/[â€™'\"]/g, "")
            .replace(/[:\/\\(),.!?#\u2013\u2014]/g, "")
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "") +
          "-" +
          idx
        );
      }
      function parseStart(s) {
        return s.includes("T") ? new Date(s) : new Date(s + "T00:00:00");
      }
      function parseEnd(e, start) {
        if (!e) {
          const d = new Date(start);
          d.setHours(23, 59, 59, 999);
          return d;
        }
        return e.includes("T") ? new Date(e) : new Date(e + "T23:59:59.999");
      }

      /* ---------- stars ---------- */
      (function () {
        const c = byId("stars");
        if (!c) return;
        const ctx = c.getContext("2d");
        function r() {
          c.width = innerWidth;
          c.height = innerHeight;
        }
        window.addEventListener("resize", r);
        r();
        const stars = Array.from({ length: 100 }, () => ({
          x: Math.random() * c.width,
          y: Math.random() * c.height,
          r: Math.random() * 1.4 + 0.2,
          dy: Math.random() * 0.6 + 0.02,
          alpha: 0.25 + Math.random() * 0.7,
        }));
        function t() {
          ctx.clearRect(0, 0, c.width, c.height);
          for (const s of stars) {
            ctx.globalAlpha =
              s.alpha * (0.7 + Math.sin(Date.now() / 1000 + s.x) * 0.3);
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            s.y += s.dy;
            if (s.y > c.height + 10) {
              s.y = -10;
              s.x = Math.random() * c.width;
            }
          }
          requestAnimationFrame(t);
        }
        t();
      })();

      /* ---------- state & persistence ---------- */
      let items = [];
      let tickHandle = null;
      let mode = "grid";
      const STORAGE_KEY = "school_events_positions_v2";
      const PINNED_KEY = "school_events_pinned_v2";
      const PIN_LIMIT = 6;
      const pinnedContainer = byId("pinnedColumn");
      function getPinned() {
        try {
          return JSON.parse(localStorage.getItem(PINNED_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }
      function setPinned(a) {
        localStorage.setItem(PINNED_KEY, JSON.stringify(a));
        renderPinnedRow();
      }
      function isPinned(i) {
        return getPinned().includes(i);
      }
      function togglePin(i) {
        const p = getPinned();
        const idx = p.indexOf(i);
        if (idx === -1) {
          p.unshift(i);
          while (p.length > 30) p.pop();
        } else p.splice(idx, 1);
        setPinned(p);
      }
      function savePosition(id, x, y) {
        try {
          const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
          s[id] = { x, y, savedAt: Date.now() };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        } catch (e) {
          console.warn(e);
        }
      }

      /* ---------- rendering ---------- */
      function sortEvents() {
        EVENTS.sort((a, b) => parseStart(a.start) - parseStart(b.start));
      }
      function findNextUpcoming() {
        const now = Date.now();
        return (
          EVENTS.find(
            (ev) => parseEnd(ev.end, parseStart(ev.start)).getTime() >= now
          ) || null
        );
      }
      function renderNextUp() {
        const n = findNextUpcoming();
        const b = byId("nextUp");
        if (!b) return;
        if (!n) {
          b.style.display = "none";
          return;
        }
        b.style.display = "flex";
        byId("nextUpName").textContent = n.name;
        byId("nextUpDetail").textContent = n.end
          ? `From ${formatISO(parseStart(n.start))} â†’ ${formatISO(
              parseStart(n.end)
            )}`
          : `On ${formatISO(parseStart(n.start))}`;
      }
      function clearTick() {
        if (tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
      }
      function clearRendered() {
        clearTick();
        items = [];
        const g = byId("eventsGrid");
        if (g) g.innerHTML = "";
        document.getElementById("stage").classList.remove("museum");
      }

      function renderAll() {
        clearRendered();
        sortEvents();
        renderNextUp();
        const grid = byId("eventsGrid");
        if (!grid) return;
        const q = (byId("searchBox").value || "").toLowerCase();
        const month = byId("monthFilter").value || "";
        EVENTS.forEach((ev, idx) => {
          if (q && !ev.name.toLowerCase().includes(q)) return;
          if (month && ev.start.slice(5, 7) !== month) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          const id = slugify(ev.name, idx);
          const img = NATURE_IMAGES[idx % NATURE_IMAGES.length];
          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("data-id", id);
          card.setAttribute("data-idx", idx);
          const mm = pad(start.getMonth() + 1);
          const monthColor = MONTH_COLORS[mm] || "#ccc";
          card.innerHTML = `<div class="month-strip" style="background:${monthColor}"></div><button class="pin-btn" title="Pin event" aria-label="Pin event" data-idx="${idx}">ðŸ“Œ</button><div class="big-letter" aria-hidden="true">${
            ev.name[0] || "E"
          }</div><div class="card-content"><div class="title" id="title-wrap-${id}"><span class="fill" id="title-fill-${id}">${
            ev.name
          }</span><span class="fallback" id="title-fallback-${id}">${
            ev.name
          }</span></div><div class="meta">${
            ev.end
              ? `${formatISO(start)} â†’ ${formatISO(parseStart(ev.end))}`
              : formatISO(start)
          }</div><div class="countdown" id="cd-${id}">â€”</div><div class="status" id="st-${id}">â€”</div><div class="date-badge" id="db-${id}">${formatDateBadge(
            ev.start,
            ev.end
          )}</div></div>`;
          grid.appendChild(card);
          items.push({ id, name: ev.name, start, end, el: card, img, idx });
          const pinBtn = card.querySelector(".pin-btn");
          if (pinBtn) {
            function refresh() {
              if (isPinned(idx)) pinBtn.classList.add("active");
              else pinBtn.classList.remove("active");
            }
            pinBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              togglePin(idx);
              refresh();
              renderPinnedRow();
            });
            refresh();
          }
          (function preloadAndApply(idLocal, url) {
            const imgObj = new Image();
            imgObj.crossOrigin = "anonymous";
            imgObj.onload = () => {
              const fill = byId("title-fill-" + idLocal);
              const fallback = byId("title-fallback-" + idLocal);
              if (fill) {
                fill.style.backgroundImage = `url('${url}')`;
                fill.style.backgroundSize = "cover";
                fill.style.backgroundPosition = "center";
                fill.style.opacity = "1";
                if (fallback) fallback.style.opacity = "0";
              }
            };
            imgObj.onerror = () => {};
            imgObj.src = url;
          })(id, img);
        });
        tickHandle = setInterval(() => {
          const now = new Date();
          items.forEach((i) => updateOne(i, now));
          updatePinnedCounts(now);
        }, 1000);
        items.forEach((i) => updateOne(i, new Date()));
        renderPinnedRow();
        updatePinnedCounts(new Date());
        applyMode();
      }

      function updateOne(item, now) {
        const { id, start, end, el } = item;
        const cd = byId("cd-" + id);
        const st = byId("st-" + id);
        if (!cd || !st) return;
        if (now.getTime() < start.getTime()) {
          el.classList.remove("happening", "finished");
          el.classList.add("upcoming");
          const diff = start.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s left`;
          st.innerHTML = "â³ Coming soon";
        } else if (now.getTime() > end.getTime()) {
          el.classList.remove("upcoming", "happening");
          el.classList.add("finished");
          cd.textContent = `Ended on ${formatISO(end)}`;
          st.innerHTML = "âœ… Finished";
        } else {
          el.classList.remove("upcoming", "finished");
          el.classList.add("happening");
          const diff = end.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          cd.textContent = `${d}d ${h}h ${m}m ${s}s remaining`;
          st.innerHTML = "ðŸ”´ Happening now";
        }
      }

      /* ---------- pinned column rendering ---------- */
      function renderPinnedRow() {
        const container = pinnedContainer || byId("pinnedColumn");
        if (!container) return; // remove old chips
        Array.from(container.querySelectorAll(".pinned-chip")).forEach((n) =>
          n.remove()
        );
        const now = new Date();
        const pinned = getPinned();
        const pinnedSet = new Set(pinned);
        const mapped = EVENTS.map((ev, idx) => ({
          ev,
          idx,
          start: parseStart(ev.start),
          end: parseEnd(ev.end, parseStart(ev.start)),
        }));
        const upcoming = mapped
          .filter((o) => o.end.getTime() >= now.getTime())
          .sort((a, b) => a.start - b.start);
        const finalPins = [];
        for (const p of pinned) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (EVENTS[p])
            finalPins.push({
              ev: EVENTS[p],
              idx: p,
              start: parseStart(EVENTS[p].start),
              end: parseEnd(EVENTS[p].end, parseStart(EVENTS[p].start)),
            });
        }
        for (const u of upcoming) {
          if (finalPins.length >= PIN_LIMIT) break;
          if (pinnedSet.has(u.idx)) continue;
          finalPins.push(u);
        }
        finalPins.forEach((o) => {
          const id = "pin_" + slugify(o.ev.name + "-" + o.idx, o.idx);
          const chip = document.createElement("button");
          chip.className = "pinned-chip";
          chip.setAttribute("tabindex", "0");
          chip.dataset.eventIndex = String(o.idx);
          chip.id = id;
          chip.innerHTML = `<div class="pinned-title">${
            o.ev.name
          }</div><div class="pinned-sub">${
            o.ev.end
              ? formatISO(o.start) + " â†’ " + formatISO(parseStart(o.ev.end))
              : formatISO(o.start)
          }</div><div class="pinned-count" id="count-${id}">â€”</div>`;
          chip.addEventListener("click", () => {
            const idx = Number(chip.dataset.eventIndex);
            const t = items.find((it) => it.idx === idx);
            if (t && t.el) {
              t.el.scrollIntoView({ behavior: "smooth", block: "center" });
              t.el.style.transition = "box-shadow .18s, transform .18s";
              t.el.style.boxShadow = "0 20px 60px rgba(255,180,60,0.32)";
              t.el.style.transform = "translateY(-8px)";
              setTimeout(() => {
                t.el.style.boxShadow = "";
                t.el.style.transform = "";
              }, 1200);
            }
          });
          container.appendChild(chip);
        });
        if (finalPins.length === 0) {
          const placeholder = document.createElement("div");
          placeholder.style.opacity = ".95";
          placeholder.style.color = "#072238";
          placeholder.style.fontSize = "14px";
          placeholder.textContent =
            "No pinned events â€” pin by clicking the ðŸ“Œ on a card or dragging a card here.";
          container.appendChild(placeholder);
        }
      }

      function updatePinnedCounts(now) {
        if (!now) now = new Date();
        const container = pinnedContainer || byId("pinnedColumn");
        if (!container) return;
        const pins = Array.from(container.querySelectorAll(".pinned-chip"));
        pins.forEach((chip) => {
          if (!chip.dataset.eventIndex) return;
          const idx = Number(chip.dataset.eventIndex);
          const ev = EVENTS[idx];
          if (!ev) return;
          const start = parseStart(ev.start);
          const end = parseEnd(ev.end, start);
          let txt = "";
          if (now.getTime() < start.getTime()) {
            const diff = start.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s left`;
          } else if (now.getTime() > end.getTime()) {
            const diff = now.getTime() - end.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `Ended ${d}d ${h}h ${m}m ${s}s ago`;
          } else {
            const diff = end.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            txt = `${d}d ${h}h ${m}m ${s}s remaining`;
          }
          const countEl = chip.querySelector(`#count-${chip.id}`);
          if (countEl) countEl.textContent = txt;
        });
      }

      /* ---------- drag & museum ---------- */
      function checkDropToPinned(el, idx) {
        const pinEl = pinnedContainer || byId("pinnedColumn");
        if (!pinEl) return false;
        const rect = el.getBoundingClientRect();
        const pinRect = pinEl.getBoundingClientRect();
        const overlap = !(
          rect.right < pinRect.left ||
          rect.left > pinRect.right ||
          rect.bottom < pinRect.top ||
          rect.top > pinRect.bottom
        );
        const nearRight = rect.right > pinRect.left - 40;
        if (overlap || nearRight) {
          togglePin(idx);
          renderPinnedRow();
          pinEl.classList.add("drop-target");
          setTimeout(() => pinEl.classList.remove("drop-target"), 600);
          const pinBtn = el.querySelector(".pin-btn");
          if (pinBtn) pinBtn.classList.toggle("active", isPinned(idx));
          return true;
        }
        return false;
      }

      function applyMode() {
        const stage = byId("stage");
        const grid = byId("eventsGrid");
        if (!stage || !grid) return;
        const saved = (function () {
          try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
          } catch (e) {
            return {};
          }
        })();
        if (mode === "museum") {
          stage.classList.add("museum");
          items.forEach((it, i) => {
            const el = it.el;
            el.style.position = "absolute";
            const savedPos = saved[it.id] || {};
            const left = savedPos.x ?? 20 + (i % 4) * 280;
            const top = savedPos.y ?? 20 + Math.floor(i / 4) * 220;
            el.style.left = left + "px";
            el.style.top = top + "px";
            el.style.width = "260px";
            el.style.zIndex = 50 + i;
            enableDrag(el, it.idx);
            el.addEventListener("pointermove", cardPointerTilt);
            el.addEventListener("pointerleave", cardResetTilt);
          });
        } else {
          stage.classList.remove("museum");
          items.forEach((it) => {
            const el = it.el;
            el.style.position = "";
            el.style.left = "";
            el.style.top = "";
            el.style.width = "";
            el.style.zIndex = "";
            disableDrag(el);
            el.removeEventListener("pointermove", cardPointerTilt);
            el.removeEventListener("pointerleave", cardResetTilt);
            el.style.transform = "";
          });
        }
      }

      function enableDrag(el, idx) {
        let dragging = false,
          startX = 0,
          startY = 0,
          origX = 0,
          origY = 0,
          pointerId = null;
        el.style.touchAction = "none";
        function down(e) {
          dragging = true;
          pointerId = e.pointerId;
          el.setPointerCapture(pointerId);
          startX = e.clientX;
          startY = e.clientY;
          origX = parseFloat(el.style.left || "0");
          origY = parseFloat(el.style.top || "0");
          el.style.transition = "none";
          el.style.cursor = "grabbing";
          el.style.zIndex = 9999;
        }
        function move(e) {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const GRID = 10;
          const x = Math.round((origX + dx) / GRID) * GRID;
          const y = Math.round((origY + dy) / GRID) * GRID;
          el.style.left = x + "px";
          el.style.top = y + "px";
        }
        function up(e) {
          if (!dragging) return;
          dragging = false;
          if (pointerId !== null) el.releasePointerCapture(pointerId);
          el.style.cursor = "grab";
          el.style.transition = "";
          el.style.zIndex = "";
          checkDropToPinned(el, idx);
          savePosition(
            el.getAttribute("data-id"),
            parseFloat(el.style.left || "0"),
            parseFloat(el.style.top || "0")
          );
        }
        el.addEventListener("pointerdown", down);
        el.addEventListener("pointermove", move);
        el.addEventListener("pointerup", up);
        el.__dragHandlers = { down, move, up };
      }
      function disableDrag(el) {
        const h = el.__dragHandlers;
        if (!h) return;
        el.removeEventListener("pointerdown", h.down);
        el.removeEventListener("pointermove", h.move);
        el.removeEventListener("pointerup", h.up);
        delete el.__dragHandlers;
      }
      function cardPointerTilt(e) {
        const rect = this.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const dx = e.clientX - cx;
        const dy = e.clientY - (rect.top + rect.height / 2);
        const rx = (dy / rect.height) * -6;
        const ry = (dx / rect.width) * 8;
        this.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(8px)`;
      }
      function cardResetTilt() {
        this.style.transform = "";
      }

      /* ---------- present & UI ---------- */
      function enterPresentMode() {
        document.body.classList.add("present-mode");
        try {
          document.documentElement.requestFullscreen?.();
        } catch (e) {}
      }
      function exitPresentMode() {
        document.body.classList.remove("present-mode");
        try {
          document.exitFullscreen?.();
        } catch (e) {}
      }

      function wireUI() {
        const gridBtn = byId("gridBtn"),
          museumBtn = byId("museumBtn"),
          presentBtn = byId("presentBtn"),
          searchBox = byId("searchBox"),
          monthFilter = byId("monthFilter"),
          pinCollapseBtn = byId("pinCollapseBtn"),
          pinnedToggle = byId("pinnedToggleBtn");
        if (gridBtn && museumBtn) {
          gridBtn.addEventListener("click", () => {
            mode = "grid";
            applyMode();
            gridBtn.classList.add("primary");
            museumBtn.classList.remove("primary");
          });
          museumBtn.addEventListener("click", () => {
            mode = "museum";
            applyMode();
            museumBtn.classList.add("primary");
            gridBtn.classList.remove("primary");
          });
        }
        if (presentBtn) presentBtn.addEventListener("click", enterPresentMode);
        document.addEventListener("keydown", (e) => {
          if (
            e.key === "Escape" &&
            document.body.classList.contains("present-mode")
          )
            exitPresentMode();
        });
        if (searchBox) searchBox.addEventListener("input", () => renderAll());
        if (monthFilter)
          monthFilter.addEventListener("change", () => renderAll());
        if (pinCollapseBtn) {
          pinCollapseBtn.addEventListener("click", () => {
            const panel = byId("pinnedColumn");
            if (!panel) return;
            panel.classList.toggle("collapsed");
            const pressed = panel.classList.contains("collapsed");
            pinCollapseBtn.setAttribute(
              "aria-pressed",
              pressed ? "true" : "false"
            );
            pinCollapseBtn.textContent = pressed ? "â¤¢" : "â¤«";
          });
        }
        if (pinnedToggle) {
          pinnedToggle.addEventListener("click", () => {
            const panel = byId("pinnedColumn");
            if (!panel) return;
            panel.classList.toggle("collapsed");
            pinnedToggle.classList.toggle("collapsed");
          });
        }
      }

      /* ---------- hero setup & init ---------- */
      function setHeroImage(url) {
        const img = byId("heroImg");
        if (img) img.src = url;
      }

      function init() {
        setHeroImage(HERO_IMAGE);
        wireUI();
        renderAll();
      }
      document.addEventListener("DOMContentLoaded", init);

      // debug
      window.__SE_DEBUG = { EVENTS, renderAll, items };
    </script>
  </body>
</html>
