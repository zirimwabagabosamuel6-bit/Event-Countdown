<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Maxwell Events — 2025–2026</title>
    <style>
      :root {
        --accent: #ffd24a;
        --accent-2: #ffb84d;
        --bg-dark: #031018;
        --muted: #072238;
        --panel-width: 360px;
        --card-radius: 12px;
        --glass: rgba(255, 255, 255, 0.06);
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background: linear-gradient(180deg, var(--bg-dark) 0%, #07131a 70%);
        color: #e9f6ff;
      }
      a {
        color: inherit;
      }
      /* HERO */
      .hero {
        max-width: 1200px;
        margin: 14px auto;
        height: 360px;
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 16px 60px rgba(0, 0, 0, 0.35);
      }
      .hero-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center top;
        display: block;
        transition: transform 0.6s;
      }
      @media (max-width: 900px) {
        .hero {
          height: 220px;
        }
        .hero-media {
          object-position: center center;
        }
      }
      .hero-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 28%,
          rgba(0, 0, 0, 0.82) 100%
        );
        pointer-events: none;
      }
      .hero-header {
        position: absolute;
        left: 22px;
        right: 22px;
        bottom: 18px;
        z-index: 6;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .hero-left {
        color: #fff;
      }
      .hero-title {
        font-weight: 900;
        font-size: 1.6rem;
        text-shadow: 0 8px 26px rgba(0, 0, 0, 0.35);
      }
      .hero-sub {
        opacity: 0.95;
        margin-top: 6px;
        font-weight: 700;
      }

      /* controls */
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      input[type="search"],
      select {
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        min-width: 150px;
      }
      .btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 12px;
        border-radius: 10px;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: var(--muted);
        border: none;
      }
      .mode-btn {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-weight: 800;
      }
      .mode-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: var(--muted);
        transform: translateY(-3px);
        box-shadow: 0 14px 40px rgba(255, 180, 40, 0.12);
      }

      /* month buttons */
      .month-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .month-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
      }
      .month-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: var(--muted);
      }

      /* layout */
      .wrap {
        max-width: 1200px;
        margin: 18px auto 120px;
        padding: 0 12px;
      }
      .top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
      }
      #pageTitle {
        font-size: 1.35rem;
        color: #fff;
      }
      #subtitle {
        color: rgba(255, 255, 255, 0.92);
        margin-top: 6px;
        font-weight: 600;
      }

      /* progress */
      .year-progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 999px;
        overflow: hidden;
        margin: 12px 0;
      }
      .year-progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        transition: width 0.4s;
      }

      /* grid */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }
      .month-heading {
        grid-column: 1/-1;
        padding: 10px 0;
        font-weight: 900;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      /* card */
      .card {
        position: relative;
        border-radius: var(--card-radius);
        background: linear-gradient(180deg, #ffffff, #fbfbfb);
        color: var(--muted);
        padding: 14px;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.12);
        display: flex;
        flex-direction: column;
        min-height: 200px;
        transition: transform 0.15s, box-shadow 0.15s, filter 0.3s;
      }
      .pin-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: var(--glass);
        cursor: pointer;
        font-weight: 800;
      }
      .pin-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
      }
      .month-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 8px;
        border-top-left-radius: var(--card-radius);
        border-bottom-left-radius: var(--card-radius);
      }
      .card-image {
        width: 100%;
        height: 120px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
        background: #ddd;
        display: flex;
        align-items: flex-start;
      }
      .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        object-position: top center;
      }
      @media (max-width: 900px) {
        .card-image img {
          object-position: center center;
        }
      }

      .title {
        min-height: 52px;
      }
      .title .name {
        font-weight: 900;
        font-size: 18px;
        color: var(--muted);
      }
      .meta {
        font-size: 13px;
        color: #37566a;
        min-height: 18px;
      }
      .countdown {
        font-weight: 800;
        font-size: 15px;
        color: var(--accent);
        min-height: 22px;
      }
      .status {
        font-size: 13px;
        color: #16344f;
        font-weight: 700;
        min-height: 20px;
      }
      .date-badge {
        align-self: flex-start;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(0, 0, 0, 0.04);
        font-weight: 800;
        color: var(--muted);
      }

      .big-letter {
        position: absolute;
        right: -12px;
        top: -18px;
        font-weight: 800;
        font-size: 64px;
        color: rgba(7, 18, 43, 0.06);
        pointer-events: none;
      }
      .card.finished {
        opacity: 0.55;
        filter: grayscale(60%);
      }
      .card.happening {
        box-shadow: 0 24px 70px rgba(255, 120, 70, 0.08);
        animation: lift 2.6s infinite;
      }
      @keyframes lift {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* pinned */
      .pinned-column {
        position: fixed;
        right: 18px;
        top: 110px;
        width: var(--panel-width);
        max-height: calc(100vh - 140px);
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        z-index: 999;
        background: #fff;
        border-radius: 12px;
        color: var(--muted);
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.36);
        transition: transform 0.35s, opacity 0.35s;
      }
      .pinned-column.hidden {
        transform: translateX(24px);
        opacity: 0;
        pointer-events: none;
      }
      .pinned-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pinned-chip {
        background: #fff;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .pinned-title {
        font-weight: 900;
        color: var(--muted);
      }
      .pinned-sub {
        font-size: 13px;
        color: #3b566e;
      }
      .pinned-count {
        font-weight: 800;
        color: var(--accent);
      }
      .pinned-progress {
        height: 8px;
        background: rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        overflow: hidden;
      }
      .pinned-progress > i {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        width: 0%;
      }
      #pinnedToggleBtn {
        position: fixed;
        right: 18px;
        top: 60%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(180deg, var(--accent), var(--accent-2));
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        font-weight: 900;
      }
      #pinnedToggleBtn.hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .pinned-column {
          right: 12px;
          left: 12px;
          bottom: 18px;
          top: auto;
          display: flex;
          flex-direction: row;
          max-height: 140px;
          padding: 8px;
          overflow: auto;
          border-radius: 14px;
        }
        .pinned-column.hidden {
          transform: translateY(24px);
          opacity: 0;
        }
        #pinnedToggleBtn {
          display: none;
        }
      }

      /* gallery squares */
      .gallery-wrap {
        max-width: 1200px;
        margin: 18px auto;
        padding: 0 12px;
      }
      .gallery-month {
        margin-bottom: 18px;
      }
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }
      .gallery-thumb {
        aspect-ratio: 1/1;
        border-radius: 10px;
        overflow: hidden;
        background: #ddd;
        display: block;
        position: relative;
        cursor: pointer;
      }
      .gallery-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.35s;
      }
      .gallery-thumb:hover img {
        transform: scale(1.06);
      }
      .gallery-caption {
        position: absolute;
        left: 8px;
        bottom: 8px;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
      }

      /* birthdays */
      .bd-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 8px;
      }
      .bd-card {
        background: linear-gradient(180deg, #fff, #fbfbfb);
        color: var(--muted);
        padding: 14px;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .bd-name {
        font-weight: 900;
        font-size: 16px;
      }
      .bd-date {
        color: #37566a;
        font-weight: 700;
      }
      .bd-countdown {
        font-weight: 800;
        color: var(--accent);
      }

      /* lightbox */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .lightbox.open {
        display: flex;
      }
      .lightbox img {
        max-width: 92%;
        max-height: 82%;
        object-fit: contain;
        border-radius: 10px;
      }
      .lightbox .caption {
        color: #fff;
        margin-top: 12px;
        font-weight: 700;
      }
      .lightbox .controls {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
      }
      .lightbox .thumbs {
        position: absolute;
        left: 50%;
        bottom: 20px;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
      }

      /* birthday popup (centered white box) */
      .bd-popup-wrap {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        pointer-events: none;
      }
      .bd-popup-wrap.show {
        display: flex;
        pointer-events: auto;
      }
      .bd-popup {
        min-width: 280px;
        max-width: 88%;
        padding: 18px 24px;
        border-radius: 12px;
        background: #fff;
        color: var(--muted);
        font-weight: 900;
        text-align: center;
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
        transform-origin: center;
        animation: bdIn 0.45s cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      .bd-popup .small {
        font-size: 14px;
        font-weight: 800;
        margin-top: 8px;
      }
      @keyframes bdIn {
        0% {
          transform: scale(0.92) translateY(-8px);
          opacity: 0;
        }
        60% {
          transform: scale(1.03);
          opacity: 1;
        }
        100% {
          transform: scale(1);
        }
      }

      /* confetti/fireworks canvases */
      #confettiCanvas,
      #fireCanvas {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2850;
      }

      /* small helpers */
      .muted-small {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.6);
      }
    </style>
  </head>
  <body>
    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <img
        id="heroMedia"
        class="hero-media"
        alt="Maxwell banner"
        src="https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1"
        crossorigin="anonymous"
      />
      <div class="hero-overlay"></div>
      <div class="hero-header">
        <div class="hero-left">
          <div class="hero-title">Maxwell Events Countdown</div>
          <div class="hero-sub" id="heroSubtitle">2025-2026 schedule</div>

          <div class="controls" role="region" aria-label="Search and filters">
            <input
              id="searchBox"
              type="search"
              placeholder="Search events..."
              aria-label="Search events"
            />
            <select id="monthFilter" aria-label="Filter by month">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>

            <div
              id="monthButtons"
              class="month-buttons"
              aria-hidden="false"
            ></div>

            <div style="display: flex; align-items: center; gap: 8px">
              <button id="gridBtn" class="mode-btn active" title="Grid view">
                Grid
              </button>
              <button id="museumBtn" class="mode-btn" title="Gallery (Museum)">
                Museum
              </button>
              <button id="birthBtn" class="mode-btn" title="Birthdays">
                Birthdays
              </button>
              <button id="presentBtn" class="mode-btn" title="Present">
                Present
              </button>
              <select
                id="themeSelect"
                title="Theme"
                style="margin-left: 8px; padding: 6px; border-radius: 8px"
              >
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
              <button id="savePrefs" class="btn">Save</button>
            </div>
          </div>
        </div>

        <div style="text-align: right; font-weight: 800; color: #fff">
          Maxwell • 2025–26
        </div>
      </div>
    </section>

    <!-- confetti/fireworks canvases -->
    <canvas id="confettiCanvas" aria-hidden="true"></canvas>
    <canvas id="fireCanvas" aria-hidden="true"></canvas>

    <!-- ambient -->
    <canvas
      id="stars"
      aria-hidden="true"
      style="position: fixed; inset: 0; z-index: -1; pointer-events: none"
    ></canvas>

    <!-- nextUp -->
    <section
      id="nextUp"
      style="
        display: none;
        max-width: 1200px;
        margin: 12px auto;
        padding: 12px 16px;
        border-left: 6px solid var(--accent);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.96);
        color: var(--muted);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      <div>
        <div style="font-weight: 800; color: #0b4b6f">Next Up</div>
        <div class="detail">
          <strong id="nextUpName">—</strong> <span id="nextUpDetail"></span>
        </div>
      </div>
      <div style="text-align: right">
        <div style="font-size: 12px; color: #37566a">Tip</div>
        <div style="font-size: 12px; color: #37566a">
          Pin events using the 📌 on cards. Pinned area appears on the right.
        </div>
      </div>
    </section>

    <!-- pinned -->
    <aside
      id="pinnedColumn"
      class="pinned-column hidden"
      aria-label="Pinned events"
    >
      <div class="pinned-top">
        <div style="font-weight: 900">Pinned</div>
        <div style="display: flex; gap: 8px">
          <button id="exportPins" class="btn" title="Export pinned">
            Export
          </button>
          <button id="clearPins" class="btn" title="Clear pins">Clear</button>
          <button id="pinCollapseBtn" class="btn" title="Hide panel">
            Hide
          </button>
        </div>
      </div>
      <!-- pinned items inserted here -->
    </aside>
    <button id="pinnedToggleBtn" class="hidden" title="Open pinned panel">
      📌
    </button>

    <main class="wrap">
      <div class="top-row">
        <div>
          <h1 id="pageTitle">School Events Countdown</h1>
          <div id="subtitle">2025-2026 schedule</div>
          <div class="year-progress" aria-hidden="true">
            <i id="yearProgressBar" style="width: 0%"></i>
          </div>
        </div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            color: #fff;
            font-weight: 700;
          "
        >
          Maxwell • 2025–26
        </div>
      </div>

      <!-- small uploader and google drive helper -->
      <section
        style="
          max-width: 1200px;
          margin: 6px auto 18px;
          padding: 12px;
          border-radius: 10px;
          background: rgba(255, 255, 255, 0.02);
        "
      >
        <div
          style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap"
        >
          <input id="uploadInput" type="file" accept="image/*" multiple />
          <button id="uploadBtn" class="btn">Upload images</button>
          <button id="clearUploads" class="btn">Clear uploads</button>
          <input
            id="gdriveInput"
            type="text"
            placeholder="Paste Drive links / IDs (comma separated)"
            style="
              min-width: 320px;
              padding: 8px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.06);
              background: transparent;
              color: #fff;
            "
          />
          <button id="importDriveBtn" class="btn">Import Drive (public)</button>
          <div style="margin-left: auto; color: #fff; font-weight: 700">
            Browser uploads stored locally
          </div>
        </div>
        <div
          id="uploadsPreview"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 12px;
          "
        ></div>
      </section>

      <!-- Gallery (museum) -->
      <section
        id="gallerySection"
        class="gallery-wrap"
        style="display: none"
      ></section>

      <!-- Birthdays -->
      <section id="birthdaySection" style="display: none">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <div>
            <strong style="color: #fff">Birthdays</strong>
            <div style="color: rgba(255, 255, 255, 0.75)">
              Countdowns to upcoming birthdays
            </div>
          </div>
        </div>
        <div id="bdGrid" class="bd-grid"></div>
      </section>

      <!-- Event grid -->
      <section id="stage">
        <div id="eventsGrid" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <!-- lightbox -->
    <div
      id="lightbox"
      class="lightbox"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="controls"
        style="
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 24px;
        "
      >
        <button id="lbPrev" class="btn">◀</button>
        <button id="lbNext" class="btn">▶</button>
      </div>
      <div style="text-align: center; max-width: 95%">
        <img id="lbImage" alt="" />
        <div
          class="caption"
          id="lbCaption"
          style="color: #fff; font-weight: 800; margin-top: 12px"
        ></div>
        <div style="margin-top: 12px">
          <button id="lbClose" class="btn">Close</button>
        </div>
      </div>
      <div class="thumbs" id="lbThumbs"></div>
    </div>

    <!-- birthday popup -->
    <div id="bdPopupWrap" class="bd-popup-wrap" aria-hidden="true">
      <div
        id="bdPopup"
        class="bd-popup"
        role="status"
        aria-live="assertive"
      ></div>
    </div>

    <script>
      /* ---------------- Data (events, default gallery, birthdays) ---------------- */
      const HERO =
        "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/04/VideoCover-1.jpeg?resize=767%2C500&ssl=1";

      const EVENTS = [
        { name: "Summer Holiday", start: "2025-08-01", end: "2025-08-09" },
        {
          name: "School Opening (Arrival & Dorm Move-in)",
          start: "2025-08-10",
          end: "2025-08-11",
        },
        { name: "First Semester Registration", start: "2025-08-11" },
        { name: "Orientation", start: "2025-08-12" },
        { name: "Faculty Family", start: "2025-09-07" },
        { name: "Picture Day", start: "2025-09-09" },
        { name: "Open Weekend", start: "2025-09-12", end: "2025-09-14" },
        { name: "Week of Prayer", start: "2025-09-15", end: "2025-09-20" },
        { name: "Camping Trip", start: "2025-09-21", end: "2025-09-23" },
        { name: "Online Parent-Teacher Conferences", start: "2025-09-30" },
        { name: "Midterm Break", start: "2025-10-09", end: "2025-10-20" },
        { name: "Music Sabbath", start: "2025-10-25" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2025-11-07",
          end: "2025-11-08",
        },
        { name: "MAP Testing", start: "2025-11-24", end: "2025-11-27" },
        { name: "Faculty Family", start: "2025-11-14" },
        { name: "Finals Review Week", start: "2025-12-01", end: "2025-12-05" },
        { name: "Final Exams 1st Sem", start: "2025-12-08", end: "2025-12-10" },
        { name: "Christmas Break", start: "2025-12-10", end: "2026-01-05" },
        { name: "School Opening (2nd Sem)", start: "2026-01-05" },
        {
          name: "Senior Government Day",
          start: "2026-01-20",
          end: "2026-01-21",
        },
        { name: "Faculty Family", start: "2026-01-30" },
        { name: "Junior Vespers", start: "2026-02-06" },
        { name: "NHS Applications Deadline", start: "2026-02-10" },
        {
          name: "Weekend of Spiritual Emphasis",
          start: "2026-02-13",
          end: "2026-02-14",
        },
        { name: "ACT", start: "2026-02-13" },
        { name: "NHS Induction", start: "2026-02-17" },
        { name: "Mt. Kenya Trip", start: "2026-02-20", end: "2026-02-24" },
        { name: "Senior Dedication", start: "2026-02-27" },
        { name: "Sophomore Vespers", start: "2026-03-06" },
        {
          name: "Student-Led Week of Prayer",
          start: "2026-03-09",
          end: "2026-03-14",
        },
        { name: "Track and Field", start: "2026-03-19", end: "2026-03-20" },
        { name: "Chorale Sacred Concert", start: "2026-03-21" },
        { name: "Senior Class Trip", start: "2026-03-23", end: "2026-03-26" },
        { name: "Midterm Break", start: "2026-03-26", end: "2026-04-06" },
        {
          name: "Ethiopia Mission Trip",
          start: "2026-03-26",
          end: "2026-04-05",
        },
        { name: "ACT", start: "2026-04-10" },
        { name: "Freshmen Vespers", start: "2026-04-17" },
        { name: "Faculty Family", start: "2026-04-19" },
        { name: "Week of Prayer", start: "2026-04-20", end: "2026-04-25" },
        { name: "Long Weekend", start: "2026-04-30", end: "2026-05-03" },
        { name: "ASB Spirit Week", start: "2026-05-04", end: "2026-05-09" },
        { name: "Class Surveys", start: "2026-05-11", end: "2026-05-13" },
        { name: "ASB Elections", start: "2026-05-12" },
        { name: "Spring Concert", start: "2026-05-16" },
        { name: "MAP Testing", start: "2026-05-18", end: "2026-05-21" },
        { name: "Dorm Parties", start: "2026-05-23" },
        { name: "Dorm Outings", start: "2026-05-24" },
        { name: "Finals Review Week", start: "2026-05-25", end: "2026-05-29" },
        { name: "Zamani Night", start: "2026-05-30" },
        { name: "Elementary Graduation", start: "2026-05-31" },
        { name: "Final Exams 2nd Sem", start: "2026-06-02", end: "2026-06-04" },
        { name: "GRADDDDD!!!!", start: "2026-06-05", end: "2026-06-07" },
      ];

      const MONTH_COLORS = {
        "01": "#e74c3c",
        "02": "#ff8a65",
        "03": "#f6c85f",
        "04": "#8dd3c7",
        "05": "#66a3ff",
        "06": "#9b59b6",
        "07": "#f06292",
        "08": "#ffb84d",
        "09": "#6ab04c",
        10: "#4a90e2",
        11: "#34495e",
        12: "#7bdbdb",
      };

      const DEFAULT_GALLERY = [
        // campus images (replacements you supplied)
        {
          src: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmV27Af6dGvJoR-LVUGmkCauwQepWKLwi7Zw&s",
          caption: "Campus 1",
          section: "Campus",
          month: "08",
          year: 2025,
        },
        {
          src: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHDr-_KeMgIf8tN3PHxytKFN7lbUhaLuPpkQ&s",
          caption: "Campus 2",
          section: "Campus",
          month: "08",
          year: 2025,
        },
        {
          src: "https://static.wixstatic.com/media/b62f56_ce88667acf42430fbea4c12175730dd3.jpg",
          caption: "Campus 3",
          section: "Campus",
          month: "08",
          year: 2025,
        },
        {
          src: "https://i0.wp.com/maxwellsda.org/wp-content/uploads/2025/03/EsoPheb.jpeg?fit=1400%2C1400&ssl=1",
          caption: "Campus 4",
          section: "Campus",
          month: "08",
          year: 2025,
        },
        // more images (fallbacks)
        {
          src: HERO,
          caption: "Banner",
          section: "Monthly",
          month: "09",
          year: 2025,
        },
      ];

      const BIRTHDAYS = [
        { name: "Tereza Poniatovska", month: 9, day: 11 },
        { name: "Tendai Castroe", month: 9, day: 20 },
        { name: "Arcella Ineza", month: 9, day: 25 }, // removed comma
        { name: "Salome Lwanzo", month: 9, day: 25 },
        { name: "Adrian Ochieng", month: 9, day: 2 },
        { name: "Julian Tito Omonte", month: 9, day: 25 },
        { name: "Jael Tito Omonte", month: 9, day: 25 },
        { name: "Ethan Wenyika", month: 9, day: 4 },
        { name: "Michael Nyange", month: 9, day: 14 },
        { name: "Daniela Daniel", month: 9, day: 17 },
        { name: "Kris Koome", month: 9, day: 6 },
        { name: "Betty Kamawu", month: 9, day: 24 },
      ];

      /* ---------------- helpers ---------------- */
      const $ = (id) => document.getElementById(id);
      const pad = (n) => (n < 10 ? "0" + n : String(n));
      const parseStart = (s) =>
        s.includes("T") ? new Date(s) : new Date(s + "T00:00:00");
      const parseEnd = (e, start) => {
        if (!e) {
          const d = new Date(start);
          d.setHours(23, 59, 59, 999);
          return d;
        }
        return e.includes("T") ? new Date(e) : new Date(e + "T23:59:59.999");
      };
      function shortMonth(n) {
        return new Date(2000, n - 1, 1).toLocaleString("en", {
          month: "short",
        });
      }
      function slugify(name, idx) {
        return (
          String(name)
            .toLowerCase()
            .replace(/[’'"]/g, "")
            .replace(/[:\/\\(),.!?#\u2013\u2014]/g, "")
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "") +
          "-" +
          idx
        );
      }
      function eventIcon(name) {
        const n = name.toLowerCase();
        if (/exam|final|midterm|test|act|map/.test(n)) return "📝";
        if (
          /break|holiday|christmas|spring|long weekend|summer|vacation/.test(n)
        )
          return "🎉";
        if (/trip|camp|mt|mountain|mission/.test(n)) return "🏕️";
        if (/concert|chorale|music/.test(n)) return "🎵";
        if (/sports|track|field/.test(n)) return "🏅";
        return "📅";
      }

      /* ---------------- simple persistent image store (IndexedDB) ---------------- */
      const IDB = (function () {
        const DB_NAME = "maxwell_db_v2",
          DB_VER = 1;
        let db = null;
        function open() {
          return new Promise((res, rej) => {
            if (db) return res(db);
            const rq = indexedDB.open(DB_NAME, DB_VER);
            rq.onupgradeneeded = (e) => {
              const d = e.target.result;
              if (!d.objectStoreNames.contains("uploads"))
                d.createObjectStore("uploads", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              if (!d.objectStoreNames.contains("eventImages"))
                d.createObjectStore("eventImages", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              if (!d.objectStoreNames.contains("meta"))
                d.createObjectStore("meta", { keyPath: "k" });
            };
            rq.onsuccess = () => {
              db = rq.result;
              res(db);
            };
            rq.onerror = () => rej(rq.error);
          });
        }
        async function store(storeName, value) {
          const d = await open();
          return new Promise((res, rej) => {
            const tx = d.transaction(storeName, "readwrite");
            const s = tx.objectStore(storeName);
            const r = s.add(value);
            r.onsuccess = () => res(r.result);
            r.onerror = () => rej(r.error);
          });
        }
        async function getAll(storeName) {
          const d = await open();
          return new Promise((res, rej) => {
            const tx = d.transaction(storeName);
            const s = tx.objectStore(storeName);
            const r = s.getAll();
            r.onsuccess = () => res(r.result);
            r.onerror = () => rej(r.error);
          });
        }
        async function clear(storeName) {
          const d = await open();
          return new Promise((res, rej) => {
            const tx = d.transaction(storeName, "readwrite");
            const s = tx.objectStore(storeName);
            const r = s.clear();
            r.onsuccess = () => res();
            r.onerror = () => rej(r.error);
          });
        }
        return {
          putUpload: (blob, name) =>
            store("uploads", { blob, name, created: Date.now() }),
          getAllUploads: () => getAll("uploads"),
          clearUploads: () => clear("uploads"),
          putEventImage: (idx, blob, name) =>
            store("eventImages", {
              eventIdx: idx,
              blob,
              name,
              created: Date.now(),
            }),
          getEventImagesByIdx: async (idx) => {
            const all = await getAll("eventImages");
            return all.filter((a) => a.eventIdx === idx);
          },
          getAllEventImages: () => getAll("eventImages"),
        };
      })();

      /* ---------------- starfield background ---------------- */
      (function () {
        const c = $("stars");
        if (!c) return;
        const ctx = c.getContext("2d");
        function resize() {
          c.width = innerWidth;
          c.height = innerHeight;
        }
        window.addEventListener("resize", resize);
        resize();
        const stars = Array.from({ length: 90 }, () => ({
          x: Math.random() * c.width,
          y: Math.random() * c.height,
          r: Math.random() * 1.6 + 0.2,
          dy: Math.random() * 0.5 + 0.02,
          alpha: 0.15 + Math.random() * 0.6,
        }));
        function frame() {
          ctx.clearRect(0, 0, c.width, c.height);
          for (const s of stars) {
            ctx.globalAlpha =
              s.alpha * (0.6 + Math.sin(Date.now() / 1000 + s.x) * 0.3);
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fillStyle = "#fff";
            ctx.fill();
            s.y += s.dy;
            if (s.y > c.height + 10) {
              s.y = -10;
              s.x = Math.random() * c.width;
            }
          }
          requestAnimationFrame(frame);
        }
        frame();
      })();

      /* ---------------- core rendering ---------------- */
      let items = [],
        tickHandle = null;

      function sortEvents() {
        EVENTS.sort((a, b) => parseStart(a.start) - parseStart(b.start));
      }
      function findNext() {
        const now = Date.now();
        return (
          EVENTS.find(
            (ev) => parseEnd(ev.end, parseStart(ev.start)).getTime() >= now
          ) || null
        );
      }
      function renderNextUp() {
        const n = findNext();
        const b = $("nextUp");
        if (!b) return;
        if (!n) {
          b.style.display = "none";
          return;
        }
        b.style.display = "flex";
        $("nextUpName").textContent = n.name;
        $("nextUpDetail").textContent = n.end
          ? `From ${formatISO(parseStart(n.start))} → ${formatISO(
              parseStart(n.end)
            )}`
          : `On ${formatISO(parseStart(n.start))}`;
      }
      function formatISO(d) {
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}`;
      }

      function updateOne(item, now) {
        const { id, start, end, el } = item;
        const cd = document.getElementById("cd-" + id),
          st = document.getElementById("st-" + id);
        if (!cd || !st) return;
        if (now.getTime() < start.getTime()) {
          el.classList.remove("happening", "finished");
          el.classList.add("upcoming");
          const diff = start.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000),
            h = Math.floor((diff % 86400000) / 3600000),
            m = Math.floor((diff % 3600000) / 60000);
          cd.textContent = `${d}d ${h}h ${m}m left`;
          st.textContent = "⏳ Coming soon";
        } else if (now.getTime() > end.getTime()) {
          el.classList.remove("upcoming", "happening");
          el.classList.add("finished");
          cd.textContent = `Ended ${formatISO(end)}`;
          st.textContent = "✅ Finished";
        } else {
          el.classList.remove("upcoming", "finished");
          el.classList.add("happening");
          const diff = end.getTime() - now.getTime();
          const d = Math.floor(diff / 86400000),
            h = Math.floor((diff % 86400000) / 3600000),
            m = Math.floor((diff % 3600000) / 60000);
          cd.textContent = `${d}d ${h}h ${m}m remaining`;
          st.textContent = "🔴 Happening now";
        }
      }

      /* renderAll - builds grid with consistent spacing and image handling */
      async function renderAll() {
        if (tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
        items = [];
        sortEvents();
        renderNextUp();
        const grid = $("eventsGrid");
        grid.innerHTML = "";
        const q = ($("searchBox").value || "").toLowerCase();
        const monthVal = $("monthFilter").value || "";

        const allEventImages = await IDB.getAllEventImages();

        let currentGroup = "";
        EVENTS.forEach((ev, idx) => {
          if (q && !ev.name.toLowerCase().includes(q)) return;
          if (monthVal && ev.start.slice(5, 7) !== monthVal) return;

          const start = parseStart(ev.start);
          const mmKey = `${start.getFullYear()}-${pad(start.getMonth() + 1)}`;
          if (mmKey !== currentGroup) {
            currentGroup = mmKey;
            const heading = document.createElement("div");
            heading.className = "month-heading";
            heading.textContent = `${start.toLocaleString("en", {
              month: "long",
            })} ${start.getFullYear()}`;
            heading.dataset.mm = pad(start.getMonth() + 1);
            heading.addEventListener("click", () => {
              $("monthFilter").value = heading.dataset.mm;
              highlightMonthButton(heading.dataset.mm);
              renderAll();
            });
            grid.appendChild(heading);
          }

          const startDate = parseStart(ev.start);
          const endDate = parseEnd(ev.end, startDate);
          const id = slugify(ev.name, idx);
          const monthColor =
            MONTH_COLORS[pad(startDate.getMonth() + 1)] || "#ccc";

          const imgs = allEventImages.filter((i) => i.eventIdx === idx);
          const firstImgURL = imgs.length
            ? URL.createObjectURL(imgs[0].blob)
            : HERO;

          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("data-idx", idx);
          card.setAttribute("data-id", id);
          card.innerHTML = `
      <div class="month-strip" style="background:${monthColor}"></div>
      <button class="pin-btn" title="Pin event" aria-label="Pin event" data-idx="${idx}">📌</button>
      <div class="card-image"><img src="${firstImgURL}" alt="${ev.name}"></div>
      <div class="card-content">
        <div class="title"><div class="name">${ev.name}</div></div>
        <div class="meta">${eventIcon(ev.name)} ${
            ev.end
              ? `${formatISO(startDate)} → ${formatISO(parseStart(ev.end))}`
              : formatISO(startDate)
          }</div>
        <div class="countdown" id="cd-${id}">—</div>
        <div class="status" id="st-${id}">—</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div class="date-badge">${dateBadge(ev.start, ev.end)}</div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <label style="display:flex;align-items:center;gap:6px">
              <input type="file" accept="image/*" multiple data-idx="${idx}" style="display:none" class="attach-input">
              <button class="btn attach-btn">📷 Attach</button>
            </label>
            <button class="btn view-gallery-btn">${
              imgs.length ? imgs.length + " image(s)" : "Open gallery"
            }</button>
          </div>
        </div>
      </div>
    `;
          grid.appendChild(card);

          items.push({ id, start: startDate, end: endDate, el: card, idx });

          const pb = card.querySelector(".pin-btn");
          if (pb) {
            const refresh = () =>
              pb.classList.toggle("active", getPinned().includes(idx));
            pb.addEventListener("click", (e) => {
              e.stopPropagation();
              togglePin(idx);
              refresh();
            });
            refresh();
          }

          // attach input
          const attachBtn = card.querySelector(".attach-btn");
          const attachInput = card.querySelector(".attach-input");
          attachBtn.addEventListener("click", () => attachInput.click());
          attachInput.addEventListener("change", async (ev) => {
            const files = Array.from(ev.target.files || []);
            for (const f of files) await IDB.putEventImage(idx, f, f.name);
            renderAll();
          });

          const viewBtn = card.querySelector(".view-gallery-btn");
          viewBtn.addEventListener("click", async () => {
            const imgs = await IDB.getEventImagesByIdx(idx);
            const photos = imgs.length
              ? imgs.map((x) => ({
                  src: URL.createObjectURL(x.blob),
                  caption: EVENTS[idx].name,
                }))
              : [{ src: HERO, caption: EVENTS[idx].name }];
            openLightbox(photos, 0);
          });

          card.tabIndex = 0;
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") card.click();
          });

          addSwipeToPin(card, idx);
        });

        // tick
        tickHandle = setInterval(() => {
          const now = new Date();
          items.forEach((i) => updateOne(i, now));
          updatePinnedCounts(now);
        }, 1000);
        items.forEach((i) => updateOne(i, new Date()));
        renderPinnedPanel();
        updateYearProgress();
        applyModeUI(); // ensures gallery/birthdays visibility consistent
      }

      /* helper: date badge */
      function dateBadge(start, end) {
        const s = parseStart(start);
        if (!end) return `${shortMonth(s.getMonth() + 1)} ${s.getDate()}`;
        const e = parseStart(end);
        if (
          s.getFullYear() === e.getFullYear() &&
          s.getMonth() === e.getMonth()
        )
          return `${shortMonth(
            s.getMonth() + 1
          )} ${s.getDate()}–${e.getDate()}`;
        return `${shortMonth(s.getMonth() + 1)} ${s.getDate()} – ${shortMonth(
          e.getMonth() + 1
        )} ${e.getDate()}`;
      }

      /* ---------------- pinned panel ---------------- */
      function getPinned() {
        try {
          return JSON.parse(localStorage.getItem("maxwell_pinned_v2") || "[]");
        } catch (e) {
          return [];
        }
      }
      function setPinned(arr) {
        localStorage.setItem("maxwell_pinned_v2", JSON.stringify(arr));
        renderPinnedPanel();
      }
      function togglePin(i) {
        const arr = getPinned();
        const p = arr.indexOf(i);
        if (p === -1) {
          arr.unshift(i);
          while (arr.length > 50) arr.pop();
        } else arr.splice(p, 1);
        setPinned(arr);
      }
      function renderPinnedPanel() {
        const container = $("pinnedColumn");
        if (!container) return;
        const header = container.querySelector(".pinned-top");
        container.innerHTML = "";
        if (header) container.appendChild(header);
        const pins = getPinned();
        if (!pins || pins.length === 0) {
          container.classList.add("hidden");
          $("pinnedToggleBtn").classList.add("hidden");
          return;
        }
        container.classList.remove("hidden");
        $("pinnedToggleBtn").classList.remove("hidden");
        const now = new Date();
        pins.forEach((idx) => {
          if (EVENTS[idx] === undefined) return;
          const ev = EVENTS[idx];
          const s = parseStart(ev.start),
            e = parseEnd(ev.end, s);
          const chip = document.createElement("div");
          chip.className = "pinned-chip";
          chip.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div class="pinned-title">${
            ev.name
          }</div><div class="pinned-sub">${
            ev.end
              ? formatISO(s) + " → " + formatISO(parseStart(ev.end))
              : formatISO(s)
          }</div></div><div style="text-align:right"><div class="pinned-count" id="count-pin-${idx}">—</div></div></div><div class="pinned-progress"><i style="width:0%"></i></div>`;
          chip.addEventListener("click", () => {
            const target = items.find((it) => it.idx === idx);
            if (target && target.el) {
              target.el.scrollIntoView({ behavior: "smooth", block: "center" });
              target.el.style.boxShadow = "0 30px 80px rgba(255,180,60,0.22)";
              setTimeout(() => (target.el.style.boxShadow = ""), 1200);
            }
          });
          container.appendChild(chip);
        });
        updatePinnedCounts(new Date());
      }
      function updatePinnedCounts(now) {
        if (!now) now = new Date();
        const pins = getPinned();
        pins.forEach((idx) => {
          const ev = EVENTS[idx];
          if (!ev) return;
          const s = parseStart(ev.start),
            e = parseEnd(ev.end, s);
          let txt = "",
            pct = 0;
          if (now.getTime() < s.getTime()) {
            const diff = s.getTime() - now.getTime();
            const d = Math.floor(diff / 86400000),
              h = Math.floor((diff % 86400000) / 3600000),
              m = Math.floor((diff % 3600000) / 60000);
            txt = `${d}d ${h}h ${m}m left`;
            pct = 0;
          } else if (now.getTime() > e.getTime()) {
            const diff = now.getTime() - e.getTime();
            const d = Math.floor(diff / 86400000);
            txt = `Ended ${d}d ago`;
            pct = 100;
          } else {
            const total = e.getTime() - s.getTime(),
              remaining = e.getTime() - now.getTime(),
              passed = total - remaining;
            pct = Math.round((passed / total) * 100);
            const d = Math.floor(remaining / 86400000),
              h = Math.floor((remaining % 86400000) / 3600000),
              m = Math.floor((remaining % 3600000) / 60000);
            txt = `${d}d ${h}h ${m}m remaining`;
          }
          const el = document.getElementById("count-pin-" + idx);
          if (el) el.textContent = txt;
          const chip = el && el.closest(".pinned-chip");
          if (chip) {
            const bar = chip.querySelector(".pinned-progress i");
            if (bar) bar.style.width = pct + "%";
          }
        });
      }

      /* ---------------- swipe-to-pin (mobile) ---------------- */
      function addSwipeToPin(card, idx) {
        if (!card) return;
        let down = false,
          sx = 0,
          sy = 0,
          moved = false;
        function onDown(e) {
          down = true;
          sx = e.clientX;
          sy = e.clientY;
          moved = false;
        }
        function onMove(e) {
          if (!down) return;
          const dx = e.clientX - sx,
            dy = e.clientY - sy;
          if (Math.abs(dx) > 8 && Math.abs(dx) > Math.abs(dy)) moved = true;
          if (moved)
            card.style.transform = `translateX(${Math.min(
              Math.max(dx, -60),
              60
            )}px)`;
        }
        function onUp(e) {
          if (!down) return;
          down = false;
          if (moved) {
            const dx = e.clientX - sx;
            if (dx > 60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.add("active");
            } else if (dx < -60) {
              togglePin(idx);
              renderPinnedPanel();
              const pb = card.querySelector(".pin-btn");
              if (pb) pb.classList.remove("active");
            }
            card.style.transform = "";
          }
        }
        card.addEventListener("pointerdown", onDown);
        card.addEventListener("pointermove", onMove);
        card.addEventListener("pointerup", onUp);
        card.addEventListener("pointercancel", onUp);
      }

      /* ---------------- gallery & lightbox ---------------- */
      async function renderGallery() {
        const wrap = $("gallerySection");
        if (!wrap) return;
        wrap.innerHTML = "";
        // Load uploads
        const uploads = await IDB.getAllUploads();
        const groups = {};
        DEFAULT_GALLERY.forEach((p) =>
          (groups[p.section] = groups[p.section] || []).push(p)
        );
        if (uploads && uploads.length)
          groups["Uploads"] = uploads.map((u) => ({
            src: URL.createObjectURL(u.blob),
            caption: u.name || "Upload",
            section: "Uploads",
          }));
        Object.keys(groups).forEach((section) => {
          const sec = document.createElement("div");
          sec.className = "gallery-month";
          const heading = document.createElement("div");
          heading.className = "month-heading";
          heading.textContent = section;
          sec.appendChild(heading);
          const grid = document.createElement("div");
          grid.className = "gallery-grid";
          groups[section].forEach((p, i) => {
            const t = document.createElement("div");
            t.className = "gallery-thumb";
            t.innerHTML = `<img src="${p.src}" alt="${p.caption}"><div class="gallery-caption">${p.caption}</div>`;
            t.addEventListener("click", () => openLightbox(groups[section], i));
            grid.appendChild(t);
          });
          sec.appendChild(grid);
          wrap.appendChild(sec);
        });
      }

      let lbPhotos = [],
        lbIndex = 0;
      function openLightbox(photos, idx) {
        lbPhotos = photos;
        lbIndex = idx;
        $("lbImage").src = photos[idx].src;
        $("lbCaption").textContent = photos[idx].caption || "";
        $("lightbox").classList.add("open");
        $("lightbox").setAttribute("aria-hidden", "false");
        renderLightboxThumbs();
      }
      function closeLightbox() {
        $("lightbox").classList.remove("open");
        $("lightbox").setAttribute("aria-hidden", "true");
      }
      function lbNext() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex + 1) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption || "";
        renderLightboxThumbs();
      }
      function lbPrev() {
        if (!lbPhotos.length) return;
        lbIndex = (lbIndex - 1 + lbPhotos.length) % lbPhotos.length;
        $("lbImage").src = lbPhotos[lbIndex].src;
        $("lbCaption").textContent = lbPhotos[lbIndex].caption || "";
        renderLightboxThumbs();
      }
      function renderLightboxThumbs() {
        const wrap = $("lbThumbs");
        wrap.innerHTML = "";
        lbPhotos.forEach((p, i) => {
          const img = document.createElement("img");
          img.src = p.src;
          img.style.width = "48px";
          img.style.height = "48px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "6px";
          img.style.cursor = "pointer";
          img.style.opacity = i === lbIndex ? "1" : "0.6";
          img.addEventListener("click", () => {
            lbIndex = i;
            $("lbImage").src = p.src;
            $("lbCaption").textContent = p.caption || "";
            renderLightboxThumbs();
          });
          wrap.appendChild(img);
        });
      }
      $("lbClose").addEventListener("click", closeLightbox);
      $("lbNext").addEventListener("click", lbNext);
      $("lbPrev").addEventListener("click", lbPrev);
      document.addEventListener("keydown", (e) => {
        const l = $("lightbox");
        if (l.classList.contains("open")) {
          if (e.key === "ArrowRight") lbNext();
          if (e.key === "ArrowLeft") lbPrev();
          if (e.key === "Escape") closeLightbox();
        }
      });

      /* ---------------- birthdays: render grid + popups ---------------- */
      function renderBirthdays() {
        const grid = $("bdGrid");
        grid.innerHTML = "";
        const now = new Date();
        BIRTHDAYS.forEach((bd, i) => {
          // next occurrence
          const y = now.getFullYear();
          let occ = new Date(y, bd.month - 1, bd.day);
          if (occ < new Date(now.getFullYear(), now.getMonth(), now.getDate()))
            occ = new Date(y + 1, bd.month - 1, bd.day);
          const diff = occ.getTime() - now.getTime();
          const days = Math.floor(Math.abs(diff) / 86400000);
          const card = document.createElement("div");
          card.className = "bd-card";
          card.innerHTML = `<div class="bd-name">${
            bd.name
          }</div><div class="bd-date">${shortMonth(bd.month)} ${
            bd.day
          }</div><div class="bd-countdown" id="bdcount-${i}">${
            diff >= 0 ? days + "d left" : days + "d ago"
          }</div>`;
          // non-clickable per request:
          card.style.pointerEvents = "none";
          grid.appendChild(card);
        });
      }

      /* show birthday popups for today's birthdays (centered white box, confetti) */
      async function showBirthdayPopupsIfToday() {
        const today = new Date();
        const matches = BIRTHDAYS.filter(
          (b) => b.month === today.getMonth() + 1 && b.day === today.getDate()
        );
        if (!matches.length) return;
        for (const bd of matches) {
          await showBirthdayPopup(bd);
          // small pause between multiple persons on same day
          await new Promise((r) => setTimeout(r, 250));
        }
      }
      function showBirthdayPopup(bd) {
        return new Promise((resolve) => {
          const wrap = $("bdPopupWrap");
          const box = $("bdPopup");
          box.innerHTML = `<div style="font-size:20px">${bd.name}</div><div class="small">Happy Birthday!</div>`;
          wrap.classList.add("show");
          startConfetti(140);
          startFireworksBurst();
          // shake effect
          box.animate(
            [
              { transform: "translateY(0)" },
              { transform: "translateY(-6px)" },
              { transform: "translateY(0)" },
            ],
            { duration: 600, iterations: 3 }
          );
          setTimeout(() => {
            stopConfetti();
            stopFireworks();
            wrap.classList.remove("show");
            resolve();
          }, 2600);
        });
      }

      /* ---------------- Confetti & Fireworks ---------------- */
      let confRAF = null,
        confActive = false;
      function startConfetti(count = 120) {
        const canvas = $("confettiCanvas");
        if (!canvas) return;
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        const ctx = canvas.getContext("2d");
        const parts = Array.from({ length: count }, () => ({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height * 0.6,
          w: 6 + Math.random() * 10,
          h: 6 + Math.random() * 10,
          vx: (Math.random() - 0.5) * 3,
          vy: 2 + Math.random() * 4,
          rot: Math.random() * 360,
          vr: Math.random() * 8,
          color: `hsl(${Math.random() * 60 + 30},90%,60%)`,
        }));
        confActive = true;
        function frame() {
          if (!confActive) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return;
          }
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (const p of parts) {
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rot * Math.PI) / 180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
            ctx.restore();
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.vr;
            if (p.y > canvas.height + 40) {
              p.y = -20;
              p.x = Math.random() * canvas.width;
            }
          }
          confRAF = requestAnimationFrame(frame);
        }
        frame();
      }
      function stopConfetti() {
        confActive = false;
        if (confRAF) cancelAnimationFrame(confRAF);
        const c = $("confettiCanvas");
        if (c) {
          const ctx = c.getContext("2d");
          ctx.clearRect(0, 0, c.width, c.height);
        }
      }

      let fireRAF = null,
        fireActive = false;
      function startFireworksBurst() {
        const canvas = $("fireCanvas");
        if (!canvas) return;
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        const ctx = canvas.getContext("2d");
        fireActive = true;
        const bursts = [];
        function spawn() {
          const cx = innerWidth * (0.2 + Math.random() * 0.6);
          const cy = innerHeight * (0.12 + Math.random() * 0.45);
          const color = ["#ffd24a", "#ffb84d", "#ff7b7b", "#9b59b6", "#66a3ff"][
            Math.floor(Math.random() * 5)
          ];
          const count = 20 + Math.floor(Math.random() * 30);
          const parts = [];
          for (let i = 0; i < count; i++) {
            const ang = Math.random() * Math.PI * 2,
              speed = 1.8 + Math.random() * 3.4;
            parts.push({
              x: cx,
              y: cy,
              vx: Math.cos(ang) * speed,
              vy: Math.sin(ang) * speed,
              life: Math.random() * 80 + 40,
              color,
              alpha: 1,
            });
          }
          bursts.push({ parts, ttl: 120 });
        }
        function frame() {
          if (!fireActive) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return;
          }
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (Math.random() < 0.08) spawn();
          bursts.forEach((b) => {
            b.parts.forEach((p) => {
              ctx.beginPath();
              ctx.fillStyle = p.color;
              ctx.globalAlpha = p.alpha;
              ctx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
              ctx.fill();
              p.x += p.vx;
              p.y += p.vy;
              p.vy += 0.03;
              p.life -= 1;
              p.alpha = Math.max(0, p.life / 120);
            });
            b.ttl -= 1;
          });
          for (let i = bursts.length - 1; i >= 0; i--)
            if (bursts[i].ttl <= 0) bursts.splice(i, 1);
          ctx.globalAlpha = 1;
          fireRAF = requestAnimationFrame(frame);
        }
        frame();
      }
      function stopFireworks() {
        fireActive = false;
        if (fireRAF) cancelAnimationFrame(fireRAF);
        const c = $("fireCanvas");
        if (c) {
          const ctx = c.getContext("2d");
          ctx.clearRect(0, 0, c.width, c.height);
        }
      }

      /* ---------------- Uploads + Drive import (best-effort) ---------------- */
      $("uploadBtn").addEventListener("click", async () => {
        const inp = $("uploadInput");
        if (!inp.files.length) return alert("Choose files to upload");
        for (const f of Array.from(inp.files)) await IDB.putUpload(f, f.name);
        inp.value = "";
        renderUploadsPreview();
        renderGallery();
      });
      $("clearUploads").addEventListener("click", async () => {
        if (confirm("Clear all uploaded images?")) {
          await IDB.clearUploads();
          renderUploadsPreview();
          renderGallery();
        }
      });
      async function renderUploadsPreview() {
        const cont = $("uploadsPreview");
        cont.innerHTML = "";
        const list = await IDB.getAllUploads();
        list.forEach((item) => {
          const d = document.createElement("div");
          d.style.position = "relative";
          d.innerHTML = `<img src="${URL.createObjectURL(
            item.blob
          )}" style="width:100%;height:80px;object-fit:cover;border-radius:8px">`;
          cont.appendChild(d);
        });
      }

      /* Drive helper - accept links or IDs, attempt fetch to public 'uc?export=view&id=ID' */
      $("importDriveBtn").addEventListener("click", async () => {
        const raw = $("gdriveInput").value.trim();
        if (!raw)
          return alert(
            "Paste Drive file links or IDs (comma separated), make files public."
          );
        const parts = raw
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        let imported = 0,
          failed = 0;
        for (const p of parts) {
          let id = null;
          let url = p;
          // extract id if link
          const m1 = p.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
          const m2 = p.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
          const m3 = p.match(/\/folders\/([a-zA-Z0-9_-]{10,})/);
          if (m1) id = m1[1];
          else if (m2) id = m2[1];
          else if (m3) id = m3[1];
          if (id) url = `https://drive.google.com/uc?export=view&id=${id}`;
          try {
            const resp = await fetch(url);
            if (!resp.ok) {
              failed++;
              continue;
            }
            const ct = resp.headers.get("content-type") || "";
            if (!ct.startsWith("image/")) {
              failed++;
              continue;
            }
            const blob = await resp.blob();
            await IDB.putUpload(blob, id || url);
            imported++;
          } catch (e) {
            failed++;
          }
        }
        alert(
          `Imported ${imported}, failed ${failed}. If many failed ensure files are public.`
        );
        $("gdriveInput").value = "";
        renderUploadsPreview();
        renderGallery();
      });

      /* ---------------- month buttons + progress ---------------- */
      function generateMonthButtons() {
        const container = $("monthButtons");
        container.innerHTML = "";
        const months = new Map();
        EVENTS.forEach((ev) => {
          const s = parseStart(ev.start),
            key = `${s.getFullYear()}-${pad(s.getMonth() + 1)}`;
          if (!months.has(key))
            months.set(key, {
              label: `${s.toLocaleString("en", {
                month: "short",
              })} ${s.getFullYear()}`,
              month: pad(s.getMonth() + 1),
            });
        });
        Array.from(months.entries())
          .sort()
          .forEach(([k, val]) => {
            const btn = document.createElement("button");
            btn.className = "month-btn";
            btn.textContent = val.label;
            btn.dataset.month = val.month;
            btn.addEventListener("click", () => {
              const mf = $("monthFilter");
              if (mf.value === val.month) {
                mf.value = "";
                btn.classList.remove("active");
              } else {
                mf.value = val.month;
                highlightMonthButton(val.month);
              }
              renderAll();
            });
            container.appendChild(btn);
          });
      }
      function highlightMonthButton(month) {
        document
          .querySelectorAll(".month-btn")
          .forEach((b) =>
            b.classList.toggle("active", b.dataset.month === month)
          );
      }
      function updateYearProgress() {
        if (!EVENTS.length) return;
        const start = parseStart(EVENTS[0].start);
        const last = EVENTS[EVENTS.length - 1];
        const end = parseEnd(last.end, parseStart(last.start));
        const now = new Date();
        const total = end.getTime() - start.getTime();
        const passed = Math.max(
          0,
          Math.min(total, now.getTime() - start.getTime())
        );
        const pct = Math.round((passed / total) * 100);
        $("yearProgressBar").style.width = pct + "%";
      }

      /* ---------------- modes, prefs, UI wiring ---------------- */
      let mode = "grid";
      function applyModeUI() {
        document
          .querySelectorAll(".mode-btn")
          .forEach((b) => b.classList.remove("active"));
        if (mode === "grid") {
          $("gridBtn").classList.add("active");
          $("stage").style.display = "";
          $("gallerySection").style.display = "none";
          $("birthdaySection").style.display = "none";
        } else if (mode === "museum") {
          $("museumBtn").classList.add("active");
          $("gallerySection").style.display = "";
          $("stage").style.display = "none";
          $("birthdaySection").style.display = "none";
          renderGallery();
        } else if (mode === "birthdays") {
          $("birthBtn").classList.add("active");
          $("birthdaySection").style.display = "";
          $("gallerySection").style.display = "none";
          $("stage").style.display = "none";
          renderBirthdays();
        } else if (mode === "present") {
          $("presentBtn").classList.add("active");
          $("stage").style.display = "";
          $("gallerySection").style.display = "none";
          $("birthdaySection").style.display = "none";
          try {
            document.documentElement.requestFullscreen?.();
          } catch (e) {}
        }
        localStorage.setItem(
          "maxwell_ui_prefs",
          JSON.stringify({ mode, theme: $("themeSelect").value })
        );
      }
      function loadPrefs() {
        try {
          const p = JSON.parse(
            localStorage.getItem("maxwell_ui_prefs") || "null"
          );
          if (p) {
            if (p.theme) document.body.setAttribute("data-theme", p.theme);
            if (p.mode) mode = p.mode;
          }
        } catch (e) {}
      }

      /* UI wiring */
      function wireUI() {
        $("heroMedia").src = HERO;
        $("gridBtn").addEventListener("click", () => {
          mode = "grid";
          applyModeUI();
        });
        $("museumBtn").addEventListener("click", () => {
          mode = "museum";
          applyModeUI();
        });
        $("birthBtn").addEventListener("click", () => {
          mode = "birthdays";
          applyModeUI();
        });
        $("presentBtn").addEventListener("click", () => {
          mode = "present";
          applyModeUI();
        });
        $("savePrefs").addEventListener("click", () => {
          localStorage.setItem(
            "maxwell_ui_prefs",
            JSON.stringify({ mode, theme: $("themeSelect").value })
          );
          alert("Saved");
        });
        $("themeSelect").addEventListener("change", () =>
          document.body.setAttribute("data-theme", $("themeSelect").value)
        );
        $("searchBox").addEventListener("input", () => renderAll());
        $("monthFilter").addEventListener("change", () => {
          highlightMonthButton($("monthFilter").value);
          renderAll();
        });
        $("pinnedToggleBtn").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (p) p.classList.toggle("hidden");
        });
        $("pinCollapseBtn").addEventListener("click", () => {
          const p = $("pinnedColumn");
          if (p) p.classList.toggle("hidden");
        });
        $("clearPins").addEventListener("click", () => {
          if (confirm("Clear pinned events?")) setPinned([]);
        });
        $("exportPins").addEventListener("click", () => {
          const pins = getPinned();
          const rows = [["name", "start", "end"]];
          for (const i of pins)
            if (EVENTS[i])
              rows.push([
                EVENTS[i].name,
                EVENTS[i].start || "",
                EVENTS[i].end || "",
              ]);
          const csv = rows
            .map((r) =>
              r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
            )
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "pinned-events.csv";
          a.click();
          URL.revokeObjectURL(url);
        });
      }

      /* ---------------- bootstrapping ---------------- */
      async function init() {
        loadPrefs();
        wireUI();
        generateMonthButtons();
        await renderAll();
        renderGallery();
        renderBirthdays();
        renderUploadsPreview();
        // show birthday popups if today
        setTimeout(() => showBirthdayPopupsIfToday(), 700);
        // show pinned toggle if pins exist
        if (getPinned().length > 0) {
          $("pinnedToggleBtn").classList.remove("hidden");
          $("pinnedColumn").classList.remove("hidden");
        }
        // periodic pinned count updates
        setInterval(() => updatePinnedCounts(new Date()), 1000);
        // resize canvases for confetti/fireworks on window resize
        window.addEventListener("resize", () => {
          ["confettiCanvas", "fireCanvas"].forEach((id) => {
            const c = $(id);
            if (c) {
              c.width = innerWidth;
              c.height = innerHeight;
            }
          });
        });
      }
      document.addEventListener("DOMContentLoaded", init);

      /* ---------------- small utility for date formatting used earlier ---------------- */
      function formatISO(d) {
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}`;
      }
      function updateYearProgress() {
        if (EVENTS.length === 0) return;
        const start = parseStart(EVENTS[0].start);
        const last = EVENTS[EVENTS.length - 1];
        const end = parseEnd(last.end, parseStart(last.start));
        const now = new Date();
        const total = end.getTime() - start.getTime();
        const passed = Math.max(
          0,
          Math.min(total, now.getTime() - start.getTime())
        );
        const pct = Math.round((passed / total) * 100);
        $("yearProgressBar").style.width = pct + "%";
      }
      updateYearProgress();
    </script>
  </body>
</html>
